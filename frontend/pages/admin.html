<style>
    .admin-container {
        max-width: 1200px;
        margin: 0 auto;
    }

    .admin-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
    }

    .admin-tabs {
        display: flex;
        border-bottom: 2px solid var(--border-color, #e0e0e0);
        margin-bottom: 2rem;
    }

    .tab-btn {
        background: none;
        border: none;
        padding: 1rem 1.5rem;
        font-size: 1rem;
        font-weight: 600;
        color: var(--text-secondary, #6b7280);
        cursor: pointer;
        border-bottom: 3px solid transparent;
        transition: all 0.2s;
    }

    .tab-btn:hover {
        color: var(--primary-color, #007bff);
        background: var(--bg-tertiary, #f9fafb);
    }

    .tab-btn.active {
        color: var(--primary-color, #007bff);
        border-bottom-color: var(--primary-color, #007bff);
    }

    .tab-content {
        display: none;
    }

    .tab-content.active {
        display: block;
        animation: fadeIn 0.3s ease-out;
    }

    /* Table Styles */
    .data-table-wrapper {
        background: white;
        border: 1px solid var(--border-color, #e0e0e0);
        border-radius: var(--radius-lg, 12px);
        overflow-x: auto;
        box-shadow: var(--shadow-sm);
    }

    .data-table {
        width: 100%;
        border-collapse: collapse;
        min-width: 600px;
    }

    .data-table th,
    .data-table td {
        padding: 1rem;
        text-align: left;
        border-bottom: 1px solid var(--border-color, #e0e0e0);
    }

    .data-table th {
        background: var(--bg-tertiary, #f9fafb);
        font-weight: 600;
        color: var(--text-secondary, #4b5563);
    }

    .data-table tr:last-child td {
        border-bottom: none;
    }

    /* Badges */
    .role-badge {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        border-radius: 999px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
    }

    .role-admin {
        background: #fee2e2;
        color: #991b1b;
    }

    .role-organizer {
        background: #dbeafe;
        color: #1e40af;
    }

    .role-attendee {
        background: #f3f4f6;
        color: #374151;
    }

    /* Actions */
    .action-group {
        display: flex;
        gap: 0.5rem;
    }

    .btn-sm {
        padding: 0.4rem 0.8rem;
        font-size: 0.85rem;
        border-radius: 6px;
        cursor: pointer;
        border: 1px solid transparent;
    }

    .btn-primary-sm {
        background: var(--primary-color, #007bff);
        color: white;
    }

    .btn-danger-sm {
        background: #fee2e2;
        color: #ef4444;
        border-color: #fecaca;
    }

    .btn-danger-sm:hover {
        background: #fecaca;
    }

    /* Form Card */
    .create-card {
        background: var(--bg-tertiary, #f9fafb);
        padding: 1.5rem;
        border-radius: var(--radius-lg, 12px);
        margin-bottom: 2rem;
        border: 1px solid var(--border-color, #e0e0e0);
    }

    .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        align-items: end;
    }
</style>

<div class="admin-container page-transition-enter-active">
    <div class="admin-header">
        <div>
            <h2>Admin Console</h2>
            <p style="color: var(--text-secondary);">Manage users, roles, and campus infrastructure.</p>
        </div>
    </div>

    <div id="adminMessage" style="display: none; margin-bottom: 1rem; padding: 1rem; border-radius: 8px;"></div>

    <div class="admin-tabs">
        <button class="tab-btn active" onclick="switchTab('users')">User Management</button>
        <button class="tab-btn" onclick="switchTab('venues')">Venue Management</button>
    </div>

    <!-- USERS TAB -->
    <div id="tab-users" class="tab-content active">
        <div class="data-table-wrapper">
            <table class="data-table" id="usersTable">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Department</th>
                        <th>Role</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td colspan="5" style="text-align: center;">Loading users...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- VENUES TAB -->
    <div id="tab-venues" class="tab-content">

        <!-- Add Venue Form -->
        <div class="create-card">
            <h4 style="margin-top:0; margin-bottom:1rem;">Add New Venue</h4>
            <form id="addVenueForm" class="form-grid">
                <div>
                    <label style="display:block; margin-bottom:0.5rem; font-size:0.875rem;">Venue Name*</label>
                    <input type="text" id="vName" placeholder="e.g. Chapel Auditorium" required
                        style="width:100%; padding:0.5rem;">
                </div>
                <div>
                    <label style="display:block; margin-bottom:0.5rem; font-size:0.875rem;">Building*</label>
                    <input type="text" id="vBuilding" placeholder="e.g. Center for Arts" required
                        style="width:100%; padding:0.5rem;">
                </div>
                <div>
                    <label style="display:block; margin-bottom:0.5rem; font-size:0.875rem;">Room (Optional)</label>
                    <input type="text" id="vRoom" placeholder="e.g. 101" style="width:100%; padding:0.5rem;">
                </div>
                <div>
                    <label style="display:block; margin-bottom:0.5rem; font-size:0.875rem;">Google Maps Link</label>
                    <input type="url" id="vMapLink" placeholder="https://maps.app.goo.gl/..."
                        style="width:100%; padding:0.5rem;">
                </div>
                <div>
                    <button type="submit" class="action-btn primary" style="width:100%;">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="12" y1="8" x2="12" y2="16"></line>
                            <line x1="8" y1="12" x2="16" y2="12"></line>
                        </svg>
                        Submit
                    </button>
                </div>
            </form>
        </div>

        <div class="data-table-wrapper">
            <table class="data-table" id="venuesTable">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Building</th>
                        <th>Room</th>
                        <th>Map Link</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td colspan="5" style="text-align: center;">Loading venues...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script type="module">
    import { api } from '../js/api.js';
    import { getRoleFromToken } from '../js/app.js';

    const token = localStorage.getItem('token');
    const msgDiv = document.getElementById('adminMessage');

    // --- INIT ---
    async function init() {
        const role = getRoleFromToken();
        if (role !== 'admin') {
            document.querySelector('.admin-container').innerHTML = `
                <div style="text-align:center; padding: 4rem;">
                    <h3>Access Denied</h3>
                    <p>You do not have permission to view this page.</p>
                    <a href="#/dashboard" class="action-btn primary" style="margin-top:1rem; display:inline-block;">Return to Dashboard</a>
                </div>
            `;
            return;
        }

        loadUsers();
        loadVenues();
    }

    // --- TABS ---
    window.switchTab = (tabName) => {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));

        document.getElementById(`tab-${tabName}`).classList.add('active');
        const btns = document.querySelectorAll('.tab-btn');
        if (tabName === 'users') btns[0].classList.add('active');
        if (tabName === 'venues') btns[1].classList.add('active');
    };

    // --- USERS LOGIC ---
    async function loadUsers() {
        try {
            const users = await api('/auth/users', 'GET', null, token);
            const tbody = document.querySelector('#usersTable tbody');

            if (users.error) throw new Error(users.error);

            tbody.innerHTML = users.map(u => `
                <tr>
                    <td>
                        <div style="font-weight:600;">${u.first_name || ''} ${u.last_name || ''}</div>
                        <div style="font-size:0.8rem; color:var(--text-light);">Since ${new Date(u.created_at).toLocaleDateString()}</div>
                    </td>
                    <td>${u.email}</td>
                    <td>${u.major_department || '-'}</td>
                    <td><span class="role-badge role-${u.role}">${u.role}</span></td>
                    <td>
                        <div class="action-group">
                            <select onchange="changeRole(${u.user_id}, this.value)" style="padding:0.25rem; border-radius:4px; border:1px solid #ccc;">
                                <option value="" disabled selected>Change Role</option>
                                <option value="attendee">Attendee</option>
                                <option value="organizer">Organizer</option>
                                <option value="admin">Admin</option>
                            </select>
                        </div>
                    </td>
                </tr>
            `).join('');

        } catch (e) {
            console.error(e);
            showMessage('Failed to load users', 'error');
        }
    }

    window.changeRole = async (userId, newRole) => {
        if (!confirm(`Are you sure you want to promote/demote this user to ${newRole}?`)) return;

        try {
            const res = await api('/auth/set-role', 'POST', { user_id: userId, role: newRole }, token);
            if (res.error) throw new Error(res.error);
            showMessage(`User role updated to ${newRole}`, 'success');
            loadUsers(); // Refresh
        } catch (e) {
            showMessage(e.message || 'Failed to update role', 'error');
        }
    };

    // --- VENUES LOGIC ---
    async function loadVenues() {
        try {
            const venues = await api('/venues/', 'GET', null, token);
            const tbody = document.querySelector('#venuesTable tbody');

            if (venues.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:2rem;">No venues found. Add one above.</td></tr>';
                return;
            }

            tbody.innerHTML = venues.map(v => `
                <tr>
                    <td style="font-weight:600;">${v.name}</td>
                    <td>${v.building}</td>
                    <td>${v.room_number || '-'}</td>
                    <td>
                        ${v.google_maps_link
                    ? `<a href="${v.google_maps_link}" target="_blank" style="color:var(--primary-color);">View Map</a>`
                    : '<span>-</span>'}
                    </td>
                    <td>
                        <button onclick="deleteVenue(${v.venue_id})" class="btn-sm btn-danger-sm">Delete</button>
                    </td>
                </tr>
            `).join('');

        } catch (e) {
            console.error(e);
            showMessage('Failed to load venues', 'error');
        }
    }

    document.getElementById('addVenueForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const payload = {
            name: document.getElementById('vName').value,
            building: document.getElementById('vBuilding').value,
            room_number: document.getElementById('vRoom').value,
            google_maps_link: document.getElementById('vMapLink').value
        };

        try {
            const res = await api('/venues/', 'POST', payload, token);
            if (res.error) throw new Error(res.error);

            showMessage('Venue created successfully', 'success');
            document.getElementById('addVenueForm').reset();
            loadVenues();
        } catch (e) {
            showMessage(e.message || 'Failed to create venue', 'error');
        }
    });

    window.deleteVenue = async (id) => {
        if (!confirm('Delete this venue? This might affect past events linked to it.')) return;
        try {
            const res = await api(`/venues/${id}`, 'DELETE', null, token);
            if (res.error) throw new Error(res.error);
            showMessage('Venue deleted', 'success');
            loadVenues();
        } catch (e) {
            showMessage(e.message || 'Failed to delete venue', 'error');
        }
    }

    // --- HELPERS ---
    function showMessage(text, type) {
        msgDiv.textContent = text;
        msgDiv.style.display = 'block';
        msgDiv.style.background = type === 'error' ? '#fee2e2' : '#d1fae5';
        msgDiv.style.color = type === 'error' ? '#991b1b' : '#065f46';
        setTimeout(() => { msgDiv.style.display = 'none'; }, 3000);
    }

    init();
</script>