<style>
    /*
    ====================================================================
    LAYOUT OVERRIDE
    ====================================================================
    */
    :host .ai-chat-container, /* Safety for different load methods */
    .ai-chat-container {
        display: flex !important;
        flex-direction: column !important;
        height: calc(100vh - 4rem);
        min-height: 0 !important;
        padding: 0 !important;
        background: none !important;
        box-shadow: none !important;
        flex-shrink: 0;
    }

    .aichat-wrapper {
        display: flex;
        flex-direction: column;
        height: 100%;
        width: 100%;
        background: var(--bg-primary);
        box-shadow: var(--shadow-sm);
        border-radius: var(--radius-lg);
        padding: 1.5rem;
        overflow: hidden; 
    }

    .aichat-header {
        text-align: left;
        border-bottom: 1px solid var(--border-color);
        padding-bottom: 1rem;
        margin-bottom: 1rem;
        flex-shrink: 0;
    }

    .aichat-header h2 {
        font-size: 1.5rem;
        margin: 0;
        background: var(--gradient-primary);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        /* We need to set display for background-clip to work */
        display: inline-block; 
    }
    .aichat-header p {
        font-size: 0.9rem;
        color: var(--text-secondary);
        margin: 0.25rem 0 0 0;
    }

    /* ====================================================================
    CHAT WINDOW & MESSAGES
    ====================================================================
    */
    .chat-window {
        flex-grow: 1;
        overflow-y: auto;
        padding: 1rem 0.5rem;
        scroll-behavior: smooth;
    }
    
    .chat-message {
        display: flex;
        align-items: flex-end; /* align avatar and bubble to the bottom */
        margin-bottom: 1.25rem;
        max-width: 90%;
        animation: fadeIn 0.3s ease-out;
    }
    
    .chat-avatar {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        margin-right: 0.75rem;
    }
    
    .chat-message.ai .chat-avatar {
        background: var(--gradient-primary);
        color: white;
    }
    
    .chat-message.user {
        flex-direction: row-reverse;
        margin-left: auto; /* Push to the right */
    }
    
    .chat-message.user .chat-avatar {
        margin-right: 0;
        margin-left: 0.75rem;
        background: var(--bg-tertiary);
        color: var(--text-primary);
    }

    .message-bubble {
        padding: 0.75rem 1.25rem;
        border-radius: var(--radius-lg);
        line-height: 1.5;
    }

    .chat-message.user .message-bubble {
        background: var(--gradient-primary);
        color: white;
        border-bottom-right-radius: var(--radius-sm);
    }

    .chat-message.ai .message-bubble {
        background: var(--bg-tertiary);
        color: var(--text-primary);
        border-bottom-left-radius: var(--radius-sm);
    }
    
    /* --- Use .is-loading to avoid conflict --- */
    .chat-message.is-loading .message-bubble {
        background: var(--bg-tertiary);
        color: var(--text-light);
    }

    /* Simple loading dots animation */
    .loading-dots span {
        animation: blink 1.4s infinite both;
    }
    .loading-dots span:nth-child(1) { animation-delay: 0s; }
    .loading-dots span:nth-child(2) { animation-delay: 0.2s; }
    .loading-dots span:nth-child(3) { animation-delay: 0.4s; }

    @keyframes blink {
        0% { opacity: 0.2; }
        20% { opacity: 1; }
        100% { opacity: 0.2; }
    }
    
    /* ====================================================================
    MARKDOWN & ERROR STYLES
    ====================================================================
    */
    .chat-message.ai .message-bubble p {
        margin-top: 0.5rem;
        margin-bottom: 0.5rem;
    }
    .chat-message.ai .message-bubble p:first-child { margin-top: 0; }
    .chat-message.ai .message-bubble p:last-child { margin-bottom: 0; }
    
    .chat-message.ai .message-bubble h2,
    .chat-message.ai .message-bubble h3 {
        margin-top: 1rem; margin-bottom: 0.5rem; font-weight: 600;
    }
    .chat-message.ai .message-bubble h2 { font-size: 1.2em; }
    .chat-message.ai .message-bubble h3 { font-size: 1.1em; }
    
    .chat-message.ai .message-bubble hr {
        margin: 1rem 0; border: 0; border-top: 1px solid var(--border-color);
    }
    
    .chat-message.ai .message-bubble ul,
    .chat-message.ai .message-bubble ol {
        padding-left: 1.5rem; margin: 0.75rem 0;
    }
    .chat-message.ai .message-bubble ul { list-style: disc; }
    .chat-message.ai .message-bubble ol { list-style: decimal; }
    .chat-message.ai .message-bubble li { margin-bottom: 0.25rem; }
    
    .chat-message.ai .message-bubble code:not(pre code) {
        background: var(--bg-primary);
        padding: 2px 5px;
        border-radius: var(--radius-sm);
        font-family: monospace;
        font-size: 0.9em;
        border: 1px solid var(--border-color);
    }
    
    .chat-message.ai .message-bubble pre {
        background: var(--text-primary);
        color: var(--bg-tertiary);
        padding: 1rem;
        border-radius: var(--radius-md);
        overflow-x: auto;
    }
    .chat-message.ai .message-bubble pre code {
        background: none; padding: 0; border: none;
    }

    .chat-error {
        text-align: center;
        padding: 0.75rem;
        background: #fff5f5;
        color: #c53030;
        border: 1px solid #f56565;
        border-radius: var(--radius-md);
        margin: 0 0.5rem 1rem 0.5rem;
        flex-shrink: 0; /* Don't shrink */
        display: none; /* Hidden by default */
    }

    /*
    ====================================================================
    CHAT FORM & INPUT
    ====================================================================
    */
    .chat-form {
        flex-shrink: 0; /* CRITICAL: Prevents form from shrinking */
        margin-top: 0.5rem;
    }
    
    .input-wrapper {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        background: var(--bg-tertiary);
        border: 1px solid var(--border-color);
        border-radius: var(--radius-lg);
        padding: 0.5rem 0.75rem 0.5rem 1.25rem;
        transition: var(--transition);
    }
    .input-wrapper:focus-within {
        border-color: var(--primary-color);
    }

    .chat-form input {
        flex-grow: 1;
        border: none;
        background: transparent;
        font-size: 1rem;
        font-family: inherit;
        padding: 0.5rem 0;
        color: var(--text-primary);
    }
    .chat-form input:focus {
        outline: none;
    }

    .chat-form button {
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        
        width: 44px;
        height: 44px;
        background: var(--gradient-primary);
        color: white;
        border: none;
        border-radius: var(--radius-md);
        font-weight: 600;
        cursor: pointer;
        transition: var(--transition);
    }
    
    .chat-form button span {
        display: none;
    }

    .chat-form button:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
    }
    
    .chat-form button:disabled {
        background: var(--text-light);
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }
    
    /* ====================================================================
    MOBILE RESPONSIVENESS
    ====================================================================
    */
    @media (max-width: 768px) {
        .ai-chat-container {
            height: calc(100vh - var(--header-height) - 2rem);
        }
        
        .aichat-wrapper {
            padding: 1rem;
        }

        .chat-message {
            max-width: 95%;
        }
        
        .chat-avatar {
            width: 32px;
            height: 32px;
        }
        
        .input-wrapper {
            padding: 0.5rem;
        }
    }

</style>

<div class="ai-chat-container">
    <div class="aichat-wrapper">
        <div class="aichat-header">
            <h2>AI Assistant</h2>
            <p>Your partner in planning campus events.</p>
        </div>
        
        <div id="chat-error" class="chat-error"></div>

        <div class="chat-window" id="chat-window">
            
            <div class="chat-message ai">
                <div class="chat-avatar">
                    <svg width="27" height="27" viewBox="0 0 24 24" fill="currentColor"
                        xmlns="http://www.w3.org/2000/svg"
                        style="display:block; margin:auto;">
                    <path d="M12 2L10 9L3 11L10 13L12 20L14 13L21 11L14 9L12 2Z"/>
                    </svg>
                </div>
                <div class="message-bubble">
                    <p>Hello! I'm EventEcho, your AI assistant. How can I help you with your event planning today?</p>
                </div>
            </div>

        </div>

        <form class="chat-form" id="chat-form">
            <div class="input-wrapper">
                <input type="text" id="chat-input" placeholder="Ask about event planning..." autocomplete="off">
                <button type="submit" id="send-button" aria-label="Send message">
                    <span>Send</span>
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"
                        xmlns="http://www.w3.org/2000/svg"
                        style="display:block; margin:auto;">
                    <path d="M2 3L22 12L2 21L5 13L15 12L5 11L2 3Z"/>
                    </svg>
                </button>
            </div>
        </form>
    </div>
</div>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/github-dark.min.css">
<script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/common.min.js"></script>

<script type="module">
    import { api } from '../js/api.js';
    import { token } from '../js/app.js';

    import { marked } from "https://cdn.jsdelivr.net/npm/marked/lib/marked.esm.js";
    import DOMPurify from "https://cdn.jsdelivr.net/npm/dompurify@3.1.6/+esm";

    marked.setOptions({
        gfm: true,
        breaks: true,
        headerIds: false,
        mangle: false
    });

    function markdownToHtml(markdown) {
        const dirty = marked.parse(markdown || "");
        return DOMPurify.sanitize(dirty);
    }

    const chatForm = document.getElementById('chat-form');
    const chatInput = document.getElementById('chat-input');
    const sendButton = document.getElementById('send-button');
    const chatWindow = document.getElementById('chat-window');
    const chatError = document.getElementById('chat-error');

    function addMessage(sender, message) {
        const messageDiv = document.createElement('div');
        messageDiv.classList.add('chat-message', sender);

        const avatar = document.createElement('div');
        avatar.classList.add('chat-avatar');
        if (sender === 'ai') {
            avatar.innerHTML = `<svg width="27" height="27" viewBox="0 0 24 24" fill="currentColor"
                                    xmlns="http://www.w3.org/2000/svg"
                                    style="display:block; margin:auto;">
                                <path d="M12 2L10 9L3 11L10 13L12 20L14 13L21 11L14 9L12 2Z"/>
                                </svg>`;
        } else {
            avatar.innerHTML = `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>`;
        }
        messageDiv.appendChild(avatar);

        const bubble = document.createElement('div');
        bubble.classList.add('message-bubble');

        if (sender === 'ai') {
            bubble.innerHTML = markdownToHtml(message);
            if (window.hljs) {
                bubble.querySelectorAll('pre code').forEach(block => {
                    window.hljs.highlightElement(block);
                });
            }
        } else {
            bubble.textContent = message;
        }

        messageDiv.appendChild(bubble);
        chatWindow.appendChild(messageDiv);
        chatWindow.scrollTop = chatWindow.scrollHeight;

        return messageDiv;
    }

    function showLoading() {
        const loadingMessage = addMessage('ai', '');
        loadingMessage.classList.add('is-loading'); 
        loadingMessage.querySelector('.message-bubble').innerHTML = `
            <span class="loading-dots">
                <span>.</span><span>.</span><span>.</span>
            </span>
        `;
        return loadingMessage;
    }

    function showError(message) {
        chatError.textContent = message;
        chatError.style.display = 'block';
    }
    function clearError() {
        chatError.style.display = 'none';
    }

    chatForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const prompt = chatInput.value.trim();
        if (!prompt) return;

        chatInput.value = '';
        chatInput.disabled = true;
        sendButton.disabled = true;
        clearError();

        addMessage('user', prompt);
        const loadingElement = showLoading();

        try {
            const userTime = new Date().toISOString();
            const result = await api('/ai/chat', 'POST', { 
                prompt, 
                user_time: userTime 
            }, token);

            loadingElement.remove();

            if (result && result.response) {
                addMessage('ai', result.response);
            } else {
                const errorMsg = result.error || 'The AI assistant returned an empty response.';
                addMessage('ai', `Sorry, I couldn't process that. ${errorMsg}`);
                showError(errorMsg);
            }

        } catch (err) {
            console.error("Chat API error:", err);
            loadingElement.remove();
            const errorMsg = 'The AI assistant is currently unavailable. Please try again later.';
            addMessage('ai', `Sorry, I ran into a connection issue.`);
            showError(errorMsg);
        } finally {
            chatInput.disabled = false;
            sendButton.disabled = false;
            chatInput.focus();
        }
    });
</script>