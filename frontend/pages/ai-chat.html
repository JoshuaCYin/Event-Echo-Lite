<style>
    :host .ai-chat-container,
    .ai-chat-container {
        display: flex !important;
        flex-direction: column !important;
        height: calc(100vh - 4rem);
        min-height: 0 !important;
        padding: 0 !important;
        background: none !important;
        box-shadow: none !important;
        flex-shrink: 0;
    }
    .aichat-wrapper {
        display: flex;
        flex-direction: column;
        height: 100%;
        width: 100%;
        background: var(--bg-primary);
        box-shadow: var(--shadow-sm);
        border-radius: var(--radius-lg);
        padding: 1.5rem;
        overflow: hidden;
    }
    .aichat-header {
        text-align: left;
        border-bottom:
        1px solid var(--border-color);
        padding-bottom: 1rem;
        margin-bottom: 1rem;
        flex-shrink: 0;
    }
    .aichat-header h2 {
        font-size: 1.5rem;
        margin: 0;
        background: var(--gradient-primary);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        display: inline-block; 
    }
    .aichat-header p {
        font-size: 0.9rem;
        color: var(--text-secondary);
        margin: 0.25rem 0 0 0; }

    .chat-window {
        flex-grow: 1;
        overflow-y: auto;
        padding: 1rem 0.5rem;
        scroll-behavior: smooth;
    }
    .chat-message {
        display: flex;
        align-items: flex-end;
        margin-bottom: 1.25rem;
        max-width: 90%;
        animation: fadeIn 0.3s ease-out;
    }
    .chat-avatar {
        width: 36px; height: 36px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        margin-right: 0.75rem;
    }
    .chat-message.ai .chat-avatar {
        background: var(--gradient-primary);
        color: white; }
    .chat-message.user {
        flex-direction: row-reverse;
        margin-left: auto; }
    .chat-message.user .chat-avatar {
        margin-right: 0;
        margin-left: 0.75rem;
        background: var(--bg-tertiary);
        color: var(--text-primary);
    }
    .message-bubble {
        padding: 0.75rem 1.25rem;
        border-radius: var(--radius-lg);
        line-height: 1.5; }
    .chat-message.user .message-bubble {
        background: var(--gradient-primary);
        color: white;
        border-bottom-right-radius: var(--radius-sm);
    }
    .chat-message.ai .message-bubble {
        background: var(--bg-tertiary);
        color: var(--text-primary);
        border-bottom-left-radius: var(--radius-sm);
    }
    .chat-message.is-loading .message-bubble {
        background: var(--bg-tertiary);
        color: var(--text-light); }

    .loading-dots span { animation: blink 1.4s infinite both; }
    .loading-dots span:nth-child(1) { animation-delay: 0s; }
    .loading-dots span:nth-child(2) { animation-delay: 0.2s; }
    .loading-dots span:nth-child(3) { animation-delay: 0.4s; }
    @keyframes blink {
        0% { opacity: 0.2; }
        20% { opacity: 1; }
        100% { opacity: 0.2; }
    }

    /* --- SMART START & DRAFT BUTTON --- */
    .smart-start-container { 
        padding: 0.75rem 0.5rem; 
        flex-shrink: 0;
    }
    .smart-start-grid { 
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        justify-content: center;
    }

    /* --- FIX: Compact pill-style buttons --- */
    .smart-start-btn {
        padding: 0.5rem 1rem;
        font-size: 0.875rem; 
        font-weight: 500;
        color: var(--text-primary); 
        background: var(--bg-tertiary);
        border: 1px solid var(--border-color); 
        border-radius: 20px; /* More rounded */
        text-align: center; 
        transition: var(--transition); 
        cursor: pointer;
        line-height: 1.4;
        white-space: nowrap; /* Prevent wrapping */
        flex-shrink: 0; /* Prevent shrinking */
    }
    .smart-start-btn:hover { 
        background: var(--bg-primary); 
        border-color: var(--primary-color);
        box-shadow: var(--shadow-sm);
    }
    .smart-start-btn strong { 
        color: var(--primary-color); 
        display: block; 
        font-size: 0.9rem; 
    }

    .ai-draft-button {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.6rem 1rem;
        background: var(--gradient-primary);
        color: white;
        border-radius: var(--radius-md);
        font-weight: 600;
        margin-top: 1rem;
        cursor: pointer;
        transition: var(--transition);
        border: none;
    }
    .ai-draft-button:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
    }
    .ai-draft-button.draft-used {
        background: var(--bg-tertiary);
        color: var(--text-light);
        cursor: not-allowed; 
        box-shadow: none;
        transform: none;
    }

    /* Markdown & Error Styles */
    .chat-message.ai .message-bubble p {
        margin: 0.5rem 0;
    }
    .chat-message.ai .message-bubble p:first-child {
        margin-top: 0;
    }
    .chat-message.ai .message-bubble p:last-child {
        margin-bottom: 0;
    }
    .chat-message.ai .message-bubble h2, .chat-message.ai .message-bubble h3 {
        margin-top: 1rem; margin-bottom: 0.5rem; font-weight: 600;
    }
    .chat-message.ai .message-bubble hr {
        margin: 1rem 0; border: 0; border-top: 1px solid var(--border-color);
    }
    .chat-message.ai .message-bubble ul, .chat-message.ai .message-bubble ol {
        padding-left: 1.5rem; margin: 0.75rem 0;
    }
    .chat-message.ai .message-bubble code:not(pre code) {
        background: var(--bg-primary);
        padding: 2px 5px;
        border-radius: var(--radius-sm);
        border: 1px solid var(--border-color);
    }
    .chat-message.ai .message-bubble pre {
        background: var(--text-primary);
        color: var(--bg-tertiary);
        padding: 1rem;
        border-radius: var(--radius-md);
        overflow-x: auto;
    }
    
    .chat-error {
        text-align: center;
        padding: 0.75rem;
        background: #fff5f5;
        border: 1px solid #f56565;
        border-radius: var(--radius-md);
        margin: 0 0.5rem 1rem 0.5rem;
        flex-shrink: 0;
        /* display: none; <-- This is handled by inline style */
    }

    /* Chat Form & Input */
    .chat-form {
        flex-shrink: 0;
        margin-top: 1rem;
    } /* Added margin-top */
    .input-wrapper {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        background: var(--bg-tertiary);
        border: 1px solid var(--border-color);
        border-radius: var(--radius-lg);
        padding: 0.5rem 0.75rem 0.5rem 1.25rem;
        transition: var(--transition);
    }
    .input-wrapper:focus-within {
        border-color: var(--primary-color);
    }
    .chat-form input {
        flex-grow: 1;
        border: none;
        background: transparent;
        font-size: 1rem;
        font-family: inherit;
        padding: 0.5rem 0;
        color: var(--text-primary);
    }
    .chat-form input:focus {
        outline: none;
    }
    .chat-form button {
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        width: 44px;
        height: 44px;
        background: var(--gradient-primary);
        color: white;
        border: none;
        border-radius: var(--radius-md);
        font-weight: 600;
        cursor: pointer;
        transition: var(--transition);
    }
    .chat-form button span {
        display: none;
    }
    .chat-form button:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
    }
    .chat-form button:disabled {
        background: var(--text-light);
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }
    
    @media (max-width: 768px) {
        .ai-chat-container {
            height: calc(100vh - var(--header-height) - 2rem);
        }
        .aichat-wrapper {
            padding: 1rem;
        }
        .chat-message {
            max-width: 95%;
        }
        .chat-avatar {
            width: 32px; height: 32px;
        }
        .input-wrapper {
            padding: 0.5rem;
        }
        .smart-start-grid {
            grid-template-columns: 1fr;
        }
    }
</style>

<div class="ai-chat-container">
    <div class="aichat-wrapper">
        <div class="aichat-header">
            <h2>AI Assistant</h2>
            <p>Your partner in planning campus events.</p>
        </div>
        
        <!-- FIX: Added style="display: none;" to hide on load -->
        <div id="chat-error" class="chat-error" style="display: none;"></div>

        <div class="chat-window" id="chat-window">
            
            <div class="chat-message ai">
                <div class="chat-avatar">
                    <svg width="27" height="27" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2L10 9L3 11L10 13L12 20L14 13L21 11L14 9L12 2Z"/></svg>
                </div>
                <div class="message-bubble">
                    <p>Hello! I'm EventEcho, your AI assistant. How can I help?</p>
                </div>
            </div>

        </div>

        <div class="smart-start-container" id="smart-start-container">
            <div class="smart-start-grid">
                <!-- UPDATED: Prompt is more specific per your request -->
                <button class="smart-start-btn" data-prompt="What public events are happening soon?">
                    Check upcoming events
                </button>
                <button class="smart-start-btn" data-prompt="Suggest 3 themes for a spring fundraiser.">
                    Brainstorm event themes
                </button>
                <button class="smart-start-btn" data-prompt="Help me draft a new event.">
                    Draft an event
                </button>
                <button class="smart-start-btn" data-prompt="What's the difference between a 'public' and 'private' event?">
                    Ask about event types
                </button>
            </div>
        </div>

        <form class="chat-form" id="chat-form">
            <div class="input-wrapper">
                <input type="text" id="chat-input" placeholder="Ask about event planning..." autocomplete="off">
                <button type="submit" id="send-button" aria-label="Send message">
                    <span>Send</span>
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M2 3L22 12L2 21L5 13L15 12L5 11L2 3Z"/></svg>
                </button>
            </div>
        </form>
    </div>
</div>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/github-dark.min.css">
<script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/common.min.js"></script>

<script type="module" defer>
    import { api } from '../js/api.js';
    import { token } from '../js/app.js';
    import { marked } from "https://cdn.jsdelivr.net/npm/marked/lib/marked.esm.js";
    import DOMPurify from "https://cdn.jsdelivr.net/npm/dompurify@3.1.6/+esm";

    marked.setOptions({ gfm: true, breaks: true, headerIds: false, mangle: false });
    function markdownToHtml(markdown) {
        const dirty = marked.parse(markdown || "");
        return DOMPurify.sanitize(dirty);
    }

    const chatForm = document.getElementById('chat-form');
    const chatInput = document.getElementById('chat-input');
    const sendButton = document.getElementById('send-button');
    const chatWindow = document.getElementById('chat-window');
    const chatError = document.getElementById('chat-error');
    const smartStartContainer = document.getElementById('smart-start-container');

    const MAX_HISTORY = 10;
    let chatHistory = [];

    function addMessage(sender, message, eventDraft = null) {
        const messageDiv = document.createElement('div');
        messageDiv.classList.add('chat-message', sender);

        const avatar = document.createElement('div');
        avatar.classList.add('chat-avatar');
        if (sender === 'ai') {
            avatar.innerHTML = `<svg width="27" height="27" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2L10 9L3 11L10 13L12 20L14 13L21 11L14 9L12 2Z"/></svg>`;
        } else {
            avatar.innerHTML = `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>`;
        }
        messageDiv.appendChild(avatar);

        const bubble = document.createElement('div');
        bubble.classList.add('message-bubble');

        if (sender === 'ai') {
            bubble.innerHTML = markdownToHtml(message);
            if (window.hljs) {
                bubble.querySelectorAll('pre code').forEach(block => window.hljs.highlightElement(block));
            }

            // --- This is the Draft Button logic ---
            if (eventDraft && eventDraft.title) {
                const draftButton = document.createElement('button');
                draftButton.className = 'ai-draft-button';
                draftButton.innerHTML = `
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="12" y1="18" x2="12" y2="12"></line><line x1="9" y1="15" x2="15" y2="15"></line></svg>
                    Use Draft in Event Form
                `;
                
                draftButton.onclick = () => {
                    localStorage.setItem('aiEventDraft', JSON.stringify(eventDraft));
                    window.location.hash = '#/event-form'; // Navigate
                    draftButton.textContent = 'Draft Used!';
                    draftButton.classList.add('draft-used');
                    draftButton.disabled = true;
                };
                bubble.appendChild(draftButton);
            }
            // ---------------------------------------

        } else {
            bubble.textContent = message;
        }

        messageDiv.appendChild(bubble);
        chatWindow.appendChild(messageDiv);
        chatWindow.scrollTop = chatWindow.scrollHeight;
        return messageDiv;
    }

    function showLoading() {
        const loadingMessage = addMessage('ai', '');
        loadingMessage.classList.add('is-loading'); 
        loadingMessage.querySelector('.message-bubble').innerHTML = `<span class="loading-dots"><span>.</span><span>.</span><span>.</span></span>`;
        return loadingMessage;
    }

    function showError(message) {
        chatError.textContent = message;
        chatError.style.display = 'block';
    }
    function clearError() {
        chatError.style.display = 'none';
    }

    smartStartContainer.addEventListener('click', (e) => {
        const button = e.target.closest('.smart-start-btn');
        if (button) {
            const prompt = button.dataset.prompt;
            chatInput.value = prompt;
            chatForm.dispatchEvent(new Event('submit'));
        }
    });
    
    function hideSmartStart() {
        if (smartStartContainer) smartStartContainer.style.display = 'none';
    }

    // --- UPDATED: This function now strictly filters for upcoming events ---
    async function getEventContext() {
        try {
            // This API call fetches all events (public, and private-own)
            const events = await api("/events/", "GET", null, token);
            
            if (!events || !Array.isArray(events) || events.length === 0 || (events.error && events.length === 1)) {
                return "No upcoming public or private events found.";
            }
            
            // --- CRITICAL FIX: Filter to include ONLY FUTURE events ---
            const now = new Date();
            const upcomingEvents = events.filter(e => {
                try {
                    return new Date(e.start_time) >= now;
                } catch(err) { return false; }
            });

            if (upcomingEvents.length === 0) {
                return "No upcoming events found.";
            }

            // SORT ASCENDING (Soonest -> Furthest)
            upcomingEvents.sort((a, b) => new Date(a.start_time) - new Date(b.start_time));

            let contextString = "Here are the top upcoming events (public and private):\n";
            // Take only top 10
            upcomingEvents.slice(0, 10).forEach((event, index) => {
                const title = event.title;
                const start = new Date(event.start_time).toLocaleString('en-US', { dateStyle: 'short', timeStyle: 'short' });
                const end = new Date(event.end_time).toLocaleString('en-US', { dateStyle: 'short', timeStyle: 'short' });
                const location = event.location_type === 'venue' ? (event.venue_name || 'On-campus') : (event.custom_location_address || 'Custom Location');
                const visibility = event.visibility || 'private';
                
                contextString += `${index + 1}. [${visibility}] "${title}" from ${start} to ${end} at ${location}.\n`;
            });
            return contextString;
        } catch (err) {
            console.error("Failed to fetch event context:", err);
            return "Could not fetch event data due to a network error.";
        }
    }

    chatForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const prompt = chatInput.value.trim();
        if (!prompt) return;

        hideSmartStart(); // Hide buttons after first message
        chatInput.value = '';
        chatInput.disabled = true;
        sendButton.disabled = true;
        clearError();

        addMessage('user', prompt);
        chatHistory.push({ role: "user", content: prompt });
        const loadingElement = showLoading();

        try {
            // --- UPDATED: Get context *before* sending ---
            const eventContext = await getEventContext();
            // Get accurate user-local time
            const userTime = {
                iso: new Date().toISOString(),
                offset: new Date().getTimezoneOffset(),      // minutes difference from UTC
                local: new Date().toLocaleString('en-US', {
                    hour12: false,
                    timeZoneName: 'short'
                })
            };

            const payload = { 
                prompt, 
                user_time: userTime,
                history: chatHistory.slice(-MAX_HISTORY),
                event_context: eventContext
            };
            
            const result = await api('/ai/chat', 'POST', payload, token);

            loadingElement.remove();

            if (result && result.response) {
                addMessage('ai', result.response, result.eventDraft);
                chatHistory.push({ role: "ai", content: result.response });
            } else {
                const errorMsg = result.error || 'The AI assistant returned an empty response.';
                addMessage('ai', `Sorry, I couldn't process that. ${errorMsg}`);
                chatHistory.push({ role: "ai", content: errorMsg });
                showError(errorMsg);
            }
        } catch (err) {
            console.error("Chat API error:", err);
            loadingElement.remove();
            const errorMsg = 'The AI assistant is currently unavailable. Please try again later.';
            addMessage('ai', `Sorry, I ran into a connection issue.`);
            showError(errorMsg);
        } finally {
            chatInput.disabled = false;
            sendButton.disabled = false;
            chatInput.focus();
        }
    });
</script>