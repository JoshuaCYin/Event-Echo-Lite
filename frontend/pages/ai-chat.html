<!-- 
This page uses the .ai-chat-container class from your main.css 
for base styling. The styles below are specific to the chat interface
and use your CSS variables for consistency.
-->
<style>
    /* We add specific chat styles here.
      They use the CSS variables defined in your main.css for consistency.
    */
    .aichat-header {
        text-align: center;
        border-bottom: 1px solid var(--border-color);
        padding-bottom: 1.5rem;
        margin-bottom: 2rem;
    }

    .aichat-header h2 {
        font-size: 1.75rem;
        background: var(--gradient-primary);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin-bottom: 0.5rem;
    }

    .aichat-header p {
        font-size: 1.1rem;
        color: var(--text-secondary);
        max-width: 600px;
        margin: 0 auto;
    }

    .aichat-wrapper {
        display: flex;
        flex-direction: column;
        height: 100%;
        /* Calculate height based on padding inside .ai-chat-container */
        max-height: calc(100vh - 120px); 
    }

    .chat-window {
        flex-grow: 1;
        overflow-y: auto;
        padding: 1rem;
        background: var(--bg-secondary);
        border-radius: var(--radius-md);
        margin-bottom: 1rem;
        border: 1px solid var(--border-color);
        scroll-behavior: smooth;
    }
    
    /* Ensure markdown content (like paragraphs and lists) is styled correctly */
    .chat-message.ai .message-bubble p {
        margin-top: 0.5rem;
        margin-bottom: 0.5rem;
    }
    .chat-message.ai .message-bubble p:first-child {
        margin-top: 0;
    }
    .chat-message.ai .message-bubble p:last-child {
        margin-bottom: 0;
    }
    
    /* Style for markdown-rendered elements */
    .chat-message.ai .message-bubble hr {
        margin: 1rem 0;
        border: 0;
        border-top: 1px solid var(--border-color);
    }
    
    .chat-message.ai .message-bubble ul,
    .chat-message.ai .message-bubble ol { /* Added ol */
        padding-left: 1.25rem;
        margin: 0.5rem 0;
    }

    .chat-message.ai .message-bubble ul {
        list-style: disc inside;
    }

    .chat-message.ai .message-bubble ol {
        list-style: decimal inside;
    }
    
    .chat-message.ai .message-bubble code {
        background: rgba(0, 0, 0, 0.1);
        padding: 2px 4px;
        border-radius: var(--radius-sm);
        font-family: monospace;
        font-size: 0.9em;
        color: var(--primary-color);
    }

    .chat-message {
        display: flex;
        margin-bottom: 1rem;
        max-width: 85%;
        animation: fadeIn 0.3s ease-out;
    }

    .message-bubble {
        padding: 0.75rem 1.25rem;
        border-radius: var(--radius-lg);
        line-height: 1.5;
    }

    .chat-message.user {
        margin-left: auto;
        flex-direction: row-reverse;
    }

    .chat-message.user .message-bubble {
        background: var(--gradient-primary);
        color: white;
        border-bottom-right-radius: var(--radius-sm);
    }

    .chat-message.ai {
        margin-right: auto;
    }

    .chat-message.ai .message-bubble {
        background: var(--bg-tertiary);
        color: var(--text-primary);
        border-bottom-left-radius: var(--radius-sm);
    }
    
    .chat-message.loading .message-bubble {
        background: var(--bg-tertiary);
        color: var(--text-light);
    }

    /* Simple loading dots animation */
    .loading-dots span {
        animation: blink 1.4s infinite both;
    }
    .loading-dots span:nth-child(1) { animation-delay: 0s; }
    .loading-dots span:nth-child(2) { animation-delay: 0.2s; }
    .loading-dots span:nth-child(3) { animation-delay: 0.4s; }

    @keyframes blink {
        0% { opacity: 0.2; }
        20% { opacity: 1; }
        100% { opacity: 0.2; }
    }


    .chat-form {
        display: flex;
        gap: 0.75rem;
        flex-shrink: 0;
    }

    .chat-form input {
        flex-grow: 1;
        padding: 0.875rem 1rem;
        border: 2px solid var(--border-color);
        border-radius: var(--radius-md);
        font-size: 1rem;
        transition: var(--transition);
        font-family: inherit;
    }

    .chat-form input:focus {
        outline: none;
        border-color: var(--primary-color);
    }

    .chat-form button {
        padding: 0.875rem 1.5rem;
        background: var(--gradient-primary);
        color: white;
        border: none;
        border-radius: var(--radius-md);
        font-weight: 600;
        cursor: pointer;
        transition: var(--transition);
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .chat-form button:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
    }
    
    .chat-form button:disabled {
        background: var(--text-light);
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }

    .chat-error {
        text-align: center;
        padding: 0.75rem;
        background: #fff5f5;
        color: #c53030;
        border: 1px solid #f56565;
        border-radius: var(--radius-md);
        margin-bottom: 1rem;
        display: none; /* Hidden by default */
    }

</style>

<div class="ai-chat-container">
    <div class="chat-wrapper">
        <div class="aichat-header">
            <h2>AI Assistant</h2>
            <p>Powered by Gemini and OpenAI.</p>        
        </div>
        
        <!-- Error message display -->
        <div id="chat-error" class="chat-error"></div>

        <!-- Chat messages will be appended here -->
        <div class="chat-window" id="chat-window">
            <div class="chat-message ai">
                <div class="message-bubble">
                    <p>Hello! I'm EventEcho, your AI assistant. How can I help you with your event planning today?</p>
                </div>
            </div>
        </div>

        <!-- Chat input form -->
        <form class="chat-form" id="chat-form">
            <input type="text" id="chat-input" placeholder="Ask about event planning, schedules, etc..." autocomplete="off">
            <button type="submit" id="send-button">
                <span>Send</span>
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="22" y1="2" x2="11" y2="13"></line>
                    <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                </svg>
            </button>
        </form>
    </div>
</div>

<!-- Highlight.js styles -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/github-dark.min.css">

<!-- Highlight.js script -->
<script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/common.min.js"></script>

<script type="module">
    import { api } from '../js/api.js';
    import { token } from '../js/app.js';

    // Markdown + Sanitizer Libraries
    import { marked } from "https://cdn.jsdelivr.net/npm/marked/lib/marked.esm.js";
    import DOMPurify from "https://cdn.jsdelivr.net/npm/dompurify@3.1.6/+esm";

    // Configure Marked (Markdown parser)
    marked.setOptions({
        gfm: true,        // GitHub Flavored Markdown
        breaks: true,     // Convert single line breaks to <br>
        headerIds: false, // Avoid auto-generated <h1 id="...">
        mangle: false     // Don’t obfuscate email-like text
    });

    // Markdown → Safe HTML conversion
    function markdownToHtml(markdown) {
        const dirty = marked.parse(markdown || "");
        return DOMPurify.sanitize(dirty);
    }

    // --- Get DOM elements ---
    const chatForm = document.getElementById('chat-form');
    const chatInput = document.getElementById('chat-input');
    const sendButton = document.getElementById('send-button');
    const chatWindow = document.getElementById('chat-window');
    const chatError = document.getElementById('chat-error');

    // --- Function: Add a message to the chat ---
    function addMessage(sender, message) {
        const messageDiv = document.createElement('div');
        messageDiv.classList.add('chat-message', sender);

        const bubble = document.createElement('div');
        bubble.classList.add('message-bubble');

        if (sender === 'ai') {
            bubble.innerHTML = markdownToHtml(message);
            
            // (Optional) Syntax highlighting for code blocks
            if (window.hljs) {
                bubble.querySelectorAll('pre code').forEach(block => {
                    window.hljs.highlightElement(block);
                });
            }

        } else {
            bubble.textContent = message; // Safe plain text for user messages
        }

        messageDiv.appendChild(bubble);
        chatWindow.appendChild(messageDiv);
        chatWindow.scrollTop = chatWindow.scrollHeight;

        return messageDiv;
    }

    // --- Loading indicator ---
    function showLoading() {
        const loadingMessage = addMessage('ai', '');
        loadingMessage.classList.add('loading');
        loadingMessage.querySelector('.message-bubble').innerHTML = `
            <span class="loading-dots">
                <span>.</span><span>.</span><span>.</span>
            </span>
        `;
        return loadingMessage;
    }

    // --- Error display helpers ---
    function showError(message) {
        chatError.textContent = message;
        chatError.style.display = 'block';
    }
    function clearError() {
        chatError.style.display = 'none';
    }

    // --- Chat form submission ---
    chatForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const prompt = chatInput.value.trim();
        if (!prompt) return;

        // Disable form while processing
        chatInput.value = '';
        chatInput.disabled = true;
        sendButton.disabled = true;
        clearError();

        // 1. Add user's message
        addMessage('user', prompt);

        // 2. Show AI loading message
        const loadingElement = showLoading();

        try {
            // Get user's local time (ISO string)
            const userTime = new Date().toISOString();

            // 3. Call Flask backend (proxy endpoint)
            const result = await api('/ai/chat', 'POST', { 
                prompt, 
                user_time: userTime 
            }, token);

            // 4. Remove loading indicator
            loadingElement.remove();

            // 5. Handle AI response
            if (result && result.response) {
                addMessage('ai', result.response);
            } else {
                const errorMsg = result.error || 'The AI assistant returned an empty response.';
                addMessage('ai', `Sorry, I couldn't process that. ${errorMsg}`);
                showError(errorMsg);
            }

        } catch (err) {
            console.error("Chat API error:", err);
            loadingElement.remove();
            const errorMsg = 'The AI assistant is currently unavailable. Please try again later.';
            addMessage('ai', `Sorry, I ran into a connection issue.`);
            showError(errorMsg);
        } finally {
            chatInput.disabled = false;
            sendButton.disabled = false;
            chatInput.focus();
        }
    });
</script>
