<link rel="stylesheet" href="css/main.css">
<style>
    /* --- Main Layout --- */
    .wizard-container {
        display: flex;
        gap: 1.5rem;
        max-width: 1200px;
        margin: 0 auto;
        flex-direction: row;
        font-family: inherit;
    }

    .wizard-content {
        flex: 3;
        background: var(--bg-primary, #ffffff);
        border-radius: var(--radius-lg, 12px);
        padding: 2rem;
        box-shadow: var(--shadow-sm, 0 1px 3px rgba(0, 0, 0, 0.1));
        height: fit-content;
        display: flex;
        flex-direction: column;
    }

    .wizard-sidebar {
        flex: 2;
        min-width: 300px;
        max-width: 350px;
    }

    /* --- Stepper Navigation --- */
    .wizard-stepper {
        display: flex;
        justify-content: space-between;
        margin-bottom: 2rem;
        padding-bottom: 1.5rem;
        border-bottom: 1px solid var(--border-color, #e0e0e0);
        list-style: none;
        user-select: none;
    }

    .stepper-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        flex: 1;
        cursor: not-allowed;
        position: relative;
    }

    /* Stepper Dots */
    .stepper-dot {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: var(--bg-tertiary, #f3f4f6);
        color: var(--text-secondary, #6b7280);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        transition: all 0.2s ease;
        z-index: 2;
        border: 2px solid var(--border-color, #e5e7eb);
    }

    /* Active Step (Solid Blue) */
    .stepper-item.active .stepper-dot {
        background: var(--primary-color, #007bff);
        color: white;
        border-color: var(--primary-color, #007bff);
        box-shadow: 0 0 0 4px rgba(0, 123, 255, 0.2);
    }

    /* Completed Step (White with Blue Border) */
    .stepper-item.completed {
        cursor: pointer;
    }

    .stepper-item.completed .stepper-dot {
        background: white;
        color: var(--primary-color, #007bff);
        border-color: var(--primary-color, #007bff);
    }

    .stepper-label {
        margin-top: 0.5rem;
        font-size: 0.875rem;
        color: var(--text-secondary, #6b7280);
        font-weight: 500;
        text-align: center;
    }

    .stepper-item.active .stepper-label,
    .stepper-item.completed .stepper-label {
        color: var(--text-primary, #111827);
    }

    /* Connector Lines */
    .stepper-item:not(:first-child)::before {
        content: '';
        position: absolute;
        width: 100%;
        height: 3px;
        background: var(--border-color, #e5e7eb);
        top: 18px;
        /* Half of dot height */
        right: 50%;
        transform: translateY(-50%);
        z-index: 1;
    }

    /* Fill line if previous step is completed/active */
    .stepper-item.completed:not(:first-child)::before,
    .stepper-item.active:not(:first-child)::before {
        background: var(--primary-color, #007bff);
    }


    /* --- Step-by-Step Form --- */
    .wizard-step {
        display: none;
        animation: fadeIn 0.3s ease-out;
    }

    .wizard-step.active {
        display: block;
    }

    .wizard-step h2 {
        font-size: 1.75rem;
        margin-bottom: 0.5rem;
    }

    .wizard-step p.step-intro {
        font-size: 1.1rem;
        color: var(--text-secondary, #6b7280);
        margin-bottom: 2rem;
    }

    .step-content {
        flex-grow: 1;
    }

    .step-navigation {
        display: flex;
        justify-content: space-between;
        margin-top: 2rem;
        padding-top: 1.5rem;
        border-top: 1px solid var(--border-color, #e0e0e0);
    }

    .step-navigation .action-btn {
        padding: 0.75rem 1.5rem;
        width: 120px;
        justify-content: center;
        border-radius: var(--radius-md, 8px);
        font-weight: 600;
        cursor: pointer;
        border: none;
    }

    .action-btn.primary {
        background: var(--primary-color, #007bff);
        color: white;
    }

    .action-btn.secondary {
        background: var(--bg-tertiary, #f3f4f6);
        color: var(--text-primary, #111827);
    }

    .action-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    /* --- Form Elements --- */
    .form-section {
        margin-bottom: 1.5rem;
    }

    .form-section label {
        display: block;
        margin-bottom: 0.5rem;
        color: var(--text-secondary, #555);
        font-size: 0.875rem;
        font-weight: 500;
    }

    .form-section input,
    .form-section textarea,
    .form-section select {
        width: 100%;
        padding: 0.875rem 1rem;
        border: 2px solid var(--border-color, #e0e0e0);
        border-radius: var(--radius-md, 8px);
        font-size: 1rem;
        font-family: inherit;
        box-sizing: border-box;
    }

    .form-section input:focus,
    .form-section textarea:focus,
    .form-section select:focus {
        outline: none;
        border-color: var(--primary-color, #007bff);
    }

    /* --- Date & Time Picker Styling (Wizard Fix) --- */
    .date-time-group {
        display: flex;
        gap: 1.5rem;
        flex-wrap: wrap;
        margin-top: 0.5rem;
    }

    .dt-pair {
        flex: 1;
        min-width: 240px;
    }

    .dt-inputs {
        display: flex;
        gap: 0.5rem;
        align-items: center; /* Aligns date and time vertically */
    }

    .date-input-wrapper {
        flex: 3 !important;
    }


    .date-input-wrapper input[type="date"] {
        width: 100% !important;
        padding: 0.875rem 1rem !important;
        border: 2px solid var(--border-color, #e0e0e0) !important;
        border-radius: var(--radius-md, 8px) !important;
        font-size: 1rem !important;
        font-family: inherit !important;
        box-sizing: border-box !important;
        background-color: white !important;
        cursor: pointer !important;
    }

    .date-input-wrapper input[type="date"]:focus {
        outline: none !important;
        border-color: var(--primary-color, #007bff) !important;
    }

    /* Force time picker styling */
    .time-picker-wrapper {
        position: relative !important;
        flex: 2 !important;
        min-width: 100px !important;
    }

    .time-picker-wrapper input {
        width: 100% !important;
        padding: 0.875rem 1rem !important;
        border: 2px solid var(--border-color, #e0e0e0) !important;
        border-radius: var(--radius-md, 8px) !important;
        font-size: 1rem !important;
        box-sizing: border-box !important;
    }

    /* Force inputs in this group to fit the flex container */
    .dt-inputs input {
        width: 100% !important;
        box-sizing: border-box;
    }

    /* Dropdown Styling */
    .time-options-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        width: 100%;
        max-height: 200px;
        overflow-y: auto;
        background: white;
        border: 1px solid #ccc;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        z-index: 1000;
        display: none;
        list-style: none;
        padding: 0;
        margin: 4px 0 0 0;
    }

    .time-options-dropdown.show {
        display: block;
    }

    .time-options-dropdown li {
        padding: 8px 12px;
        cursor: pointer;
        font-size: 0.9rem;
    }

    .time-options-dropdown li:hover {
        background-color: #f0f7ff;
        color: #007bff;
    }

    .radio-group {
        display: flex;
        gap: 1rem;
        margin-bottom: 1rem;
    }

    .radio-label {
        display: flex;
        align-items: center;
        justify-content: center; /* Centering Text */
        gap: 0.5rem;
        padding: 0.75rem 1rem;
        border: 2px solid var(--border-color, #e0e0e0);
        border-radius: var(--radius-md, 8px);
        cursor: pointer;
        flex: 1; /* Make equal width */
    }

    /* Hide actual radio button */
    .radio-label input[type="radio"] {
        display: none;
    }

    .radio-label:has(input:checked) {
        background: var(--bg-tertiary, #f0f7ff);
        border-color: var(--primary-color, #007bff);
    }

    #w-venueSelectContainer,
    #w-customLocationContainer {
        display: none;
    }

    /* --- Review Step Formatting --- */
    #reviewStepContainer .review-item {
        margin-bottom: 1.25rem;
    }

    #reviewStepContainer .review-label {
        display: block;
        font-weight: 600;
        color: var(--text-secondary, #6b7280);
        font-size: 0.875rem;
        margin-bottom: 0.25rem;
    }

    #reviewStepContainer .review-value {
        color: var(--text-primary, #111827);
        font-size: 1.05rem;
    }

    #reviewStepContainer .review-value.description {
        white-space: pre-wrap;
        border-radius: var(--radius-sm, 6px);
        line-height: 1.6;
        font-size: 0.95rem;
    }

    #reviewStepContainer .review-value.missing {
        color: var(--text-light, #9ca3af);
        font-style: italic;
    }

    /* --- AI Helper Sidebar --- */
    .ai-helper-card {
        background: var(--bg-primary, #ffffff);
        border: 1px solid var(--border-color, #e0e0e0);
        box-shadow: var(--shadow-sm, 0 1px 2px rgba(0, 0, 0, 0.05));
        border-radius: var(--radius-lg, 12px);
        padding: 1.25rem;
        display: flex;
        flex-direction: column;
        position: sticky;
        top: 2rem;
        height: calc(100vh - 4rem);
        transition: all 0.3s ease;
    }

    .ai-helper-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid var(--border-color, #e0e0e0);
        flex-shrink: 0;
    }

    .ai-helper-header h3 {
        font-size: 1.25rem;
        margin: 0;
        background: var(--gradient-primary, linear-gradient(135deg, #007bff, #0056b3));
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
    }

    .ai-helper-messages {
        flex-grow: 1;
        overflow-y: auto;
        overflow-x: hidden;
        padding-right: 0.5rem;
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .ai-helper-msg {
        display: flex;
        align-items: flex-end;
        max-width: 100%;
    }

    .ai-helper-msg.user {
        flex-direction: row-reverse;
    }

    .ai-helper-avatar {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        font-size: 0.8rem;
    }

    .ai-helper-msg.ai .ai-helper-avatar,
    .ai-helper-msg.is-loading .ai-helper-avatar {
        background: var(--gradient-primary, linear-gradient(135deg, #007bff, #0056b3));
        color: white;
        margin-right: 0.5rem;
    }

    .ai-helper-msg.user .ai-helper-avatar {
        background: var(--bg-tertiary, #e5e7eb);
        color: var(--text-primary, #374151);
        margin-left: 0.5rem;
    }

    .ai-helper-bubble {
        padding: 0.75rem 1rem;
        border-radius: 12px;
        font-size: 0.9rem;
        line-height: 1.5;
        width: fit-content;
        max-width: 85%;
        word-break: break-word;
        overflow-wrap: anywhere;
    }

    .ai-helper-msg.ai .ai-helper-bubble,
    .ai-helper-msg.is-loading .ai-helper-bubble {
        background: var(--bg-tertiary, #f3f4f6);
        color: var(--text-primary, #1f2937);
        border-bottom-left-radius: 2px;
    }

    .ai-helper-msg.user .ai-helper-bubble {
        background: var(--gradient-primary, #007bff);
        color: white;
        border-bottom-right-radius: 2px;
    }

    .ai-helper-msg.is-loading .ai-helper-bubble {
        font-style: italic;
        color: var(--text-light, #6b7280);
    }

    .ai-suggestion-action {
        display: block;
        margin-top: 0.75rem;
        padding: 0.5rem 0.75rem;
        background: white;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        color: var(--primary-color, #007bff);
        font-size: 0.85rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        text-align: left;
        width: 100%;
    }

    .ai-suggestion-action:hover {
        background: #f9fafb;
        border-color: var(--primary-color, #007bff);
    }

    .ai-helper-form {
        flex-shrink: 0;
        margin-top: 1rem;
    }

    .ai-helper-input-wrapper {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        background: var(--bg-tertiary, #f3f4f6);
        border: 1px solid var(--border-color, #e5e7eb);
        border-radius: 24px;
        padding: 0.25rem 0.5rem 0.25rem 1rem;
        transition: border-color 0.2s;
    }

    .ai-helper-input-wrapper:focus-within {
        border-color: var(--primary-color, #007bff);
        background: white;
    }

    .ai-helper-input-wrapper input {
        flex-grow: 1;
        border: none;
        background: transparent;
        font-size: 0.9rem;
        padding: 0.6rem 0;
        font-family: inherit;
    }

    .ai-helper-input-wrapper input:focus {
        outline: none;
    }

    .ai-helper-input-wrapper button {
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        width: 36px;
        height: 36px;
        background: var(--gradient-primary, #007bff);
        color: white;
        border: none;
        border-radius: 50%;
        cursor: pointer;
        transition: transform 0.2s;
    }

    .ai-helper-input-wrapper button:hover {
        transform: scale(1.05);
    }

    .ai-helper-input-wrapper button:disabled {
        background: var(--text-light, #ccc);
        transform: none;
    }

    /* --- Error Message --- */
    .step-error {
        color: #c53030;
        background: #fff5f5;
        border: 1px solid #f56565;
        padding: 0.75rem 1rem;
        border-radius: var(--radius-md);
        margin-top: 1.5rem; /* Margin top to separate from buttons */
        display: none;
    }

    #wizardSubmitMessage {
        display: none;
        margin-top: 1rem;
    }

    .ai-toggle-icon {
        display: none;
    }

    /* --- Responsive --- */
    @media (max-width: 768px) {
        .wizard-container {
            flex-direction: column;
        }

        .wizard-sidebar {
            max-width: 100%;
            position: static;
        }

        .wizard-content {
            min-height: auto;
        }

        .wizard-stepper {
            font-size: 0.8rem;
        }

        .stepper-label {
            font-size: 0.75rem;
            max-width: 60px;
            line-height: 1.2;
        }

        .ai-helper-card {
            padding: 1rem;
            height: auto;
            max-height: 600px;
        }

        .ai-helper-header {
            cursor: pointer;
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }

        .ai-toggle-icon {
            display: block;
            transform: rotate(0deg);
            transition: transform 0.3s;
        }

        .ai-helper-card.collapsed .ai-helper-messages,
        .ai-helper-card.collapsed .ai-helper-form {
            display: none;
        }

        .ai-helper-card.expanded .ai-helper-header {
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .ai-helper-card.expanded .ai-toggle-icon {
            transform: rotate(180deg);
        }
    }
</style>

<div class="wizard-container page-transition-enter-active">

    <div class="wizard-content">

        <ol class="wizard-stepper" id="wizard-stepper">
            <li class="stepper-item active" data-step-target="1">
                <div class="stepper-dot">1</div>
                <div class="stepper-label">Basics</div>
            </li>
            <li class="stepper-item" data-step-target="2">
                <div class="stepper-dot">2</div>
                <div class="stepper-label">Date & Time</div>
            </li>
            <li class="stepper-item" data-step-target="3">
                <div class="stepper-dot">3</div>
                <div class="stepper-label">Location</div>
            </li>
            <li class="stepper-item" data-step-target="4">
                <div class="stepper-dot">4</div>
                <div class="stepper-label">Settings</div>
            </li>
            <li class="stepper-item" data-step-target="5">
                <div class="stepper-dot">5</div>
                <div class="stepper-label">Review</div>
            </li>
        </ol>

        <div class="wizard-step active" data-step="1" data-context="Event Title and Description">
            <h2>Step 1: The Basics</h2>
            <p class="step-intro">Let's start with the "what" and "why." A great title and clear description are key.
            </p>
            <div class="step-content">
                <div class="form-section">
                    <label for="w-title">Event Title*</label>
                    <input id="w-title" type="text" placeholder="e.g. Annual Design Symposium" required>
                </div>
                <div class="form-section">
                    <label for="w-description">Description</label>
                    <textarea id="w-description" placeholder="What is this event about? Who should attend?"
                        rows="5"></textarea>
                </div>
            </div>
            <div class="step-navigation">
                <button class="action-btn secondary" style="visibility: hidden;">Back</button>
                <button class="action-btn primary" onclick="navigateWizard(1, 'next')">Next</button>
            </div>
            <div class="step-error" id="error-1"></div>
        </div>

        <div class="wizard-step" data-step="2" data-context="Event Date and Time">
            <h2>Step 2: Date & Time</h2>
            <p class="step-intro">When is your event happening? Be sure to check for conflicts.</p>
            <div class="step-content">
                <div class="date-time-group">
                    <div class="dt-pair">
                        <label>Start*</label>
                        <div class="dt-inputs">
                            <div class="date-input-wrapper">
                                <input id="w-startDate" type="date" required>
                            </div>
                            <div class="time-picker-wrapper">
                                <input type="text" id="w-startTime" placeholder="Time" autocomplete="off" required>
                                <ul class="time-options-dropdown" id="w-startTimeList"></ul>
                            </div>
                        </div>
                    </div>

                    <div class="dt-pair">
                        <label>End*</label>
                        <div class="dt-inputs">
                            <div class="date-input-wrapper">
                                <input id="w-endDate" type="date" required>
                            </div>
                            <div class="time-picker-wrapper">
                                <input type="text" id="w-endTime" placeholder="Time" autocomplete="off" required>
                                <ul class="time-options-dropdown" id="w-endTimeList"></ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="step-navigation">
                <button class="action-btn secondary" onclick="navigateWizard(2, 'prev')">Back</button>
                <button class="action-btn primary" onclick="navigateWizard(2, 'next')">Next</button>
            </div>
            <div class="step-error" id="error-2"></div>
        </div>

        <div class="wizard-step" data-step="3" data-context="Event Location">
            <h2>Step 3: Location</h2>
            <p class="step-intro">Where will your event be held? On-campus or a custom address.</p>
            <div class="step-content">
                <div class="form-section">
                    <div class="radio-group">
                        <label class="radio-label"> <input type="radio" name="w-location_type" value="custom" checked>
                            Custom Address </label>
                        <label class="radio-label"> <input type="radio" name="w-location_type" value="venue"> On-Campus
                            Venue </label>
                    </div>
                    <div id="w-customLocationContainer">
                        <label for="w-customLocation">Custom Address*</label>
                        <input id="w-customLocation" type="text" placeholder="e.g. 123 Main St, Marion, IN" required>
                    </div>
                    <div id="w-venueSelectContainer" style="display: none;">
                        <label for="w-venue">Select a Venue*</label>
                        <select id="w-venue" required>
                            <option value="">Loading venues...</option>
                        </select>
                    </div>
                </div>
                <div class="form-section">
                    <label for="w-mapsLink">Google Maps Link (Optional)</label>
                    <input id="w-mapsLink" type="url" placeholder="https://maps.app.goo.gl/...">
                </div>
            </div>
            <div class="step-navigation">
                <button class="action-btn secondary" onclick="navigateWizard(3, 'prev')">Back</button>
                <button class="action-btn primary" onclick="navigateWizard(3, 'next')">Next</button>
            </div>
            <div class="step-error" id="error-3"></div>
        </div>

        <div class="wizard-step" data-step="4" data-context="Event Visibility Settings">
            <h2>Step 4: Settings</h2>
            <p class="step-intro">Who should be able to see this event?</p>
            <div class="step-content">
                <div class="form-section" id="w-visibilityContainer">
                    <h3>Visibility*</h3>
                    <div class="radio-group">
                        <label class="radio-label"> <input type="radio" name="w-visibility" value="public" checked>
                            Public </label>
                        <label class="radio-label"> <input type="radio" name="w-visibility" value="private"> Private
                        </label>
                    </div>
                    <p style="color: var(--text-light, #9ca3af); font-size: 0.875rem;" id="w-visibilityWarning">
                        Note: "Public" events may require approval.
                    </p>
                </div>
            </div>
            <div class="step-navigation">
                <button class="action-btn secondary" onclick="navigateWizard(4, 'prev')">Back</button>
                <button class="action-btn primary" onclick="navigateWizard(4, 'next')">Review</button>
            </div>
            <div class="step-error" id="error-4"></div>
        </div>

        <div class="wizard-step" data-step="5" data-context="Reviewing Event Details">
            <h2>Step 5: Review & Submit</h2>
            <p class="step-intro">One final look. If everything is correct, submit your event!</p>
            <div class="step-content">
                <div id="reviewStepContainer"> </div>
                <div id="wizardSubmitMessage"></div>
            </div>
            <div class="step-navigation">
                <button class="action-btn secondary" onclick="navigateWizard(5, 'prev')">Back</button>
                <button id="wizardSubmitBtn" class="action-btn primary" onclick="submitWizard()">Submit Event</button>
            </div>
        </div>
    </div>

    <aside class="wizard-sidebar">
        <div class="ai-helper-card" id="aiHelperCard">
            <div class="ai-helper-header" onclick="toggleMobileAI()">
                <h3>AI Co-Pilot</h3>
                <div class="ai-toggle-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M6 9l6 6 6-6" />
                    </svg>
                </div>
            </div>
            <div class="ai-helper-messages" id="ai-helper-messages">
                <div class="ai-helper-msg ai">
                    <div class="ai-helper-avatar">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 2L10 9L3 11L10 13L12 20L14 13L21 11L14 9L12 2Z" />
                        </svg>
                    </div>
                    <div class="ai-helper-bubble">
                        <p id="ai-helper-intro-text">I'm here to help! Ask me to rewrite a description or suggest a
                            title. If you like my suggestion, I'll give you an 'Update' button to apply it directly to
                            the form.</p>
                    </div>
                </div>
            </div>
            <form class="ai-helper-form" id="ai-helper-form">
                <div class="ai-helper-input-wrapper">
                    <input type="text" id="ai-helper-input" placeholder="Ask for suggestions..."
                        aria-label="AI Assistant Input">
                    <button type="submit" id="ai-helper-send" aria-label="Send">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M2 3L22 12L2 21L5 13L15 12L5 11L2 3Z" />
                        </svg>
                    </button>
                </div>
            </form>
        </div>
    </aside>

</div>

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<script type="module">
    import { api } from '../js/api.js';
    import { getRoleFromToken } from '../js/app.js';

    const token = localStorage.getItem("token");
    const userRole = getRoleFromToken();

    let currentStep = 1;
    let maxStepCompleted = 1;
    const wizardData = {};
    let allVenues = [];

    // --- DOM Elements ---
    const steps = document.querySelectorAll('.wizard-step');
    const stepperItems = document.querySelectorAll('.stepper-item');
    const venueSelect = document.getElementById('w-venue');
    const mapLinkInput = document.getElementById('w-mapsLink');
    const locationTypeRadios = document.querySelectorAll('input[name="w-location_type"]');
    const visibilityContainer = document.getElementById('w-visibilityContainer');
    const visibilityWarning = document.getElementById('w-visibilityWarning');

    // Date/Time Elements
    const wStartDate = document.getElementById('w-startDate');
    const wStartTime = document.getElementById('w-startTime');
    const wEndDate = document.getElementById('w-endDate');
    const wEndTime = document.getElementById('w-endTime');

    // --- Role-Based UI ---
    if (userRole !== 'admin' && userRole !== 'organizer') {
        visibilityContainer.querySelector('input[value="public"]').disabled = true;
        visibilityContainer.querySelector('input[value="private"]').checked = true;
        visibilityWarning.textContent = 'As an attendee, your events will be created as "Private". Contact an admin to make it public.';
    }

    // --- Mobile AI Toggle Logic ---
    window.toggleMobileAI = () => {
        const card = document.getElementById('aiHelperCard');
        if (card.classList.contains('expanded')) {
            card.classList.remove('expanded');
            card.classList.add('collapsed');
        } else {
            card.classList.remove('collapsed');
            card.classList.add('expanded');
        }
    };

    // Start collapsed on mobile
    if (window.innerWidth <= 768) { // Mobile breakpoint
        document.getElementById('aiHelperCard').classList.add('collapsed');
    }

    // --- Time Picker Logic (Ported from Event Form) ---

    // Generate time slots (15 min increments)
    function generateTimeSlots() {
        const slots = [];
        const periods = ['AM', 'PM'];
        for (let i = 0; i < 24 * 4; i++) { // 15 min chunks
            const totalMinutes = i * 15;
            const hours24 = Math.floor(totalMinutes / 60);
            const minutes = totalMinutes % 60;
            const period = hours24 >= 12 ? 'PM' : 'AM';
            let hours12 = hours24 % 12;
            if (hours12 === 0) hours12 = 12;

            const timeString = `${hours12}:${minutes.toString().padStart(2, '0')} ${period}`;
            slots.push({ display: timeString, value24: `${hours24.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}` });
        }
        return slots;
    }

    const timeSlots = generateTimeSlots();

    function setupTimePicker(inputId, listId) {
        const input = document.getElementById(inputId);
        const list = document.getElementById(listId);

        // Populate list
        function renderList(filter = '') {
            list.innerHTML = '';
            const normalizedFilter = filter.toLowerCase().replace(/\s/g, ''); // e.g. "500pm" -> "500pm"

            const filtered = timeSlots.filter(slot => {
                const searchStr = slot.display.toLowerCase().replace(/\s/g, '');
                return searchStr.startsWith(normalizedFilter) || slot.display.toLowerCase().includes(filter.toLowerCase());
            });

            if (filtered.length === 0) return;

            filtered.forEach(slot => {
                const li = document.createElement('li');
                li.textContent = slot.display;
                li.addEventListener('mousedown', (e) => {
                    e.preventDefault(); // Prevent blur
                    input.value = slot.display;
                    list.classList.remove('show');
                });
                list.appendChild(li);
            });
        }

        input.addEventListener('focus', () => {
            renderList();
            list.classList.add('show');
        });

        input.addEventListener('input', (e) => {
            renderList(e.target.value);
            list.classList.add('show');
        });

        // Blur: Try to parse loose input (e.g., "5" -> "5:00 PM", "13" -> "1:00 PM")
        input.addEventListener('blur', () => {
            setTimeout(() => list.classList.remove('show'), 150);

            let val = input.value.trim();
            if (!val) return;

            // Simple parser logic
            const exactMatch = timeSlots.find(s => s.display.toLowerCase() === val.toLowerCase());
            if (exactMatch) {
                input.value = exactMatch.display;
                return;
            }

            // Regex for 1-2 digits, optional minutes, optional am/pm
            const match = val.match(/^(\d{1,2})(?::?(\d{2}))?\s*([ap]m?)?$/i);
            if (match) {
                let h = parseInt(match[1]);
                let m = match[2] ? parseInt(match[2]) : 0;
                let mer = match[3] ? match[3].toLowerCase() : null;

                if (h > 24) return;
                if (m > 59) return;

                if (!mer) {
                    if (h === 12) mer = 'pm';
                    else if (h < 7) mer = 'pm';
                    else if (h >= 7 && h <= 11) mer = 'am';
                }

                if (mer && (mer.startsWith('p')) && h < 12) h += 12;
                if (mer && (mer.startsWith('a')) && h === 12) h = 0;

                const hours24 = h;
                let hours12 = hours24 % 12;
                if (hours12 === 0) hours12 = 12;
                if (hours24 > 23) hours12 = 12;
                const period = hours24 >= 12 && hours24 < 24 ? 'PM' : 'AM';

                input.value = `${hours12}:${m.toString().padStart(2, '0')} ${period}`;
            }
        });
    }

    // Initialize Time Pickers
    setupTimePicker('w-startTime', 'w-startTimeList');
    setupTimePicker('w-endTime', 'w-endTimeList');

    // Helper to get ISO string from Date + Time inputs
    function getISOFromInputs(dateInput, timeInput) {
        if (!dateInput.value || !timeInput.value) return null;

        const timeStr = timeInput.value;
        const match = timeStr.match(/(\d{1,2}):(\d{2})\s*(AM|PM)/i);

        let h = 0, m = 0;
        if (match) {
            h = parseInt(match[1]);
            m = parseInt(match[2]);
            const mer = match[3].toUpperCase();
            if (mer === 'PM' && h < 12) h += 12;
            if (mer === 'AM' && h === 12) h = 0;
        } else {
            return new Date(`${dateInput.value}T00:00`).toISOString();
        }

        const d = new Date(`${dateInput.value}T${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:00`);
        return d.toISOString();
    }

    // Helper to set inputs from ISO string
    function setInputsFromISO(isoString, dateEl, timeEl) {
        if (!isoString) return;
        const d = new Date(isoString);

        const year = d.getFullYear();
        const month = String(d.getMonth() + 1).padStart(2, '0');
        const day = String(d.getDate()).padStart(2, '0');
        dateEl.value = `${year}-${month}-${day}`;

        let h = d.getHours();
        const m = d.getMinutes();
        const mer = h >= 12 ? 'PM' : 'AM';
        let h12 = h % 12;
        if (h12 === 0) h12 = 12;

        timeEl.value = `${h12}:${m.toString().padStart(2, '0')} ${mer}`;
    }

    // --- Location Toggle Logic ---
    function handleLocationTypeChange() {
        const type = document.querySelector('input[name="w-location_type"]:checked').value;
        document.getElementById('w-venueSelectContainer').style.display = (type === 'venue') ? 'block' : 'none';
        document.getElementById('w-customLocationContainer').style.display = (type === 'custom') ? 'block' : 'none';
    }
    locationTypeRadios.forEach(radio => radio.addEventListener('change', handleLocationTypeChange));

    // --- Load Venues ---
    async function loadVenues() {
        try {
            const venues = await api("/venues/", "GET", null, token);
            allVenues = venues || []; // Store globally for autofill

            if (venues && venues.length > 0) {
                venueSelect.innerHTML = '<option value="">-- Select a venue --</option>';
                venues.forEach(venue => {
                    const option = new Option(`${venue.name} ${venue.building ? `(${venue.building}${venue.room_number ? `, ${venue.room_number}` : ''})` : ''}`, venue.venue_id);
                    venueSelect.appendChild(option);
                });
            } else {
                venueSelect.innerHTML = '<option value="">No on-campus venues found</option>';
            }
        } catch (error) { console.error("Failed to load venues:", error); }
    }

    // Autofill venue link logic
    venueSelect.addEventListener('change', () => {
        const selectedId = venueSelect.value;
        if (selectedId && allVenues.length > 0) {
            const venue = allVenues.find(v => v.venue_id == selectedId);
            if (venue) {
                if (venue.google_maps_link) {
                    if (!mapLinkInput.value) {
                        mapLinkInput.value = venue.google_maps_link;
                        mapLinkInput.style.transition = "background-color 0.3s";
                        mapLinkInput.style.backgroundColor = "#e6f3ff";
                        setTimeout(() => mapLinkInput.style.backgroundColor = "", 1000);
                    }
                } else {
                    mapLinkInput.value = "";
                }
            }
        }
    });

    // --- Wizard Navigation ---
    window.navigateWizard = (stepNum, direction) => {
        if (direction === 'next') {
            if (!validateStep(stepNum)) return;
            saveStepData(stepNum);
            currentStep++;
            maxStepCompleted = Math.max(maxStepCompleted, currentStep);
        } else {
            saveStepData(stepNum);
            currentStep--;
        }
        updateWizardView();
    }

    window.goToStep = (stepNum) => {
        if (stepNum <= maxStepCompleted) {
            saveStepData(currentStep); // Save current progress before jump
            currentStep = stepNum;
            updateWizardView();
        }
    }

    function updateWizardView() {
        steps.forEach(step => {
            step.classList.toggle('active', parseInt(step.dataset.step) === currentStep);
        });

        stepperItems.forEach((item, index) => {
            const step = index + 1;
            item.classList.toggle('active', step === currentStep);
            item.classList.toggle('completed', step < currentStep); // Strictly less than current

            if (step <= maxStepCompleted) {
                item.onclick = () => goToStep(step);
                item.style.cursor = 'pointer';
            } else {
                item.onclick = null;
                item.style.cursor = 'not-allowed';
            }
        });

        const activeStepEl = document.querySelector(`.wizard-step.active`);
        if (activeStepEl) {
            const context = activeStepEl.dataset.context;
            document.getElementById('ai-helper-intro-text').textContent = `Hello! I'm ready to help with your ${context.toLowerCase()}. I can help update your details if you ask me to.`;
            document.getElementById('ai-helper-messages').dataset.context = context;
        }

        if (currentStep === 5) {
            populateReviewStep();
        }
    }

    // --- Step Validation (Updated for Split Date/Time) ---
    function validateStep(stepNum) {
        const errorDiv = document.getElementById(`error-${stepNum}`);
        errorDiv.style.display = 'none';
        let isValid = true;

        if (stepNum === 1) { // Title & Description
            if (!document.getElementById('w-title').value) {
                errorDiv.textContent = 'Event Title is required.'; isValid = false;
            }
        }
        if (stepNum === 2) { // Date & Time
            // Check that all sub-inputs have values
            if (!wStartDate.value || !wStartTime.value || !wEndDate.value || !wEndTime.value) {
                errorDiv.textContent = 'Start Date, Start Time, End Date, and End Time are required.';
                isValid = false;
            } else {
                // Construct ISO to check range logic
                const startISO = getISOFromInputs(wStartDate, wStartTime);
                const endISO = getISOFromInputs(wEndDate, wEndTime);
                if (new Date(startISO) >= new Date(endISO)) {
                    errorDiv.textContent = 'End Time must be after Start Time.'; isValid = false;
                }
            }
        }
        if (stepNum === 3) { // Location
            const type = document.querySelector('input[name="w-location_type"]:checked').value;
            if (type === 'venue' && !document.getElementById('w-venue').value) {
                errorDiv.textContent = 'Please select an On-Campus Venue.'; isValid = false;
            }
            if (type === 'custom' && !document.getElementById('w-customLocation').value) {
                errorDiv.textContent = 'Please enter a Custom Address.'; isValid = false;
            }
        }

        if (!isValid) errorDiv.style.display = 'block'; // Show error if invalid
        return isValid;
    }

    // --- Data Handling (Updated for Split Date/Time) ---
    function saveStepData(stepNum) {
        if (stepNum === 1) { // Title & Description
            wizardData.title = document.getElementById('w-title').value;
            wizardData.description = document.getElementById('w-description').value;
        }
        if (stepNum === 2) { // Date & Time
            // Save as ISO strings for backend compatibility
            wizardData.start_time = getISOFromInputs(wStartDate, wStartTime);
            wizardData.end_time = getISOFromInputs(wEndDate, wEndTime);
        }
        if (stepNum === 3) { // Location
            wizardData.location_type = document.querySelector('input[name="w-location_type"]:checked').value;
            wizardData.venue_id = document.getElementById('w-venue').value;
            wizardData.custom_location_address = document.getElementById('w-customLocation').value;
            wizardData.google_maps_link = document.getElementById('w-mapsLink').value;
        }
        if (stepNum === 4) { // Settings
            wizardData.visibility = (userRole === 'admin' || userRole === 'organizer')
                ? document.querySelector('input[name="w-visibility"]:checked').value
                : 'private';
        }
    }

    // --- Populate Review Step ---
    function populateReviewStep() {
        const container = document.getElementById('reviewStepContainer');
        const venueSelect = document.getElementById('w-venue');

        // Ensure all data is saved
        saveStepData(1); saveStepData(2); saveStepData(3); saveStepData(4);

        // Get venue text
        const venueText = wizardData.venue_id ? (venueSelect.options[venueSelect.selectedIndex]?.text || 'N/A') : 'N/A';

        // Helper function to format each review item
        const f = (label, value, isDesc = false) => {
            let displayValue = value;
            // Format dates
            if (label.includes('Time') && value) {
                try {
                    displayValue = new Date(value).toLocaleString('en-US', {
                        year: 'numeric', month: 'short', day: 'numeric',
                        hour: 'numeric', minute: '2-digit', hour12: true
                    });
                } catch (e) { /* ignore invalid date */ }
            }

            const val = displayValue || 'Not provided';
            const valClass = value ? (isDesc ? 'description' : '') : 'missing';
            return `<div class="review-item"><span class="review-label">${label}</span><span class="review-value ${valClass}">${val}</span></div>`;
        };

        // Inject review items
        container.innerHTML = `
            ${f('Title', wizardData.title)}
            ${f('Start Time', wizardData.start_time)}
            ${f('End Time', wizardData.end_time)}
            ${f('Location', wizardData.location_type === 'venue' ? venueText : wizardData.custom_location_address)}
            ${f('Google Maps Link', wizardData.google_maps_link)}
            ${f('Visibility', wizardData.visibility)}
            ${f('Description', wizardData.description, true)}
        `;
    }

    // --- AI Helper Chat & Actions ---
    const aiForm = document.getElementById('ai-helper-form');
    const aiInput = document.getElementById('ai-helper-input');
    const aiSendBtn = document.getElementById('ai-helper-send');
    const aiMessages = document.getElementById('ai-helper-messages');

    // --- History State ---
    const MAX_HISTORY = 10;
    let chatHistory = [];

    // --- Get Current Step Values for AI Context (Updated) ---
    function getCurrentStepValues() {
        return {
            title: document.getElementById('w-title').value,
            description: document.getElementById('w-description').value,
            // Send ISOs to AI (it understands ISO better than split)
            start_time: getISOFromInputs(wStartDate, wStartTime),
            end_time: getISOFromInputs(wEndDate, wEndTime),
            location_type: document.querySelector('input[name="w-location_type"]:checked').value,
            venue: document.getElementById('w-venue').value,
            customLocation: document.getElementById('w-customLocation').value,
            visibility: document.querySelector('input[name="w-visibility"]:checked').value
        };
    }

    // AI Form Submit
    aiForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const prompt = aiInput.value.trim();
        if (!prompt) return;

        // Use context from current step, or 'Review' if on step 5
        let context = "general event planning";
        if (currentStep === 5) context = "Reviewing Event Details";
        else {
            const activeStepEl = document.querySelector(`.wizard-step.active`);
            if (activeStepEl) context = activeStepEl.dataset.context;
        }

        aiInput.value = '';
        aiInput.disabled = true;
        aiSendBtn.disabled = true;

        chatHistory.push({ role: "user", content: prompt });

        addHelperMessage('user', prompt);
        const loadingMsg = addHelperMessage('is-loading', 'Thinking...');

        // --- Send API Request ---
        try {
            const payload = {
                prompt,
                context,
                user_time: new Date().toISOString(),
                current_values: getCurrentStepValues(),
                history: chatHistory.slice(-MAX_HISTORY)
            };
            const result = await api('/ai/wizard-helper', 'POST', payload, token);
            loadingMsg.remove();

            if (result.response) {
                chatHistory.push({ role: "ai", content: result.response });
                addHelperMessage('ai', result.response, result.actions);
            } else {
                addHelperMessage('ai', `Error: ${result.error || 'No response'}`);
            }
        } catch (err) {
            loadingMsg.remove();
            addHelperMessage('ai', 'Error connecting to AI helper.');
        } finally {
            aiInput.disabled = false;
            aiSendBtn.disabled = false;
            aiInput.focus();
        }
    });

    // --- Add Message to AI Chat ---
    function addHelperMessage(sender, text, actions = null) {

        // --- Friendly labels for Wizard & Main Form fields ---
        const FIELD_LABELS = {
            "w-title": "Title",
            "w-description": "Description",
            "w-start": "Start Time",
            "w-end": "End Time",
            "w-location_type": "Location Type",
            "w-venue": "Venue",
            "w-customLocation": "Custom Address",
            "w-visibility": "Visibility",
            "w-mapsLink": "Google Maps Link",
            "evTitle": "Title",
            "evDescription": "Description",
            "evStart": "Start Time",
            "evEnd": "End Time",
            "evCustomLocation": "Custom Address",
            "location_type": "Location Type",
            "visibility": "Visibility"
        };

        const msg = document.createElement('div');
        msg.className = `ai-helper-msg ${sender === 'is-loading' ? 'ai is-loading' : sender}`;

        const avatar = document.createElement('div');
        avatar.className = 'ai-helper-avatar';

        const bubble = document.createElement('div');
        bubble.className = 'ai-helper-bubble';

        // AI or Loading Message
        if (sender === 'ai' || sender === 'is-loading') {
            avatar.innerHTML = `
                <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 2L10 9L3 11L10 13L12 20L14 13L21 11L14 9L12 2Z"/>
                </svg>
            `;

            if (sender === 'is-loading') {
                bubble.innerHTML = `<span class="loading-dots">...</span>`;
            } else {
                bubble.innerHTML = window.marked ? window.marked.parse(text) : text;

                // --- Add Action Buttons if any ---
                if (actions && Array.isArray(actions) && actions.length > 0) {
                    actions.forEach(action => {
                        const btn = document.createElement('button');
                        btn.className = 'ai-suggestion-action';

                        // Friendly name lookup
                        let friendlyLabel = FIELD_LABELS[action.field];
                        if (!friendlyLabel) {
                            if (action.field) {
                                friendlyLabel = action.field
                                    .replace(/^w-/, "")
                                    .replace(/^ev/, "")
                                    .replace(/[-_]/g, " ")
                                    .replace(/([A-Z])/g, " $1")
                                    .trim();
                                friendlyLabel = friendlyLabel.charAt(0).toUpperCase() + friendlyLabel.slice(1);
                            } else {
                                friendlyLabel = "Field";
                            }
                        }

                        // Trim long values
                        const displayValue = (action.value && action.value.length > 50)
                            ? action.value.substring(0, 48) + "..."
                            : (action.value || "");

                        btn.innerHTML = `<strong>Update ${friendlyLabel}</strong> "${displayValue}"`;
                        btn.onclick = () => applyAIAction(action.field, action.value, btn);

                        bubble.appendChild(btn);
                    });
                }
            }

            // User Message
        } else {
            avatar.innerHTML = `
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" 
                    stroke="currentColor" stroke-width="2.5">
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8
                            a4 4 0 0 0-4 4v2"></path>
                    <circle cx="12" cy="7" r="4"></circle>
                </svg>
            `;
            bubble.textContent = text;
        }

        // Append to sidebar
        msg.appendChild(avatar);
        msg.appendChild(bubble);
        aiMessages.appendChild(msg);

        // Auto-scroll to bottom
        aiMessages.scrollTop = aiMessages.scrollHeight;

        return msg;
    }

    // --- Apply AI Suggested Action to Form (UPDATED for Split Time) ---
    function applyAIAction(fieldId, value, btnElement) {
        let fieldChanged = false;

        // Handle Date/Time Splits (AI sends ISO string, we fill split fields)
        if (fieldId === 'w-start' || fieldId === 'evStart') {
            setInputsFromISO(value, wStartDate, wStartTime);
            fieldChanged = true;
        }
        else if (fieldId === 'w-end' || fieldId === 'evEnd') {
            setInputsFromISO(value, wEndDate, wEndTime);
            fieldChanged = true;
        }

        // Handle Radio Buttons
        else if (fieldId === 'w-location_type' || fieldId === 'w-visibility') {
            const radio = document.querySelector(`input[name="${fieldId}"][value="${value}"]`);
            if (radio) {
                radio.checked = true;
                wizardData[fieldId] = value;
                fieldChanged = true;
                if (fieldId === 'w-location_type') {
                    handleLocationTypeChange(); // Update UI
                }
            }
        }
        // Handle Select & Text Inputs
        else {
            const field = document.getElementById(fieldId);
            if (field) {
                field.value = value;
                // Highlight effect
                field.style.transition = "background-color 0.3s";
                field.style.backgroundColor = "#e6f3ff";
                setTimeout(() => { field.style.backgroundColor = ""; }, 1000);

                // Map field IDs to wizardData keys
                if (fieldId === 'w-title') wizardData.title = value;
                if (fieldId === 'w-description') wizardData.description = value;
                if (fieldId === 'w-venue') wizardData.venue_id = value;
                if (fieldId === 'w-customLocation') wizardData.custom_location_address = value;
                if (fieldId === 'w-mapsLink') wizardData.google_maps_link = value;

                fieldChanged = true;
            } else {
                console.error("Field not found:", fieldId);
            }
        }

        if (fieldChanged) {
            // Update button feedback
            btnElement.innerHTML = `<strong>Updated!</strong>`;
            btnElement.style.background = "#d4edda";
            btnElement.style.color = "#155724";
            btnElement.style.borderColor = "#c3e6cb";
            btnElement.disabled = true;
            btnElement.style.cursor = "default";

            // If we are on the Review Step (5), re-render it
            if (currentStep === 5) {
                populateReviewStep();
            }
        } else {
            console.error("AI action failed for field:", fieldId, "with value:", value);
        }
    }

    // --- FINAL SUBMIT ---
    window.submitWizard = async () => {
        const submitBtn = document.getElementById('wizardSubmitBtn');
        const msgDiv = document.getElementById('wizardSubmitMessage');
        submitBtn.disabled = true;
        submitBtn.textContent = 'Submitting...';

        // --- Ensure data is saved before submit ---
        saveStepData(currentStep);

        const payload = {
            title: wizardData.title,
            description: wizardData.description,
            start_time: wizardData.start_time, // already ISO from saveStepData
            end_time: wizardData.end_time,     // already ISO from saveStepData
            location_type: wizardData.location_type,
            google_maps_link: wizardData.google_maps_link || null,
            visibility: wizardData.visibility,
            venue_id: wizardData.location_type === 'venue' ? wizardData.venue_id : null,
            custom_location_address: wizardData.location_type === 'custom' ? wizardData.custom_location_address : null,
        };

        try {
            const res = await api("/events/", "POST", payload, token);
            if (res.error) {
                msgDiv.className = "error-message";
                msgDiv.textContent = res.error || "Failed to create event";
                msgDiv.style.display = "block";
                submitBtn.disabled = false;
                submitBtn.textContent = "Submit Event";
            } else {
                msgDiv.className = "success-message";
                msgDiv.textContent = "Event created successfully! Redirecting...";
                msgDiv.style.display = "block";
                setTimeout(() => { window.location.hash = "#/calendar"; }, 1500);
            }
        } catch (error) {
            msgDiv.className = "error-message";
            msgDiv.textContent = "Network error. Please try again.";
            msgDiv.style.display = "block";
            submitBtn.disabled = false;
            submitBtn.textContent = "Submit Event";
        }
    }

    // --- Initial Load ---
    handleLocationTypeChange();
    loadVenues();
    updateWizardView();
</script>