<div class="events-list-container glass-card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem;">
        <h2>All Events</h2>
        <div id="eventActions"></div>
    </div>
    
    <button id="loadEvents">Load Events</button>
    <div id="eventList"></div>
</div>

<script type="module">
import { api } from "../js/api.js";

const eventList = document.getElementById("eventList");
const loadBtn = document.getElementById("loadEvents");
const eventActions = document.getElementById("eventActions");
const token = localStorage.getItem("token");
const isLoggedIn = !!token;

// Show appropriate actions based on login status
if (isLoggedIn) {
    // Check if user can create events (organizer or admin)
    const payload = JSON.parse(atob(token.split(".")[1]));
    if (payload.role === "organizer" || payload.role === "admin") {
        eventActions.innerHTML = `
            <a href="#/create-event" class="action-btn primary" style="text-decoration: none; display: inline-flex;">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="12" y1="8" x2="12" y2="16"></line>
                    <line x1="8" y1="12" x2="16" y2="12"></line>
                </svg>
                New Event
            </a>
        `;
    }
}

async function loadEvents() {
    try {
        loadBtn.disabled = true;
        loadBtn.textContent = "Loading...";
        eventList.innerHTML = '<div class="loading">Loading events</div>';
        
        const events = await api("/events/", "GET", null, token);
        
        if (!events || events.length === 0) {
            eventList.innerHTML = `
                <div class="empty-state">
                    <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                        <line x1="16" y1="2" x2="16" y2="6"></line>
                        <line x1="8" y1="2" x2="8" y2="6"></line>
                        <line x1="3" y1="10" x2="21" y2="10"></line>
                    </svg>
                    <h3>No Events Yet</h3>
                    <p>Check back soon for upcoming events!</p>
                </div>
            `;
            loadBtn.disabled = false;
            loadBtn.textContent = "Refresh Events";
            return;
        }
        
        // Sort events by start time
        events.sort((a, b) => new Date(a.start_time) - new Date(b.start_time));
        
        eventList.innerHTML = events.map(e => {
            const startDate = new Date(e.start_time);
            const formattedDate = startDate.toLocaleDateString('en-US', { 
                month: 'short', 
                day: 'numeric', 
                year: 'numeric',
                hour: 'numeric',
                minute: '2-digit'
            });
            
            // Determine action button based on login status
            let actionButton = '';
            if (isLoggedIn) {
                actionButton = '<button class="btn-primary" onclick="alert(\'RSVP feature coming soon!\')">RSVP</button>';
            } else {
                actionButton = '<a href="#/login" class="btn-primary" style="text-align: center; display: block;">Login to RSVP</a>';
            }
            
            return `
                <article class="event-card" style="margin-bottom: 1rem;">
                    <div class="event-content">
                        <div class="event-date">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                                <line x1="16" y1="2" x2="16" y2="6"></line>
                                <line x1="8" y1="2" x2="8" y2="6"></line>
                                <line x1="3" y1="10" x2="21" y2="10"></line>
                            </svg>
                            ${formattedDate}
                        </div>
                        <h3>${e.title}</h3>
                        ${e.description ? `<p class="event-description">${e.description}</p>` : ''}
                        <div class="event-meta">
                            <span class="location">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                                    <circle cx="12" cy="10" r="3"></circle>
                                </svg>
                                ${e.location}
                            </span>
                        </div>
                        <div class="event-actions">
                            ${actionButton}
                        </div>
                    </div>
                </article>
            `;
        }).join("");
        
        loadBtn.disabled = false;
        loadBtn.textContent = "Refresh Events";
        
    } catch (error) {
        console.error("Failed to load events:", error);
        eventList.innerHTML = '<div class="error-message">Failed to load events. Please try again.</div>';
        loadBtn.disabled = false;
        loadBtn.textContent = "Refresh Events";
    }
}

// Load events on button click
loadBtn.addEventListener("click", loadEvents);

// Auto-load on page load
loadEvents();
</script>