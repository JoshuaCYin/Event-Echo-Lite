<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/main.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>

<style>
/* ------------------------------------------------------ */
/* HEADER */
/* ------------------------------------------------------ */
.event-hub-header {
    text-align: center;
    border-bottom: 1px solid var(--border-color);
    padding-bottom: 1.5rem;
    margin-bottom: 2rem;
}
.event-hub-header h2 {
    font-size: 1.75rem;
    background: var(--gradient-primary);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin-bottom: 0.5rem;
}
.event-hub-header p {
    font-size: 1.1rem;
    color: var(--text-secondary);
    max-width: 600px;
    margin: 0 auto;
}

/* ------------------------------------------------------ */
/* FILTERS */
/* ------------------------------------------------------ */
.filter-toggle-switch {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    background: var(--bg-tertiary);
    border: 1px solid var(--border-color);
    padding: 0.65rem 1rem;
    border-radius: var(--radius-md);
    white-space: nowrap;
}
.filter-toggle-switch label {
    font-size: 0.875rem;
    color: var(--text-secondary);
    cursor: pointer;
}
.filter-toggle-switch input {
    width: auto;
    accent-color: var(--primary-color);
    cursor: pointer;
}

/* ------------------------------------------------------ */
/* RSVP BUTTON + DROPDOWN MENU */
/* ------------------------------------------------------ */
.rsvp-btn-container {
    position: relative;
    flex: 1;
}
/* Make container fit width in list view */
.app-events-list .rsvp-btn-container {
    width: 100%; 
}

.rsvp-btn {
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    min-width: 100px;
}

.rsvp-btn.is-going {
    background: var(--primary-dark);
    color: white;
}

/* Shared Dropdown Styles (Used for RSVP and Edit Options) */
.dropdown-menu {
    display: none;
    position: absolute;
    background: var(--bg-primary);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-lg);
    z-index: 50; /* Higher than content */
    overflow: hidden;
    min-width: 140px;
}
.dropdown-menu.open {
    display: block;
}
.rsvp-btn-container .dropdown-menu {
    bottom: 110%;
    left: 0;
    width: 100%;
}
.dropdown-menu button {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    width: 100%;
    padding: 0.75rem 1rem;
    text-align: left;
    background: none;
    border: none;
    border-bottom: 1px solid var(--border-color);
    cursor: pointer;
    font-size: 0.875rem;
    transition: var(--transition);
    color: var(--text-primary);
}
.dropdown-menu button:last-child {
    border-bottom: none;
}
.dropdown-menu button:hover {
    background: var(--bg-tertiary);
    color: var(--primary-color);
}
.dropdown-menu button.clear-rsvp {
    color: #e53e3e;
}
.dropdown-menu button.delete-option {
    color: #e53e3e;
}
.dropdown-menu button.delete-option:hover {
    background: #fff5f5;
}

/* ------------------------------------------------------ */
/* OPTIONS MENU (EDIT/DELETE) */
/* ------------------------------------------------------ */
.options-btn-container {
    position: relative;
    display: inline-block;
}
.options-toggle-btn {
    background: rgba(255, 255, 255, 0.9); /* High contrast background */
    border: 1px solid var(--border-color);
    color: var(--text-secondary);
    padding: 0.4rem;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    width: 36px; /* Fixed width for alignment calculation */
    height: 36px;
}
.options-toggle-btn:hover {
    background: var(--bg-primary);
    color: var(--primary-color);
    box-shadow: 0 4px 6px rgba(0,0,0,0.15);
}
/* Position the menu for options */
.options-btn-container .dropdown-menu {
    top: 110%;
    right: 0; /* Align right edge */
    left: auto;
}
/* Spacer for alignment when options button is missing in list view */
.options-spacer {
    width: 36px;
    height: 36px;
    flex-shrink: 0;
}

/* ------------------------------------------------------ */
/* EVENT DETAIL MODAL – ATTENDEE LIST */
/* ------------------------------------------------------ */
#detailAttendeeList {
    margin-top: 1.5rem;
}
#detailAttendeeList h4 {
    font-size: 1.25rem;
    color: var(--text-primary);
    border-bottom: 1px solid var(--border-color);
    padding-bottom: 0.5rem;
    margin-bottom: 1rem;
}
.attendee-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem 0;
    border-bottom: 1px solid var(--border-color);
}
.attendee-item:last-child {
    border-bottom: none;
}
.attendee-item a {
    font-weight: 600;
    color: var(--text-primary);
    text-decoration: none;
}
.attendee-item a:hover {
    color: var(--primary-color);
    text-decoration: underline;
}
.attendee-item .rsvp-status {
    font-size: 0.875rem;
    color: var(--text-light);
    text-transform: capitalize;
}
.attendee-item .rsvp-status.going {
    color: #38a169;
}

/* ------------------------------------------------------ */
/* CONTROL BAR (Search, Filters, View Buttons) */
/* ------------------------------------------------------ */
.event-hub-controls {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 2rem;
    flex-wrap: nowrap;
}

/* Normalize control button heights */
.search-filter-group > input[type="date"],
.search-filter-group > .action-btn,
.view-toggle-buttons > .action-btn {
    padding-top: 0.65rem;
    padding-bottom: 0.65rem;
    box-sizing: border-box;
}

/* Reset button icon centering */
#resetFiltersBtn {
    display: flex;
    align-items: center;
    justify-content: center;
}

/* ------------------------------------------------------ */
/* DELETE CONFIRMATION MODAL */
/* ------------------------------------------------------ */
.modal-overlay {
    display: none;
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 2000;
    align-items: center;
    justify-content: center;
}
.modal-overlay.open {
    display: flex;
}
.confirm-box {
    background: var(--bg-primary);
    padding: 2rem;
    border-radius: var(--radius-lg);
    max-width: 400px;
    width: 90%;
    text-align: center;
    box-shadow: var(--shadow-xl);
}
.confirm-box h3 { margin-bottom: 1rem; color: var(--text-primary); }
.confirm-box p { color: var(--text-secondary); margin-bottom: 1.5rem; }
.confirm-actions {
    display: flex;
    gap: 1rem;
    justify-content: center;
}
/* Specific button styles for confirmation */
.confirm-actions .btn-cancel {
    background: var(--gradient-primary);
    color: white;
    border: none;
    padding: 0.5rem 1.5rem;
    border-radius: var(--radius-md);
    cursor: pointer;
    font-weight: 500;
}
.confirm-actions .btn-delete {
    background: transparent;
    border: 1px solid #e53e3e;
    color: #e53e3e;
    padding: 0.5rem 1.5rem;
    border-radius: var(--radius-md);
    cursor: pointer;
}
.confirm-actions .btn-delete:hover {
    background: #fff5f5;
}

/* ------------------------------------------------------ */
/* EVENT DETAIL MODAL - Using same structure as delete modal */
/* ------------------------------------------------------ */
#eventDetailModal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.6);
    z-index: 3000;
    align-items: center;
    justify-content: center;
}

#eventDetailModal.open {
    display: flex;
}

.event-detail-box {
    background: var(--bg-primary);
    padding: 2rem;
    border-radius: var(--radius-lg);
    max-width: 700px;
    width: 90%;
    max-height: 85vh;
    overflow-y: auto;
    box-shadow: var(--shadow-xl);
    position: relative;
    animation: modalSlideIn 0.3s ease-out;
}

@keyframes modalSlideIn {
    from {
        opacity: 0;
        /* transform: translateY(-20px) scale(0.95); */
    }
    to {
        opacity: 1;
        /* transform: translateY(0) scale(1); */
    }
}

.detail-close {
    position: absolute;
    top: 1rem;
    right: 1rem;
    background: var(--bg-tertiary);
    border: 1px solid var(--border-color);
    border-radius: 50%;
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 1.5rem;
    color: var(--text-secondary);
    transition: all 0.2s;
    z-index: 10;
    line-height: 1;
    padding: 0;
}

.detail-close:hover {
    background: var(--bg-primary);
    color: var(--primary-color);
    transform: rotate(90deg);
}

.event-detail-box h3 {
    font-size: 1.75rem;
    color: var(--text-primary);
    margin-bottom: 1rem;
    padding-right: 2rem;
}

.modal-meta-row {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 0.75rem;
    color: var(--text-secondary);
    font-size: 1rem;
}

.modal-meta-row svg {
    flex-shrink: 0;
    color: var(--primary-color);
}

.modal-meta-row .map-link {
    margin-left: 0.5rem;
    color: var(--primary-color);
    text-decoration: none;
    font-weight: 500;
}

.modal-meta-row .map-link:hover {
    text-decoration: underline;
}

#detailDescription {
    margin: 1.5rem 0;
    color: var(--text-primary);
    line-height: 1.6;
    font-size: 1rem;
    word-wrap: break-word;
    overflow-wrap: break-word;
}

#detailActions {
    margin-top: 1.5rem;
    padding-top: 1.5rem;
    border-top: 1px solid var(--border-color);
}

/* Mobile responsiveness */
@media (max-width: 768px) {
    .event-detail-box {
        max-width: 95%;
        max-height: 90vh;
        padding: 1.5rem;
    }
    
    .event-detail-box h3 {
        font-size: 1.5rem;
    }
}

/* ------------------------------------------------------ */
/* LIST VIEW */
/* ------------------------------------------------------ */
#eventListView .app-event-card {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 1rem;
    position: relative;      /* for absolute dropdown positioning */
    overflow: visible;      /* important: let dropdown escape */
    margin-bottom: 0.7rem;   /* Added spacing between cards */
}

#eventListView .app-event-card:has(.dropdown-menu.open) {
    z-index: 100;            /* Raise card when dropdown is open */
}

#eventListView .event-content {
    flex: 1 1 auto;      /* content takes remaining space */
    min-width: 0;  /* allows text to wrap/truncate without overflow */
}

/* Buttons container */
#eventListView .event-actions {
    display: flex;
    flex-direction: row;     /* Changed from column to row */
    gap: 0.75rem;            /* Horizontal gap between RSVP and options */
    flex-shrink: 0;          /* prevent buttons from shrinking */
    align-items: center;     /* Vertically center buttons */
}

/* Button sizing */
#eventListView .event-actions .action-btn,
#eventListView .rsvp-btn {
    width: 140px;
    height: 42px;
    line-height: 42px;
    display: flex;
    align-items: center;
    justify-content: center;
    white-space: nowrap;
    flex-shrink: 0;
    padding: 0 1rem !important;
}

/* Primary / Going states */
#eventListView .rsvp-btn.primary {
    background: var(--gradient-primary);
    color: white;
    box-shadow: var(--shadow-md);
}
#eventListView .rsvp-btn.primary:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
}
#eventListView .rsvp-btn.is-going {
    background: var(--primary-dark);
    color: white;
    border-color: var(--primary-dark);
}
#eventListView .rsvp-btn.is-going:hover {
    background: var(--primary-color);
}

/* Ensure RSVP dropdown matches button width */
#eventListView .rsvp-btn-container {
    width: 140px;
    position: relative;  /* dropdown is absolute inside this */
}
#eventListView .rsvp-btn-menu {
    position: absolute;
    left: 0;
    width: 140px;
    min-width: 140px;
    background: var(--bg-primary);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-lg);
    z-index: 999;          /* ensure dropdown is above other content */
    overflow: visible;     /* don’t clip options */
}
/* Fix RSVP dropdown to match button width in list view */
#eventListView .rsvp-btn-container .dropdown-menu {
    width: 140px;
    min-width: 140px;
}

/* (NEW) Ensure options button container is positioned correctly in list */
#eventListView .options-btn-container {
    position: relative; 
}

/* ------------------------------------------------------ */
/* GRID VIEW - CARD LAYOUT FIX */
/* ------------------------------------------------------ */
#eventCardsView .app-event-card {
    display: flex;
    flex-direction: column;
    height: 100%; /* Ensure card takes full height of grid cell */
}

#eventCardsView .event-content {
    display: flex;
    flex-direction: column;
    flex-grow: 1; /* Allow content to expand */
}

#eventCardsView .event-info-wrapper {
    flex-grow: 0; /* Don't let this section expand */
}

#eventCardsView .event-meta-wrapper {
    flex-grow: 0; /* Don't let this section expand */
}

#eventCardsView .event-actions-wrapper {
    margin-top: auto; /* Push to bottom */
    padding-top: 1rem; /* Add some spacing */
}

#eventCardsView .event-actions {
    display: flex;
    gap: 0.75rem;
    width: 100%;
}

/* ------------------------------------------------------ */
/* RESPONSIVE LAYOUT FIXES */
/* ------------------------------------------------------ */
@media (max-width: 1200px) {
    .event-hub-controls {
        flex-wrap: wrap;
        gap: 0.75rem;
    }
    .search-filter-group {
        flex: 1 1 100%;
        order: 1;
    }
    .view-toggle-buttons {
        order: 2;
        width: 100%;
        justify-content: flex-end;
    }
}

@media (max-width: 992px) {
    .event-hub-controls {
        flex-wrap: wrap;
        gap: 0;
    }
    .search-filter-group {
        min-width: 100% !important;
        order: 1;
        flex-wrap: wrap;
        gap: 0.5rem;
    }
    .search-filter-group > input[type="text"] {
        width: 100%;
        min-width: 0;
        order: 1;
    }
    .search-filter-group > input[type="date"],
    .search-filter-group > #resetFiltersBtn,
    .search-filter-group > .filter-toggle-switch {
        flex-grow: 1;
        order: 2;
    }
    .view-toggle-buttons {
        order: 2;
        width: 100%;
        justify-content: flex-end;
        margin-top: 0.5rem;
    }
}

/* FORCE MODAL POSITIONING - Add at the very end of styles */
#eventDetailModal.modal-overlay.open,
#deleteConfirmModal.modal-overlay.open {
    display: flex !important;
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    right: 0 !important;
    bottom: 0 !important;
    width: 100vw !important;
    height: 100vh !important;
    align-items: center !important;
    justify-content: center !important;
    z-index: 9999 !important;
    margin: 0 !important;
    padding: 0 !important;
}

.event-detail-box,
.confirm-box {
    position: relative !important;
    margin: auto !important;
}

</style>

<div class="event-hub-container page-content-wrapper page-transition-enter-active">
    <div class="event-hub-header">
        <h2>Event Hub</h2>
        <p>Explore, filter, and plan your events.</p>
    </div>

    <div class="event-hub-controls">
        <div class="search-filter-group" style="flex-grow: 1; min-width: 250px;">
            <input type="text" id="eventSearchInput" placeholder="Search event titles..." title="Search" style="flex-grow: 1;">
            <input type="date" id="eventDateFilter" title="Filter by date">
            <button class="action-btn secondary" id="resetFiltersBtn" title="Reset Filters">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2.5 2v6h6M21.5 22v-6h-6"></path><path d="M22 11.5A10 10 0 0 0 3.2 7.2M2 12.5a10 10 0 0 0 18.8 4.3"></path></svg>
            </button>

            <div class="filter-toggle-switch" id="rsvpFilterContainer" style="display: none;">
                <label for="myRsvpsFilter">My RSVPs</label>
                <input type="checkbox" id="myRsvpsFilter" />
            </div>

            <div class="filter-toggle-switch" id="privateFilterContainer">
                <label for="privateEventsFilter">Private Only</label>
                <input type="checkbox" id="privateEventsFilter" />
            </div>
        </div>
        
        <div class="view-toggle-buttons">
            <button class="action-btn primary active" data-view="cards" id="cardsViewBtn" title="Card View"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg></button>
            <button class="action-btn secondary" data-view="list" id="listViewBtn" title="List View"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></svg></button>
            <button class="action-btn secondary" data-view="calendar" id="calendarViewBtn" title="Calendar View"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg></button>
        </div>
    </div>
    
    <div id="eventCardsView" class="app-events-grid"></div>
    <div id="eventListView" class="app-events-list" style="display: none;"></div>
    <div id="eventCalendarView" class="calendar-view-wrapper" style="display: none; background: var(--bg-secondary); padding: 1.5rem; border-radius: var(--radius-lg); border: 1px solid var(--border-color);">
        <div id="calendar"></div>
    </div>
</div>

<script type="module">
import { api } from "../js/api.js";
import { getRoleFromToken, token } from "../js/app.js";

// --- CREATE AND INJECT MODALS INTO BODY ---
function createModals() {
    // Remove existing modals if any (Handles re-entry)
    const existingDetail = document.getElementById('eventDetailModal');
    const existingDelete = document.getElementById('deleteConfirmModal');
    if (existingDetail) existingDetail.remove();
    if (existingDelete) existingDelete.remove();

    // Event Detail Modal
    const detailModal = document.createElement('div');
    detailModal.id = 'eventDetailModal';
    detailModal.className = 'modal-overlay';
    detailModal.style.display = 'none'; 
    detailModal.innerHTML = `
        <div class="event-detail-box">
            <button class="detail-close" id="closeDetailModal">×</button>
            <h3 id="detailTitle"></h3>
            <div class="modal-meta-row">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                    <line x1="16" y1="2" x2="16" y2="6"></line>
                    <line x1="8" y1="2" x2="8" y2="6"></line>
                    <line x1="3" y1="10" x2="21" y2="10"></line>
                </svg>
                <span id="detailDate"></span>
            </div>
            <div class="modal-meta-row">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                    <circle cx="12" cy="10" r="3"></circle>
                </svg>
                <span id="detailLocation"></span>
                <span id="detailMapLink"></span>
            </div>
            <p id="detailDescription"></p>
            <div id="detailActions" class="event-actions"></div>
            <div id="detailAttendeeList"></div>
        </div>
    `;
    document.body.appendChild(detailModal);

    // Delete Confirmation Modal
    const deleteModal = document.createElement('div');
    deleteModal.id = 'deleteConfirmModal';
    deleteModal.className = 'modal-overlay';
    deleteModal.style.display = 'none';
    deleteModal.innerHTML = `
        <div class="confirm-box">
            <h3>Delete Event?</h3>
            <p>Are you sure you want to delete this event? This action cannot be undone.</p>
            <div class="confirm-actions">
                <button id="cancelDeleteBtn" class="btn-cancel">Cancel</button>
                <button id="confirmDeleteBtn" class="btn-delete">Delete</button>
            </div>
        </div>
    `;
    document.body.appendChild(deleteModal);
}

// Create modals immediately
createModals();

// --- CLEANUP LOGIC (FIX for lingering modals) ---
// Detect when the "Event Hub" view is removed from the DOM and remove the body-attached modals.
const eventHubContainer = document.querySelector('.event-hub-container');
if (eventHubContainer) {
    const observer = new MutationObserver((mutations) => {
        if (!document.body.contains(eventHubContainer)) {
            // The container is gone, so we must remove the global modals we created
            const dModal = document.getElementById('eventDetailModal');
            const delModal = document.getElementById('deleteConfirmModal');
            if (dModal) dModal.remove();
            if (delModal) delModal.remove();
            observer.disconnect(); // Stop watching
        }
    });
    
    // Watch the body for structural changes (e.g. page navigation/swapping)
    observer.observe(document.body, { childList: true, subtree: true });
}

const cardsView = document.getElementById("eventCardsView");
const listView = document.getElementById("eventListView");
const calendarView = document.getElementById("eventCalendarView");
const viewButtons = document.querySelectorAll(".view-toggle-buttons .action-btn");
const searchInput = document.getElementById("eventSearchInput");
const dateFilter = document.getElementById("eventDateFilter");
const resetFiltersBtn = document.getElementById("resetFiltersBtn");

// Filters
const rsvpFilterContainer = document.getElementById("rsvpFilterContainer");
const rsvpFilterCheckbox = document.getElementById("myRsvpsFilter");
const privateFilterCheckbox = document.getElementById("privateEventsFilter");

// Delete Modal - Get references after creation
let deleteModal, cancelDeleteBtn, confirmDeleteBtn;
let eventIdToDelete = null;

function initializeModalReferences() {
    deleteModal = document.getElementById("deleteConfirmModal");
    cancelDeleteBtn = document.getElementById("cancelDeleteBtn");
    confirmDeleteBtn = document.getElementById("confirmDeleteBtn");
    
    if (deleteModal && cancelDeleteBtn) {
        // Attach event listeners
        cancelDeleteBtn.addEventListener('click', () => {
            deleteModal.classList.remove('open');
            // Also hide via inline style to match creation logic
            deleteModal.style.display = 'none';
            eventIdToDelete = null;
        });

        confirmDeleteBtn.addEventListener('click', async () => {
            if(!eventIdToDelete) return;
            
            confirmDeleteBtn.textContent = "Deleting...";
            confirmDeleteBtn.disabled = true;

            try {
                await api(`/events/${eventIdToDelete}`, "DELETE", null, token);
                deleteModal.classList.remove('open');
                deleteModal.style.display = 'none';
                closeDetailModal();
                loadEvents();
            } catch (err) {
                console.error("Delete failed", err);
            } finally {
                confirmDeleteBtn.textContent = "Delete";
                confirmDeleteBtn.disabled = false;
                eventIdToDelete = null;
            }
        });
    }
}

// Initialize after modals are created
initializeModalReferences();

let allEvents = [];
let currentEvents = [];
let currentView = "cards";
const userRole = getRoleFromToken();
const userId = token ? JSON.parse(atob(token.split('.')[1])).sub : null; 

// Show RSVP filter only if logged in
if (userId) {
    rsvpFilterContainer.style.display = 'flex';
}

// --- Helper Functions ---

function getEventLocation(event) {
    if (event.location_type === 'custom') {
        return event.custom_location_address || 'Location TBA';
    }
    if (event.location_type === 'venue') {
        let name = event.venue_name || 'On-Campus Venue';
        let building = event.venue_building || '';
        let room = event.venue_room || event.venue_room_number || '';
        
        if (building && room) return `${name} (${building}, ${room})`;
        if (building) return `${name} (${building})`;
        return name;
    }
    return 'Location TBA';
}

function getMapLink(event) {
    if (event.google_maps_link) {
        return `<a href="${event.google_maps_link}" target="_blank" class="map-link" onclick="event.stopPropagation()">View Map</a>`;
    }
    const location = getEventLocation(event);
    if (location && location !== 'Location TBA' && location !== 'On-Campus Venue') {
        const encodedLocation = encodeURIComponent(location);
        return `<a href="https://www.google.com/maps/search/?api=1&query=${encodedLocation}" target="_blank" class="map-link" onclick="event.stopPropagation()">Search on Map</a>`;
    }
    return '';
}

// --- COMPONENT: RSVP Button ---
class RsvpBtn {
    constructor(event, onRsvp) {
        this.event = event;
        this.status = event.my_rsvp_status; 
        this.onRsvp = onRsvp; 
        
        this.container = document.createElement('div');
        this.container.className = 'rsvp-btn-container';
        
        this.button = this.createButton();
        this.menu = this.createMenu();
        
        this.container.appendChild(this.button);
        this.container.appendChild(this.menu);
        
        this.button.addEventListener('click', (e) => {
            e.stopPropagation();
            this.toggleMenu();
        });
        
        // Close menu if clicking outside
        document.addEventListener('click', (e) => {
            if (!this.container.contains(e.target)) {
                this.closeMenu();
            }
        });
        return this.container;
    }

    createButton() {
        const btn = document.createElement('button');
        btn.className = 'action-btn primary rsvp-btn';
        this.updateButtonState(btn, this.status);
        return btn;
    }
    
    updateButtonState(buttonEl, status) {
        buttonEl.classList.remove('is-going', 'secondary');
        buttonEl.classList.add('primary'); 
        
        let text = 'RSVP';
        if (status === 'going') {
            text = '✓ Going';
            buttonEl.classList.add('is-going');
        } else if (status === 'maybe') {
            text = '? Maybe';
            buttonEl.classList.replace('primary', 'secondary');
        } else if (status === 'canceled') {
            text = '✕ Can\'t Go';
            buttonEl.classList.replace('primary', 'secondary');
        }
        
        buttonEl.innerHTML = `<span>${text}</span>`; 
    }
    
    createMenu() {
        const menu = document.createElement('div');
        // Reuse common dropdown styling
        menu.className = 'dropdown-menu';
        
        menu.innerHTML = `
            <button data-status="going">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M20 6 9 17l-5-5"></path></svg>
                <span>Going</span>
            </button>
            <button data-status="maybe">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
                <span>Maybe</span>
            </button>
            <button data-status="canceled">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                <span>Can't Go</span>
            </button>
            <button data-status="clear" class="clear-rsvp">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><path d="m15 9-6 6"></path><path d="m9 9 6 6"></path></svg>
                <span>Clear RSVP</span>
            </button>
        `;
        
        menu.querySelectorAll('button').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                const newStatus = e.currentTarget.dataset.status === 'clear' ? null : e.currentTarget.dataset.status;
                this.handleRsvpClick(newStatus);
            });
        });
        return menu;
    }
    
    async handleRsvpClick(newStatus) {
        this.button.disabled = true;
        this.button.innerHTML = `<span>Saving...</span>`;
        
        try {
            const res = await api(`/events/${this.event.event_id}/rsvp`, "POST", { status: newStatus }, token);
            
            if (res.status === (newStatus || "cleared")) {
                this.status = newStatus;
                this.event.my_rsvp_status = newStatus; 
                this.updateButtonState(this.button, newStatus);
                if (this.onRsvp) this.onRsvp();
            }
        } catch (err) {
            console.error("RSVP failed", err);
            this.updateButtonState(this.button, this.status); 
        } finally {
            this.button.disabled = false;
            this.closeMenu();
        }
    }
    
    toggleMenu() {
        document.querySelectorAll('.rsvp-btn-container .dropdown-menu.open, .options-btn-container .dropdown-menu.open').forEach(menu => {
            if (menu !== this.menu) menu.classList.remove('open');
        });
        this.menu.classList.toggle('open');
    }
    
    closeMenu() {
        this.menu.classList.remove('open');
    }
}

// --- COMPONENT: Options (Edit/Delete) Button ---
class EventOptionsBtn {
    constructor(event) {
        this.event = event;
        this.container = document.createElement('div');
        this.container.className = 'options-btn-container';
        
        // Button
        this.btn = document.createElement('button');
        this.btn.className = 'options-toggle-btn';
        this.btn.innerHTML = `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="1"></circle><circle cx="19" cy="12" r="1"></circle><circle cx="5" cy="12" r="1"></circle></svg>`;
        this.btn.title = "Options";
        
        // Menu
        this.menu = document.createElement('div');
        this.menu.className = 'dropdown-menu';
        this.menu.innerHTML = `
            <button class="edit-option">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                <span>Edit</span>
            </button>
            <button class="delete-option">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                <span>Delete</span>
            </button>
        `;
        
        this.container.appendChild(this.btn);
        this.container.appendChild(this.menu);
        
        // Handlers
        this.btn.addEventListener('click', (e) => {
            e.stopPropagation();
            this.toggleMenu();
        });

        this.menu.querySelector('.edit-option').addEventListener('click', (e) => {
            e.stopPropagation();
            window.location.hash = `#/event-form?id=${this.event.event_id}`;
        });

        this.menu.querySelector('.delete-option').addEventListener('click', (e) => {
            e.stopPropagation();
            this.closeMenu();
            openDeleteModal(this.event.event_id);
        });

        // Global click to close
        document.addEventListener('click', (e) => {
            if (!this.container.contains(e.target)) {
                this.closeMenu();
            }
        });

        return this.container;
    }

    toggleMenu() {
        document.querySelectorAll('.rsvp-btn-container .dropdown-menu.open, .options-btn-container .dropdown-menu.open').forEach(menu => {
            if (menu !== this.menu) menu.classList.remove('open');
        });
        this.menu.classList.toggle('open');
    }
    closeMenu() {
        this.menu.classList.remove('open');
    }
}

// --- Delete Logic ---
function openDeleteModal(id) {
    eventIdToDelete = id;
    deleteModal.classList.add('open');
    deleteModal.style.display = 'flex';
}

/**
 * Shows the custom event detail modal.
 */
async function showDetailModal(event) {
    if (!event) return;
    const modal = document.getElementById('eventDetailModal');
    modal.classList.add('open');
    modal.style.display = 'flex';
    
    document.getElementById('detailTitle').textContent = event.title;
    
    // --- TIME FORMATTING ---
    const start = new Date(event.start_time);
    const end = event.end_time ? new Date(event.end_time) : null;
    
    const dateStr = start.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });
    const startTimeStr = start.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
    
    let timeDisplay = `${dateStr} at ${startTimeStr}`;
    
    if (end) {
        const endDateStr = end.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });
        const endTimeStr = end.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
        
        if (dateStr === endDateStr) {
            // Same day: "Friday, January 1, 2024, 10:00 AM – 12:00 PM"
            timeDisplay = `${dateStr}, ${startTimeStr} – ${endTimeStr}`;
        } else {
            // Different day: "Friday... 10:00 AM – Saturday... 10:00 AM"
            timeDisplay = `${dateStr}, ${startTimeStr} – ${endDateStr}, ${endTimeStr}`;
        }
    }
    document.getElementById('detailDate').textContent = timeDisplay;
    // ---------------------------------------------

    document.getElementById('detailLocation').textContent = getEventLocation(event);
    
    // Add map link
    const mapLinkContainer = document.getElementById('detailMapLink');
    const mapLink = getMapLink(event);
    mapLinkContainer.innerHTML = mapLink;
    
    document.getElementById('detailDescription').textContent = event.description || 'No description provided.';

    const detailActions = document.getElementById('detailActions');
    const attendeeListDiv = document.getElementById('detailAttendeeList');
    detailActions.innerHTML = '';
    attendeeListDiv.innerHTML = ''; 

    // Check permissions
    const isOrganizer = userRole === 'admin' || (event.organizer_id === userId) || (event.created_by === userId);

    if (userId) {
        const rsvpContainer = new RsvpBtn(event, () => {
            // If filtering by RSVPs, re-apply filters to possibly remove/add event from view
            if (rsvpFilterCheckbox.checked) {
                applyFilters();
            } else {
                // Otherwise, just refresh the view to show the new button state on the card
                switchView(currentView);
            }
        });
        detailActions.appendChild(rsvpContainer);
    }
    
    if (isOrganizer) {
        // Use the Options Button instead of just Edit
        const optionsComponent = new EventOptionsBtn(event);
        // Style tweaks for modal placement if needed
        detailActions.appendChild(optionsComponent);
        
        // Load attendees
        attendeeListDiv.innerHTML = '<h4>Attendees</h4><div class="loading">Loading attendees...</div>';
        try {
            const attendees = await api(`/events/${event.event_id}/rsvps`, "GET", null, token);
            if (attendees && attendees.length > 0) {
                attendeeListDiv.innerHTML = '<h4>Attendees</h4>' + attendees.map(att => `
                    <div class="attendee-item">
                        <a href="#/profile-view?id=${att.user_id}" target="_blank">${att.first_name || ''} ${att.last_name || att.email}</a>
                        <span class="rsvp-status ${att.rsvp_status}">${att.rsvp_status}</span>
                    </div>
                `).join('');
            } else {
                attendeeListDiv.innerHTML = '<h4>Attendees</h4><p>No one has RSVP\'d yet.</p>';
            }
        } catch (err) {
            attendeeListDiv.innerHTML = `<h4>Attendees</h4><p class="error-message">Could not load attendee list.</p>`;
        }
    }
}

function closeDetailModal() {
    const modal = document.getElementById('eventDetailModal');
    modal.classList.remove('open');
    modal.style.display = 'none';
}

document.addEventListener('DOMContentLoaded', () => {
    const closeBtn = document.getElementById('closeDetailModal');
    if (closeBtn) {
        closeBtn.addEventListener('click', closeDetailModal);
    }
});

// Also add listener after modal is created
setTimeout(() => {
    const closeBtn = document.getElementById('closeDetailModal');
    if (closeBtn) {
        closeBtn.addEventListener('click', closeDetailModal);
    }
    
    // Close modal when clicking outside
    const modal = document.getElementById('eventDetailModal');
    if (modal) {
        modal.addEventListener('click', (e) => {
            if (e.target.id === 'eventDetailModal') {
                closeDetailModal();
            }
        });
    }
}, 100);

// --- Event Rendering ---

function renderEvents(events, isList = false) {
    const container = isList ? listView : cardsView;
    const listClass = isList ? 'list-card-style' : '';
    
    if (events.length === 0) {
        const emptyStateHTML = `
            <div class="empty-state" style="grid-column: 1 / -1; ${isList ? 'max-width: 100%;' : ''}">
                <h3>No Events Found</h3>
                <p>Try adjusting your search or date filters.</p>
            </div>
        `;
        container.innerHTML = emptyStateHTML;
        return;
    }

    container.innerHTML = events.map(event => {
        const startDate = new Date(event.start_time);
        const formattedDate = startDate.toLocaleString('en-US', { 
            weekday: 'short', month: 'short', day: 'numeric', year: 'numeric'
        });
        const formattedTime = startDate.toLocaleTimeString('en-US', {
            hour: 'numeric', minute: '2-digit'
        });

        const locationText = getEventLocation(event);
        const mapLinkHtml = getMapLink(event);
        
        let actionButtons = '';        // For RSVP
        let optionsPlaceholder = ''; // For '...' button in BOTH views
        
        const canEdit = userRole === 'admin' || (event.organizer_id === userId) || (event.created_by === userId);

        // 1. RSVP Button (all views)
        if (userId) {
            actionButtons += `<div class="rsvp-btn-placeholder" data-event-id="${event.event_id}"></div>`;
        } else {
            actionButtons += `<button class="action-btn primary" disabled title="Log in to RSVP">RSVP</button>`;
        }

        // 2. Options Button (all views)
        if (canEdit) {
            optionsPlaceholder = `<div class="options-btn-placeholder" data-event-id="${event.event_id}"></div>`;
        } else if (isList) {
            // Empty placeholder spacer to maintain alignment in List View
            optionsPlaceholder = `<div class="options-spacer"></div>`;
        }

        const eventId = event.event_id;
        const visibilityBadge = event.visibility === 'private' 
            ? `<span class="status-badge" style="background: #E2E8F0; color: #4A5568;">Private</span>`
            : `<span class="status-badge upcoming">Public</span>`;

        // For Card View, options usually go top-right relative to card
        // For List View, they might go in the action column
        
        let cardContent = `
            <article class="app-event-card ${listClass}" data-event-id="${eventId}">
                ${!isList ? `<div class="card-options-wrapper" style="position: absolute; top: 10px; right: 10px; z-index: 5;">${optionsPlaceholder}</div>` : ''}

                <div class="event-image">${event.title.charAt(0)}</div>
                <div class="event-content">
                    <div class="event-info-wrapper">
                        <h3>${event.title}</h3>
                        <div class="event-date">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="flex-shrink: 0;">
                                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                                <line x1="16" y1="2" x2="16" y2="6"></line>
                                <line x1="8" y1="2" x2="8" y2="6"></line>
                                <line x1="3" y1="10" x2="21" y2="10"></line>
                            </svg>
                            ${formattedDate} at ${formattedTime}
                            <div> ${visibilityBadge}</div>
                        </div>                        

                        ${event.description ? `<p class="event-description">${event.description}</p>` : ''}
                    </div>
                    
                    <div class="event-meta-wrapper">
                        <div class="event-meta">
                            <div class="event-location-group">
                                <span class="event-location">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="flex-shrink: 0;">
                                        <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                                        <circle cx="12" cy="10" r="3"></circle>
                                    </svg>
                                    ${locationText}
                                </span>
                                ${mapLinkHtml}
                            </div>
                        </div>
                    </div>

                    <div class="event-actions-wrapper">
                        <div class="event-actions">
                            ${actionButtons}
                            ${isList ? optionsPlaceholder : ''}
                        </div>
                    </div>
                </div>
            </article>
        `;
        return cardContent;
    }).join("");

    // --- Attach Live Components ---

    // 1. RSVP Buttons
    container.querySelectorAll('.rsvp-btn-placeholder').forEach(placeholder => {
        const eventId = placeholder.dataset.eventId;
        const event = allEvents.find(e => e.event_id == eventId);
        if (event) {
            const rsvpComponent = new RsvpBtn(event, () => {
                if (rsvpFilterCheckbox.checked) applyFilters();
                if(currentView === 'calendar') renderCalendar(currentEvents);
            });
            placeholder.replaceWith(rsvpComponent);
        }
    });

    // 2. Options (Edit/Delete) Buttons
    container.querySelectorAll('.options-btn-placeholder').forEach(placeholder => {
        const eventId = placeholder.dataset.eventId;
        const event = allEvents.find(e => e.event_id == eventId);
        if (event) {
            const optionsComponent = new EventOptionsBtn(event);
            placeholder.replaceWith(optionsComponent);
        }
    });

    // Click to Open Detail Modal
    container.querySelectorAll('.app-event-card').forEach(card => {
        card.addEventListener('click', (e) => {
            // Ignore clicks inside buttons/dropdowns
            if (e.target.closest('.action-btn') || e.target.closest('a') || e.target.closest('.rsvp-btn-container') || e.target.closest('.options-btn-container')) {
                return;
            }
            const eventId = e.currentTarget.dataset.eventId;
            const eventData = allEvents.find(e => e.event_id == eventId);
            showDetailModal(eventData);
        });
    });
}

// --- Calendar Functionality ---

function normalizeDateTime(dt) {
    if (!dt && dt !== 0) return null;
    if (dt instanceof Date) return dt.toISOString();
    if (typeof dt === 'number') {
        if (String(dt).length <= 10) dt = dt * 1000;
        return new Date(dt).toISOString();
    }
    if (typeof dt === 'string') {
        const trimmed = dt.trim();
        if (/^\d{4}-\d{2}-\d{2}$/.test(trimmed)) return `${trimmed}T00:00:00Z`;
        if (/^\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}/.test(trimmed)) return trimmed.replace(' ', 'T') + 'Z';
        const parsed = new Date(trimmed);
        if (!isNaN(parsed.getTime())) return parsed.toISOString();
        return trimmed;
    }
    return null;
}

let fcCalendar = null;

function renderCalendar(events) {
    const calendarEl = document.getElementById('calendar');
    const calendarEvents = events.map(e => ({
        title: e.title,
        start: normalizeDateTime(e.start_time),
        end: normalizeDateTime(e.end_time),
        extendedProps: e,
        backgroundColor: e.my_rsvp_status === 'going' ? '#38a169' : (e.visibility === 'private' ? '#5568d3' : '#667eea'),
        borderColor: e.my_rsvp_status === 'going' ? '#2f855a' : (e.visibility === 'private' ? '#4a5568' : '#5568d3')
    }));

    if (!fcCalendar) {
        fcCalendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek,timeGridDay,listWeek'
            },
            height: 'auto',
            aspectRatio: 1.8,
            events: calendarEvents,
            eventClick: function(info) {
                info.jsEvent.preventDefault();
                showDetailModal(info.event.extendedProps);
            }
        });
        fcCalendar.render();
    } else {
        fcCalendar.removeAllEvents();
        fcCalendar.addEventSource(calendarEvents);
    }
}

// --- Initialization ---

async function loadEvents() {
    try {
        const events = await api("/events/", "GET", null, token);
        if (!Array.isArray(events)) throw new Error("API did not return an array.");
        
        allEvents = events.sort((a, b) => new Date(a.start_time) - new Date(b.start_time));
        currentEvents = [...allEvents];
        
        // Initial render based on currentView (default 'cards')
        switchView(currentView); 
    } catch (err) {
        console.error("Failed to load events:", err);
        cardsView.innerHTML = '<p class="error-message">Unable to load events. Please try again later.</p>';
    }
}

function applyFilters() {
    const searchTerm = searchInput.value.toLowerCase();
    const filterDate = dateFilter.value;
    const showMyRsvps = rsvpFilterCheckbox.checked;
    const showPrivateOnly = privateFilterCheckbox.checked;

    currentEvents = allEvents.filter(event => {
        // 1. Text Match
        const titleMatch = event.title.toLowerCase().includes(searchTerm);
        const descMatch = (event.description || "").toLowerCase().includes(searchTerm);
        const matchesText = !searchTerm || titleMatch || descMatch;

        // 2. Date Match
        let matchesDate = true;
        if (filterDate) {
            const evtDate = new Date(event.start_time).toISOString().split('T')[0];
            matchesDate = evtDate === filterDate;
        }
        
        // 3. RSVP Filter
        let matchesRsvp = true;
        if (showMyRsvps) {
            matchesRsvp = (event.my_rsvp_status === 'going' || event.my_rsvp_status === 'maybe');
        }

        // 4. Private Filter
        let matchesPrivate = true;
        if (showPrivateOnly) {
            matchesPrivate = (event.visibility === 'private');
        }

        return matchesText && matchesDate && matchesRsvp && matchesPrivate;
    });

    switchView(currentView);
}

function switchView(viewName) {
    currentView = viewName;
    
    // Update active button state logic
    viewButtons.forEach(btn => {
        if (btn.dataset.view === viewName) {
            btn.classList.add("active");
            btn.classList.remove("secondary");
            btn.classList.add("primary");
        } else {
            btn.classList.remove("active");
            btn.classList.remove("primary");
            btn.classList.add("secondary");
        }
    });

    // Hide all views first
    cardsView.style.display = "none";
    listView.style.display = "none";
    calendarView.style.display = "none";

    if (viewName === "cards") {
        cardsView.style.display = "grid";
        renderEvents(currentEvents, false);
    } else if (viewName === "list") {
        listView.style.display = "block";
        renderEvents(currentEvents, true);
    } else if (viewName === "calendar") {
        calendarView.style.display = "block";
        renderCalendar(currentEvents);
        setTimeout(() => { if(fcCalendar) fcCalendar.updateSize(); }, 100);
    }
}

// --- Event Listeners ---

searchInput.addEventListener('input', applyFilters);
dateFilter.addEventListener('change', applyFilters);
rsvpFilterCheckbox.addEventListener('change', applyFilters);
privateFilterCheckbox.addEventListener('change', applyFilters);

resetFiltersBtn.addEventListener('click', () => {
    searchInput.value = '';
    dateFilter.value = '';
    rsvpFilterCheckbox.checked = false;
    privateFilterCheckbox.checked = false;
    currentEvents = [...allEvents];
    applyFilters();
});

viewButtons.forEach(btn => {
    btn.addEventListener("click", () => {
        switchView(btn.dataset.view);
    });
});

// Start
loadEvents();

</script>