<style>
    .profile-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
    }
    .grid-col-span-2 {
        grid-column: span 2 / span 2;
    }
    .profile-callout {
        background: var(--bg-tertiary);
        border: 1px solid var(--border-color);
        padding: 1.5rem;
        border-radius: var(--radius-lg);
        margin-bottom: 2rem;
        display: none; /* Hidden by default */
    }
    .profile-callout h3 {
        color: var(--text-primary);
        margin-bottom: 0.5rem;
    }
    .profile-callout p {
        color: var(--text-secondary);
    }
    label {
        display: block; 
        margin-bottom: 0.5rem; 
        color: var(--text-secondary); 
        font-size: 0.875rem;
        font-weight: 500;
    }
    input, textarea {
        width: 100%; 
        padding: 0.875rem 1rem; 
        margin-bottom: 1rem; 
        border: 2px solid var(--border-color); 
        border-radius: var(--radius-md); 
        font-size: 1rem;
        font-family: inherit;
    }
    textarea {
        min-height: 100px;
        resize: vertical;
    }
    input:disabled {
        background: var(--bg-tertiary);
        color: var(--text-light);
    }
    .profile-section button {
        width: 100%; 
        padding: 1rem; 
        background: var(--gradient-primary); 
        color: white; 
        border: none; 
        border-radius: var(--radius-md); 
        font-size: 1rem; 
        font-weight: 600; 
        cursor: pointer;
        transition: var(--transition);
    }
    .profile-section button:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
    }
    .profile-section button:disabled {
        background: var(--text-light);
        cursor: not-allowed;
    }
    @media (max-width: 600px) {
        .profile-grid {
            grid-template-columns: 1fr;
        }
        .grid-col-span-2 {
            grid-column: span 1 / span 1;
        }
    }
</style>

<!-- FIXED: Added page transition class -->
<div class="profile-container page-transition-enter-active" style="max-width: 800px; margin: 0 auto;">
    <div class="profile-header" style="background: var(--bg-primary); border-radius: var(--radius-lg); padding: 2rem; box-shadow: var(--shadow-sm); margin-bottom: 2rem;">
        <div style="display: flex; align-items: center; gap: 2rem; flex-wrap: wrap;">
            <div class="avatar" style="width: 80px; height: 80px; font-size: 2rem; flex-shrink: 0;">
                <!-- Placeholder for profile picture -->
                <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                    <circle cx="12" cy="7" r="4"></circle>
                </svg>
            </div>
            <div style="flex: 1; min-width: 200px;">
                <h1 style="margin-bottom: 0.5rem;" id="profileDisplayName">Loading...</h1>
                <p style="color: var(--text-secondary); margin-bottom: 0.25rem;" id="profileEmail">email@example.com</p>
                <span class="status-badge" id="profileRole" style="margin-top: 0.5rem; display: inline-block;">Attendee</span>
            </div>
        </div>
    </div>

    <!-- Callout to complete profile -->
    <div class="profile-callout" id="profileCallout">
        <h3>Complete Your Profile</h3>
        <p>Add more details about yourself to help others connect with you and get better event recommendations.</p>
    </div>

    <div class="profile-section" style="background: var(--bg-primary); border-radius: var(--radius-lg); padding: 2rem; box-shadow: var(--shadow-sm); margin-bottom: 2rem;">
        <h2 style="margin-bottom: 1.5rem;">Edit Profile</h2>
        
        <form id="profileForm">
            <div class="profile-grid">
                <div>
                    <label for="editFirstName">First Name</label>
                    <input id="editFirstName" type="text" placeholder="Your first name">
                </div>
                <div>
                    <label for="editLastName">Last Name</label>
                    <input id="editLastName" type="text" placeholder="Your last name">
                </div>
                <div>
                    <label for="editEmail">Email (Cannot be changed)</label>
                    <input id="editEmail" type="email" disabled>
                </div>
                <div>
                    <label for="editMajor">Major/Department</label>
                    <input id="editMajor" type="text" placeholder="e.g. Computer Science">
                </div>
                <div class="grid-col-span-2">
                    <label for="editPhone">Phone Number</label>
                    <input id="editPhone" type="tel" placeholder="(555) 123-4567">
                </div>
                <div class="grid-col-span-2">
                    <label for="editBio">Bio</label>
                    <textarea id="editBio" placeholder="Tell us a bit about yourself..."></textarea>
                </div>
                <div class="grid-col-span-2">
                    <label for="editHobbies">Hobbies</label>
                    <input id="editHobbies" type="text" placeholder="e.g. Hiking, Coding, Music">
                </div>
            </div>
            
            <button type="submit" id="saveProfileBtn">Save Changes</button>
        </form>
        
        <div id="profileMessage" style="display: none; margin-top: 1rem;"></div>
    </div>

    <div class="profile-section" style="background: var(--bg-primary); border-radius: var(--radius-lg); padding: 2rem; box-shadow: var(--shadow-sm); margin-bottom: 2rem;">
        <h2 style="margin-bottom: 1.5rem;">Change Password</h2>
        <p style="color: var(--text-secondary); margin-bottom: 1rem;">Password changes are not yet supported. This feature is coming soon.</p>
        <form id="passwordForm">
            <!-- (Form inputs disabled for now) -->
            <button typeD="submit" id="changePasswordBtn" disabled>Change Password (Soon)</button>
        </form>
    </div>

    <div class="profile-section" style="background: #fee; border: 1px solid #fcc; border-radius: var(--radius-lg); padding: 2rem;">
        <h2 style="margin-bottom: 1rem; color: #c33;">Danger Zone</h2>
        <p style="color: var(--text-secondary); margin-bottom: 1rem;">Once you delete your account, there is no going back. Please be certain.</p>
        <button id="deleteAccountBtn" style="background: #f56565; max-width: 200px;">
            Delete Account
        </button>
    </div>
</div>

<script type="module">
import { api } from "../js/api.js";
import { updateUserInfo } from "../js/app.js"; // Import to refresh sidebar

const token = localStorage.getItem("token");

// --- Form Elements ---
const profileForm = document.getElementById("profileForm");
const messageDiv = document.getElementById("profileMessage");
const saveBtn = document.getElementById("saveProfileBtn");
const callout = document.getElementById("profileCallout");

// --- Input Fields ---
const fields = {
    firstName: document.getElementById("editFirstName"),
    lastName: document.getElementById("editLastName"),
    email: document.getElementById("editEmail"),
    major: document.getElementById("editMajor"),
    phone: document.getElementById("editPhone"),
    bio: document.getElementById("editBio"),
    hobbies: document.getElementById("editHobbies")
};

// --- Header Elements ---
const headerName = document.getElementById("profileDisplayName");
const headerEmail = document.getElementById("profileEmail");
const headerRole = document.getElementById("profileRole");


// --- Load User Profile ---
async function loadProfile() {
    if (!token) {
        window.location.hash = "#/login";
        return;
    }
    
    try {
        const userData = await api("/auth/me", "GET", null, token);
        
        // --- Populate Header ---
        const fullName = `${userData.first_name || ''} ${userData.last_name || ''}`.trim();
        headerName.textContent = fullName || userData.email.split('@')[0];
        headerEmail.textContent = userData.email;
        
        const roleText = {
            'admin': 'Administrator',
            'organizer': 'Event Organizer',
            'attendee': 'Attendee'
        };
        headerRole.textContent = roleText[userData.role] || 'Attendee';
        headerRole.className = 'status-badge ' + (userData.role === 'admin' ? 'active' : 'upcoming');
        
        // --- Populate Form ---
        fields.firstName.value = userData.first_name || "";
        fields.lastName.value = userData.last_name || "";
        fields.email.value = userData.email || "";
        fields.major.value = userData.major_department || "";
        fields.phone.value = userData.phone_number || "";
        fields.bio.value = userData.bio || "";
        fields.hobbies.value = userData.hobbies || "";

        // --- Show Callout if profile is incomplete ---
        if (!userData.major_department || !userData.bio || !userData.hobbies) {
            callout.style.display = "block";
        }
        
    } catch (error) {
        console.error("Failed to load profile:", error);
        messageDiv.className = "error-message";
        messageDiv.textContent = "Failed to load profile data.";
        messageDiv.style.display = "block";
    }
}

// --- Save Profile Changes ---
profileForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    
    saveBtn.disabled = true;
    saveBtn.textContent = "Saving...";
    messageDiv.style.display = "none";

    const payload = {
        first_name: fields.firstName.value,
        last_name: fields.lastName.value,
        major_department: fields.major.value,
        phone_number: fields.phone.value,
        bio: fields.bio.value,
        hobbies: fields.hobbies.value
    };

    try {
        const updatedUser = await api("/auth/me", "PUT", payload, token);
        
        messageDiv.className = "success-message";
        messageDiv.textContent = "Profile updated successfully!";
        messageDiv.style.display = "block";

        // Update header and sidebar with new name
        headerName.textContent = `${updatedUser.first_name} ${updatedUser.last_name}`;
        updateUserInfo(); // Refresh the sidebar
        callout.style.display = "none"; // Hide callout after saving

    } catch (error) {
        console.error("Failed to save profile:", error);
        messageDiv.className = "error-message";
        messageDiv.textContent = "Failed to save profile. Please try again.";
        messageDiv.style.display = "block";
    }
    
    saveBtn.disabled = false;
    saveBtn.textContent = "Save Changes";
    
    setTimeout(() => {
        messageDiv.style.display = "none";
    }, 3000);
});

// --- Delete Account ---
document.getElementById("deleteAccountBtn").addEventListener("click", async () => {
    // NOTE: A custom modal is better than confirm()
    // This is a placeholder until a modal component is built.
    const a = window.prompt("Type DELETE to confirm account deletion.");
    if (a !== "DELETE") {
        return;
    }
    
    try {
        await api("/auth/delete", "POST", null, token);
        alert("Account deleted successfully"); //
        localStorage.removeItem("token");
        window.location.hash = "#/landing";
        window.location.reload();
    } catch (error) {
        alert("Failed to delete account: " + (error.message || "Unknown error"));
    }
});

// Load profile on page load
loadProfile();
</script>
