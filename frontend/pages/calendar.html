<link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/main.min.css' rel='stylesheet' />
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js'></script>

<div id="calendarContainer" class="page-transition-enter-active">
    <div id="calendar"></div>
</div>

<script type="module">
import { api } from "../js/api.js";

const container = document.querySelector("#calendarContainer");
const token = localStorage.getItem("token");

/**
 * Generates a display string for an event's location.
 * @param {object} event - The event object from the API.
 * @returns {string} A formatted location string.
 */
function getEventLocation(event) {
    if (event.location_type === 'custom') {
        return event.custom_location_address || 'Location TBA';
    }
    if (event.location_type === 'venue') {
        // Use || '' to avoid "null" or "undefined"
        let name = event.venue_name || 'On-Campus Venue';
        let building = event.venue_building || '';
        let room = event.venue_room || '';
        
        if (building && room) {
            return `${name} (${building}, ${room})`;
        }
        if (building) {
            return `${name} (${building})`;
        }
        return name;
    }
    return 'Location TBA';
}

// Load calendar view
async function loadCalendarView() {
    const calendarEl = document.getElementById("calendar");
    try {
        // Note: This page uses /events/
        const events = await api("/events/", "GET", null, token); 
        
        // Check to ensure API returned a valid array
        if (!Array.isArray(events)) {
            console.error("API did not return an array:", events);
            calendarEl.innerHTML = '<div class="error-message">Failed to load calendar. Invalid data received.</div>';
            return;
        }

        const calendar = new window.FullCalendar.Calendar(calendarEl, {
            initialView: "dayGridMonth",
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek,timeGridDay,listWeek'
            },
            buttonText: {
                today: 'Today',
                month: 'Month',
                week: 'Week',
                day: 'Day',
                list: 'List'
            },
            height: 'auto',
            aspectRatio: 1.8,
            events: events.map(e => ({
                title: e.title,
                start: e.start_time, // Assumes ISO string
                end: e.end_time,     // Assumes ISO string
                extendedProps: {
                    location: getEventLocation(e), // Use helper
                    description: e.description,
                    visibility: e.visibility
                },
                // Style private events differently
                backgroundColor: e.visibility === 'private' ? '#5568d3' : '#667eea',
                borderColor: e.visibility === 'private' ? '#4a5568' : '#5568d3'
            })),
            eventClick: function(info) {
                // TODO: Replace with a nice modal
                alert(
                    'Event: ' + info.event.title + '\n' +
                    (info.event.extendedProps.visibility === 'private' ? '(Private Event)\n' : '') +
                    'Location: '.concat(info.event.extendedProps.location || 'N/A') + '\n' +
                    'Start: ' + info.event.start.toLocaleString()
                );
            },
            eventMouseEnter: function(info) {
                info.el.style.opacity = '0.8';
            },
            eventMouseLeave: function(info) {
                info.el.style.opacity = '1';
            }
        });
        
        calendar.render();
        
    } catch (error) {
        console.error("Failed to load calendar:", error);
        container.innerHTML = '<div class="error-message">Failed to load calendar. Please try again.</div>';
    }
}

// Load calendar on page load
loadCalendarView();
</script>
