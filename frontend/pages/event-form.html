<style>
    /* Base form styles */
    .create-event-form {
        max-width: 700px;
        margin: 0 auto;
    }
    .form-section {
        margin-bottom: 1.5rem;
        padding-bottom: 1.5rem;
        border-bottom: 1px solid var(--border-color, #e0e0e0);
    }
    .form-section:last-child {
        border-bottom: none;
        margin-bottom: 0;
        padding-bottom: 0;
    }
    .form-section h3 {
        font-size: 1.125rem; /* 18px */
        color: var(--text-secondary, #555);
        margin-bottom: 1rem;
    }
    
    /* Back link */
    .back-link {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 1.5rem;
        color: var(--primary-color, #007bff);
        text-decoration: none;
        font-weight: 500;
    }
    .back-link:hover {
        text-decoration: underline;
    }

    /* Form field styles */
    label {
        display: block; 
        margin-bottom: 0.5rem; 
        color: var(--text-secondary, #555); 
        font-size: 0.875rem; /* 14px */
        font-weight: 500;
    }
    input[type="text"],
    input[type="url"],
    input[type="datetime-local"],
    textarea,
    select {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid var(--border-color, #ccc);
        border-radius: var(--radius-md, 8px);
        background-color: var(--bg-secondary, #f9f9f9);
        box-sizing: border-box; /* Important for padding */
    }
    input:focus, textarea:focus, select:focus {
        outline: 2px solid var(--primary-color, #007bff);
        border-color: var(--primary-color, #007bff);
        background-color: var(--bg-primary, #fff);
    }
    textarea {
        resize: vertical;
    }
    
    /* Date/Time flex layout */
    .date-time-group {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
    }
    .date-time-group > div {
        flex: 1;
        min-width: 200px;
    }

    /* Custom Radio Buttons */
    .radio-group {
        display: flex;
        gap: 1rem;
        margin-bottom: 1rem;
    }
    .radio-label {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.75rem 1rem;
        border: 2px solid var(--border-color, #e0e0e0);
        border-radius: var(--radius-md, 8px);
        cursor: pointer;
        transition: all 0.2s ease-in-out;
        flex: 1;
    }
    .radio-label input[type="radio"] {
        width: auto;
        margin-bottom: 0;
        accent-color: var(--primary-color, #007bff);
    }
    .radio-label:has(input:checked) {
        background: var(--bg-tertiary, #f0f7ff);
        border-color: var(--primary-color, #007bff);
    }
    
    /* Hidden Containers */
    /* Only hide the Venue selector by default, Custom Address is visible by default */
    #venueSelectContainer {
        display: none;
    }
    
    /* Links within forms */
    .form-section a {
        font-size: 0.875rem;
        color: var(--primary-color, #007bff);
        text-decoration: none;
        display: inline-block;
        margin-top: 0.5rem;
    }
    .form-section a:hover {
        text-decoration: underline;
    }
    
    /* AI Draft notification */
    .ai-draft-applied {
        padding: 1rem;
        background: #e6f3ff;
        border: 1px solid #b3d4ff;
        color: #00529B;
        border-radius: var(--radius-md, 8px);
        margin-bottom: 1.5rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }
</style>

<!-- 
  Create Event Form
  This HTML file provides the structure for creating a new event.
  It includes fields for title, description, time, location, and settings.
  JavaScript is used to handle form submission, location type toggling,
  and pre-filling the form with an AI-generated draft.
-->
<div class="create-event-form page-transition-enter-active">
    
    <!-- Back Navigation -->
    <a href="#/create-event" class="back-link">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg>
        Back to options
    </a>
    
    <h2>New Event Details</h2>
    
    <!-- Notification Area for AI Draft -->
    <div id="aiDraftMessage" style="display: none;"></div>
    
    <form id="createEventForm">
        
        <!-- Basic Info Section -->
        <div class="form-section">
            <label for="evTitle">Event Title*</label>
            <input 
                id="evTitle" 
                type="text" 
                placeholder="e.g. Spring Hackathon" 
                required
            >
            
            <label for="evDescription">Description</label>
            <textarea 
                id="evDescription" 
                placeholder="Tell attendees about your event..."
                rows="5"
            ></textarea>
        </div>
        
        <!-- Date & Time Section -->
        <div class="form-section">
            <h3>Date & Time*</h3>
            <div class="date-time-group">
                <div>
                    <label for="evStart">Start Time</label>
                    <input id="evStart" type="datetime-local" required>
                </div>
                <div>
                    <label for="evEnd">End Time</label>
                    <input id="evEnd" type="datetime-local" required>
                </div>
            </div>
        </div>
        
        <!-- Location Section (No longer required) -->
        <div class="form-section">
            <h3>Location</h3>
            <div class="radio-group">
                <label class="radio-label">
                    <input type="radio" name="location_type" value="custom" checked>
                    Custom Address
                </label>
                <label class="radio-label">
                    <input type="radio" name="location_type" value="venue">
                    On-Campus Venue
                </label>
            </div>
            
            <!-- Custom Location Fields (Now visible by default via CSS/HTML structure) -->
            <div id="customLocationContainer">
                <label for="evCustomLocation">Custom Address</label>
                <input 
                    id="evCustomLocation" 
                    type="text" 
                    placeholder="e.g. 123 Main St, Marion, IN"
                >
            </div>
            
            <!-- On-Campus Venue Fields (Hidden by CSS by default) -->
            <div id="venueSelectContainer">
                <label for="evVenue">Select a Venue</label>
                <select id="evVenue">
                    <option value="">Loading venues...</option>
                </select>
                <a href="#/dashboard" id="manageVenuesLink" style="display: none;">Manage Venues</a>
            </div>
            
            <!-- Google Maps Link (Optional) -->
            <label for="evMapsLink">Google Maps Link (Optional)</label>
            <input 
                id="evMapsLink" 
                type="url" 
                placeholder="https://maps.app.goo.gl/..."
            >
        </div>
        
        <!-- Settings Section (Visibility) -->
        <div class="form-section" id="visibilityContainer" style="display: none;">
            <h3>Settings</h3>
            <label>Visibility*</label>
            <div class="radio-group">
                <label class="radio-label">
                    <input type="radio" name="visibility" value="public" checked>
                    Public (Visible to everyone)
                </label>
                <label class="radio-label">
                    <input type="radio" name="visibility" value="private">
                    Private (Only visible to you)
                </label>
            </div>
        </div>
        
        <!-- Submit Button -->
        <button type="submit" id="createBtn">Create Event</button>
    </form>
    
    <!-- Form submission message area -->
    <div id="createMessage" style="display: none; margin-top: 1rem;"></div>
</div>

<script type="module">
// Assuming api.js and app.js are in a '../js/' directory
import { api } from "../js/api.js";
import { getRoleFromToken } from "../js/app.js";

// --- Global Elements ---
const form = document.getElementById("createEventForm");
const messageDiv = document.getElementById("createMessage");
const createBtn = document.getElementById("createBtn");
const token = localStorage.getItem("token");
const userRole = getRoleFromToken();

// --- Form Elements ---
const evTitle = document.getElementById("evTitle");
const evDescription = document.getElementById("evDescription");
const evStart = document.getElementById("evStart");
const evEnd = document.getElementById("evEnd");
const evCustomLocation = document.getElementById("evCustomLocation");
const evMapsLink = document.getElementById("evMapsLink");
const venueSelect = document.getElementById("evVenue");
const aiDraftMessage = document.getElementById("aiDraftMessage");

// --- Location Elements ---
const venueSelectContainer = document.getElementById("venueSelectContainer");
const customLocationContainer = document.getElementById("customLocationContainer");
const locationTypeRadios = document.querySelectorAll('input[name="location_type"]');

// --- Settings Elements ---
const visibilityContainer = document.getElementById("visibilityContainer");
const manageVenuesLink = document.getElementById("manageVenuesLink");

// --- 1. Role-Based UI ---
// Show visibility settings and 'Manage Venues' link only for admins/organizers
if (userRole === 'admin' || userRole === 'organizer') {
    visibilityContainer.style.display = 'block';
    manageVenuesLink.style.display = 'block';
} else {
    visibilityContainer.style.display = 'none';
    manageVenuesLink.style.display = 'none';
}

// --- 2. Location Toggle Logic (Robust Version) ---
/**
 * Reads the checked location_type radio and shows/hides the
 * corresponding form fields.
 * This function is now "context-agnostic" (doesn't use `this`)
 * and sets both location fields to be NOT required, per user request.
 */
function handleLocationTypeChange() {
    const type = document.querySelector('input[name="location_type"]:checked').value;
    
    if (type === 'venue') {
        venueSelectContainer.style.display = 'block';
        customLocationContainer.style.display = 'none';
    } else { // 'custom'
        venueSelectContainer.style.display = 'none';
        customLocationContainer.style.display = 'block';
    }
    
    // Per request: location is no longer required.
    venueSelect.required = false;
    evCustomLocation.required = false;
}
// Add listener to all radio buttons
locationTypeRadios.forEach(radio => radio.addEventListener('change', handleLocationTypeChange));

// --- 3. Load Venues into Dropdown ---
async function loadVenues() {
    try {
        const venues = await api("/venues/", "GET", null, token);
        if (venues && venues.length > 0) {
            venueSelect.innerHTML = '<option value="">-- Select a venue --</option>';
            venues.forEach(venue => {
                const option = document.createElement('option');
                option.value = venue.venue_id;
                // e.g., "Main Auditorium (Taylor Hall, 101)" or "Student Center (Student Center)"
                option.textContent = `${venue.name} ${venue.building ? `(${venue.building}${venue.room_number ? `, ${venue.room_number}` : ''})` : ''}`;
                venueSelect.appendChild(option);
            });
        } else {
            venueSelect.innerHTML = '<option value="">No on-campus venues found</option>';
        }
    } catch (error) {
        console.error("Failed to load venues:", error);
        venueSelect.innerHTML = '<option value="">Error loading venues</option>';
    }
}

// --- 4. AI DRAFT PRE-FILL (Corrected Version) ---
/**
 * Checks localStorage for an 'aiEventDraft' and pre-fills
 * the form. This includes logic to correctly set and display
 * the custom location field if one is provided in the draft.
 */
function applyAIDraft() {
    const draftString = localStorage.getItem('aiEventDraft');
    if (!draftString) {
        return; // No draft found
    }
    
    try {
        const draft = JSON.parse(draftString);
        
        // Apply draft values
        if (draft.title) evTitle.value = draft.title;
        if (draft.description) evDescription.value = draft.description;
        
        // Logic to handle location draft
        if (draft.location) {
            evCustomLocation.value = draft.location;
            
            // 1. Force the "Custom Address" radio button to be checked
            document.querySelector('input[name="location_type"][value="custom"]').checked = true;
            
            // 2. Manually call the change handler to show/hide the correct fields
            handleLocationTypeChange();
        }
        
        // Show a confirmation message
        aiDraftMessage.innerHTML = `
            <div class="ai-draft-applied">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2L10 9L3 11L10 13L12 20L14 13L21 11L14 9L12 2Z"/></svg>
                <span>AI Draft applied! Please review and add dates.</span>
            </div>
        `;
        aiDraftMessage.style.display = 'block';
        
    } catch (e) {
        console.error("Failed to parse AI draft:", e);
    } finally {
        // Clear the draft from localStorage so it's only used once
        localStorage.removeItem('aiEventDraft');
    }
}

// --- 5. Initial Page Load (Corrected Order) ---
// Now that Custom Address is the default visible HTML element,
// we still run this to ensure the correct state if an AI Draft
// for a venue was applied, or if the user clicks Venue initially.
handleLocationTypeChange(); 
loadVenues();
applyAIDraft(); 

// --- 6. Form Submission ---
form.addEventListener("submit", async (e) => {
    e.preventDefault();
    
    messageDiv.style.display = "none";
    messageDiv.className = ""; // Clear old classes
    
    // --- Get Values ---
    const title = evTitle.value;
    const description = evDescription.value;
    const start = evStart.value;
    const end = evEnd.value;
    
    const location_type = document.querySelector('input[name="location_type"]:checked').value;
    const venue_id = venueSelect.value;
    const custom_location_address = evCustomLocation.value;
    const google_maps_link = evMapsLink.value;
    
    let visibility = 'private'; // Default for non-admins
    if (userRole === 'admin' || userRole === 'organizer') {
        visibility = document.querySelector('input[name="visibility"]:checked').value;
    }
    
    // --- Validation ---
    if (new Date(start) >= new Date(end)) {
        messageDiv.className = "error-message";
        messageDiv.textContent = "End time must be after start time";
        messageDiv.style.display = "block";
        return;
    }
    
    // Validate Google Maps link if one is entered
    const mapRegex = /^(https?:\/\/)?(www\.)?(google\.com\/maps|maps\.app\.goo\.gl)/;
    if (google_maps_link && !mapRegex.test(google_maps_link)) {
        messageDiv.className = "error-message";
        messageDiv.textContent = "Please enter a valid Google Maps link (e.g., google.com/maps/...).";
        messageDiv.style.display = "block";
        return;
    }
    
    // --- Build Payload ---
    // The logic here correctly sends null for the unused location type
    // or null if the user leaves a non-required location field blank.
    const payload = {
        title,
        description,
        start_time: start, 
        end_time: end,     
        location_type,
        // Send null if link is empty, otherwise send the value
        google_maps_link: google_maps_link || null,
        visibility,
        // Send venue_id only if type is 'venue' AND value exists, otherwise null
        venue_id: (location_type === 'venue' && venue_id) ? venue_id : null,
        // Send address only if type is 'custom' AND value exists, otherwise null
        custom_location_address: (location_type === 'custom' && custom_location_address) ? custom_location_address : null,
    };
    
    createBtn.disabled = true;
    createBtn.textContent = "Creating...";
    
    // --- API Call ---
    try {
        const res = await api("/events/", "POST", payload, token);
        
        if (res.error) {
            messageDiv.className = "error-message";
            messageDiv.textContent = res.error || "Failed to create event";
        } else {
            messageDiv.className = "success-message";
            messageDiv.textContent = "Event created successfully! Redirecting...";
            
            // Redirect to calendar after a short delay
            setTimeout(() => {
                window.location.hash = "#/calendar";
            }, 1500);
        }
        
    } catch (error) {
        console.error("Form submission error:", error);
        messageDiv.className = "error-message";
        messageDiv.textContent = "A network error occurred. Please try again.";
    } finally {
        // Re-enable button only if not redirecting
        if (messageDiv.className.includes("error-message")) {
            createBtn.disabled = false;
            createBtn.textContent = "Create Event";
        }
        messageDiv.style.display = "block";
    }
});
</script>