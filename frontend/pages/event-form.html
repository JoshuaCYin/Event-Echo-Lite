<style>
    /* Base form styles */
    .create-event-form {
        max-width: 700px;
        margin: 0 auto;
    }
    .form-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }
    .form-section {
        margin-bottom: 1.5rem;
        padding-bottom: 1.5rem;
        border-bottom: 1px solid var(--border-color, #e0e0e0);
    }
    .form-section:last-child {
        border-bottom: none;
        margin-bottom: 0;
        padding-bottom: 0;
    }
    .form-section h3 {
        font-size: 1.125rem; /* 18px */
        color: var(--text-secondary, #555);
        margin-bottom: 1rem;
    }
    
    /* Back link */
    .back-link {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 1.5rem;
        color: var(--primary-color, #007bff);
        text-decoration: none;
        font-weight: 500;
    }
    .back-link:hover {
        text-decoration: underline;
    }

    /* Form field styles */
    label {
        display: block; 
        margin-bottom: 0.5rem; 
        color: var(--text-secondary, #555); 
        font-size: 0.875rem; /* 14px */
        font-weight: 500;
    }
    input[type="text"],
    input[type="url"],
    input[type="datetime-local"],
    textarea,
    select {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid var(--border-color, #ccc);
        border-radius: var(--radius-md, 8px);
        background-color: var(--bg-secondary, #f9f9f9);
        box-sizing: border-box; 
    }
    input:focus, textarea:focus, select:focus {
        outline: 2px solid var(--primary-color, #007bff);
        border-color: var(--primary-color, #007bff);
        background-color: var(--bg-primary, #fff);
    }
    textarea {
        resize: vertical;
    }
    
    /* Date/Time flex layout */
    .date-time-group {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
    }
    .date-time-group > div {
        flex: 1;
        min-width: 200px;
    }

    /* Custom Radio Buttons */
    .radio-group {
        display: flex;
        gap: 1rem;
        margin-bottom: 1rem;
    }
    .radio-label {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.75rem 1rem;
        border: 2px solid var(--border-color, #e0e0e0);
        border-radius: var(--radius-md, 8px);
        cursor: pointer;
        transition: all 0.2s ease-in-out;
        flex: 1;
    }
    /* Hide actual radio button */
    .radio-label input[type="radio"] {
        display: none;
    }
    .radio-label:has(input:checked) {
        background: var(--bg-tertiary, #f0f7ff);
        border-color: var(--primary-color, #007bff);
    }
    
    #venueSelectContainer { display: none; }
    
    .form-section a {
        font-size: 0.875rem;
        color: var(--primary-color, #007bff);
        text-decoration: none;
        display: inline-block;
        margin-top: 0.5rem;
    }
    .form-section a:hover { text-decoration: underline; }
    
    .ai-draft-applied {
        padding: 1rem;
        background: #e6f3ff;
        border: 1px solid #b3d4ff;
        color: #00529B;
        border-radius: var(--radius-md, 8px);
        margin-bottom: 1.5rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    /* Action Buttons */
    .form-actions {
        display: flex;
        gap: 1rem;
        align-items: center;
        margin-top: 1.5rem;
    }
    .form-actions button {
        padding: 0.75rem 1.5rem;
        border-radius: var(--radius-md, 8px);
        font-weight: 600;
        cursor: pointer;
        border: none;
    }
    #saveBtn {
        background: var(--primary-color, #007bff);
        color: white;
        flex: 2;
    }

    /* --- AI Assist Button Styles --- */
    .label-with-ai {
        display: flex; justify-content: space-between; align-items: center;
    }
    .ai-assist-btn {
        background: none; border: 1px solid var(--primary-color);
        color: var(--primary-color); padding: 2px 8px; border-radius: 12px;
        font-size: 0.75rem; cursor: pointer; display: flex; align-items: center; gap: 4px;
        transition: all 0.2s;
        flex-shrink: 0; /* Add this to prevent shrinking/wrapping */
    }
    .ai-assist-btn:hover { background: var(--bg-tertiary); transform: translateY(-1px); }
    .ai-assist-btn.loading { opacity: 0.7; cursor: wait; }
</style>

<div class="create-event-form page-transition-enter-active">
    
    <!-- Back Navigation -->
    <a href="#/create-event" class="back-link" id="backLink">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg>
        <span>Back to options</span>
    </a>
    
    <div class="form-header">
        <h2 id="pageTitle">New Event Details</h2>
    </div>
    
    <div id="aiDraftMessage" style="display: none;"></div>
    <div id="topErrorMessage" class="error-message" style="display: none; margin-bottom: 1rem;"></div>
    
    <form id="eventForm">
        
        <!-- Basic Info Section -->
        <div class="form-section">
            <label for="evTitle">Event Title*</label>
            <input id="evTitle" type="text" placeholder="e.g. Spring Hackathon" required>
            
            <div class="label-with-ai">
                <label for="evDescription">Description</label>
            </div>
            <textarea id="evDescription" placeholder="Tell attendees about your event..." rows="5"></textarea>
        </div>
        
        <!-- Date & Time Section -->
        <div class="form-section">
            <h3>Date & Time*</h3>
            <div class="date-time-group">
                <div>
                    <label for="evStart">Start Time</label>
                    <input id="evStart" type="datetime-local" required>
                </div>
                <div>
                    <label for="evEnd">End Time</label>
                    <input id="evEnd" type="datetime-local" required>
                </div>
            </div>
        </div>
        
        <!-- Location Section -->
        <div class="form-section">
            <h3>Location</h3>
            <div class="radio-group">
                <label class="radio-label">
                    <input type="radio" name="location_type" value="custom" checked>
                    Custom Address
                </label>
                <label class="radio-label">
                    <input type="radio" name="location_type" value="venue">
                    On-Campus Venue
                </label>
            </div>
            
            <div id="customLocationContainer">
                <label for="evCustomLocation">Custom Address</label>
                <input id="evCustomLocation" type="text" placeholder="e.g. 123 Main St, Marion, IN">
            </div>
            
            <div id="venueSelectContainer">
                <label for="evVenue">Select a Venue</label>
                <select id="evVenue">
                    <option value="">Loading venues...</option>
                </select>
                <a href="#/dashboard" id="manageVenuesLink" style="display: none;">Manage Venues</a>
            </div>
            
            <label for="evMapsLink">Google Maps Link (Optional)</label>
            <input id="evMapsLink" type="url" placeholder="https://maps.app.goo.gl/...">
        </div>
        
        <!-- Settings Section -->
        <div class="form-section" id="visibilityContainer" style="display: none;">
            <h3>Settings</h3>
            <label>Visibility*</label>
            <div class="radio-group">
                <label class="radio-label">
                    <input type="radio" name="visibility" value="public" checked>
                    Public (Visible to everyone)
                </label>
                <label class="radio-label">
                    <input type="radio" name="visibility" value="private">
                    Private (Only visible to you)
                </label>
            </div>
        </div>
        
        <!-- Actions -->
        <div class="form-actions">
            <button type="submit" id="saveBtn">Create Event</button>
        </div>
    </form>
    
    <div id="formMessage" style="display: none; margin-top: 1rem;"></div>
</div>

<script type="module">
import { api } from "../js/api.js";
import { getRoleFromToken } from "../js/app.js";

// --- State & elements ---
const form = document.getElementById("eventForm");
const messageDiv = document.getElementById("formMessage");
const topErrorDiv = document.getElementById("topErrorMessage");
const saveBtn = document.getElementById("saveBtn");
const token = localStorage.getItem("token");
const userRole = getRoleFromToken();

// Fields
const evTitle = document.getElementById("evTitle");
const evDescription = document.getElementById("evDescription");
const evStart = document.getElementById("evStart");
const evEnd = document.getElementById("evEnd");
const evCustomLocation = document.getElementById("evCustomLocation");
const evMapsLink = document.getElementById("evMapsLink");
const venueSelect = document.getElementById("evVenue");
const venueSelectContainer = document.getElementById("venueSelectContainer");
const customLocationContainer = document.getElementById("customLocationContainer");
const locationTypeRadios = document.querySelectorAll('input[name="location_type"]');
const visibilityContainer = document.getElementById("visibilityContainer");
const manageVenuesLink = document.getElementById("manageVenuesLink");

// Detect Edit Mode
const hashParts = window.location.hash.split('?');
const params = new URLSearchParams(hashParts[1]);
const eventId = params.get('id');
const isEditMode = !!eventId;

// --- Initialization Logic ---

async function init() {
    // Role UI setup
    if (userRole === 'admin' || userRole === 'organizer') {
        visibilityContainer.style.display = 'block';
        manageVenuesLink.style.display = 'block';
    } else {
        visibilityContainer.style.display = 'none';
    }

    // Load venues first
    await loadVenues();

    // Setup Logic based on Mode
    if (isEditMode) {
        setupEditMode();
    } else {
        setupCreateMode();
    }

    // Initialize Location Logic
    handleLocationTypeChange();
}

// --- AI REWRITE LOGIC (NEW) ---
const aiRewriteBtn = document.getElementById('aiRewriteBtn');
aiRewriteBtn.addEventListener('click', async () => {
    const currentText = evDescription.value.trim();
    if (!currentText && !evTitle.value.trim()) {
        // --- Use a non-blocking message ---
        showMessage("Please enter a title or some description text first.", "error-message");
        return;
    }
    
    aiRewriteBtn.classList.add('loading');
    aiRewriteBtn.textContent = 'Rewriting...';
    aiRewriteBtn.disabled = true;
    
    try {
        // --- UPDATED: Send all relevant fields as context ---
        const payload = {
            prompt: "Rewrite this description to be professional, engaging, and clear.",
            context: "Main Event Form Description Field",
            current_values: {
                evTitle: evTitle.value,
                evDescription: evDescription.value,
                evStart: evStart.value,
                evEnd: evEnd.value,
                evCustomLocation: evCustomLocation.value
            }
        };
        
        const result = await api('/ai/wizard-helper', 'POST', payload, token);
        
        if (result && result.actions) {
            // Find the action for the description field
            const descAction = result.actions.find(a => a.field === 'evDescription');
            if (descAction) {
                evDescription.value = descAction.value;
                // Highlight effect
                evDescription.style.transition = 'background-color 0.5s';
                evDescription.style.backgroundColor = '#e6f3ff';
                setTimeout(() => evDescription.style.backgroundColor = '', 1000);
            }
            // Also check if it updated the title
             const titleAction = result.actions.find(a => a.field === 'evTitle');
             if (titleAction) {
                evTitle.value = titleAction.value;
                evTitle.style.transition = 'background-color 0.5s';
                evTitle.style.backgroundColor = '#e6f3ff';
                setTimeout(() => evTitle.style.backgroundColor = '', 1000);
            }
        } else if (result && result.response) {
             // Fallback if no specific action was generated
             // Check if response looks like a description (simple heuristic)
             if (result.response.length > 20) {
                 evDescription.value = result.response;
             }
        }
    } catch (err) {
        console.error("AI rewrite failed:", err);
        showMessage("Could not rewrite text at this time.", "error-message");
    } finally {
        aiRewriteBtn.classList.remove('loading');
        aiRewriteBtn.innerHTML = `<svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2L10 9L3 11L10 13L12 20L14 13L21 11L14 9L12 2Z"/></svg> AI Rewrite`;
        aiRewriteBtn.disabled = false;
    }
});


// --- Create vs Edit Setup ---

function setupCreateMode() {
    document.getElementById("pageTitle").textContent = "New Event Details";
    saveBtn.textContent = "Create Event";
    
    // Apply AI Draft if available
    applyAIDraft();
}

async function setupEditMode() {
    document.getElementById("pageTitle").textContent = "Edit Event";
    saveBtn.textContent = "Update Event";
    
    // Update back link to just go to calendar/list, not the "Create Options" page
    const backLink = document.getElementById("backLink");
    backLink.href = "#/calendar";
    backLink.querySelector("span").textContent = "Back to Calendar";

    // Fetch Data
    try {
        const event = await api(`/events/${eventId}`, "GET", null, token);
        
        if (event.error) {
            showTopError(event.error);
            return;
        }

        // Populate Fields
        evTitle.value = event.title || "";
        evDescription.value = event.description || "";
        evMapsLink.value = event.google_maps_link || "";

        // --- TIMEZONE FIX FOR EDITING ---
        let startStr = event.start_time;
        let endStr = event.end_time;
        
        // This handles UTC 'Z' or offset '+00:00' strings
        evStart.value = formatDateTimeForInput(startStr);
        evEnd.value = formatDateTimeForInput(endStr);
        // --------------------------------
        
        // Location Logic
        if (event.location_type === 'venue') {
            document.querySelector(`input[name="location_type"][value="venue"]`).checked = true;
            // Wait for venues to load, then select
            if (venueSelect.options.length > 1) {
                venueSelect.value = event.venue_id;
            }
        } else {
            document.querySelector(`input[name="location_type"][value="custom"]`).checked = true;
            evCustomLocation.value = event.custom_location_address || "";
        }
        
        // Visibility Logic
        if (event.visibility) {
            const visRadio = document.querySelector(`input[name="visibility"][value="${event.visibility}"]`);
            if (visRadio) visRadio.checked = true;
        }

        // Trigger UI update for location
        handleLocationTypeChange();

    } catch (err) {
        console.error(err);
        showTopError("Failed to load event details.");
    }
}

// --- Helper Functions ---

function showTopError(msg) {
    topErrorDiv.textContent = msg;
    topErrorDiv.style.display = 'block';
    form.style.opacity = '0.5';
    form.style.pointerEvents = 'none';
}

// --- UPDATED: Renamed for clarity and used for AI rewrite alerts too ---
function showMessage(msg, typeClass) {
    messageDiv.className = typeClass; // "success-message" or "error-message"
    messageDiv.textContent = msg;
    messageDiv.style.display = "block";
}

function formatDateTimeForInput(isoString) {
    if (!isoString) return "";
    try {
        // Create a Date object from the ISO string
        const date = new Date(isoString);
        
        // Check if valid date
        if (isNaN(date.getTime())) return "";
        
        // Format to YYYY-MM-DDTHH:MM (local time)
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        const hours = String(date.getHours()).padStart(2, '0');
        const minutes = String(date.getMinutes()).padStart(2, '0');
        
        return `${year}-${month}-${day}T${hours}:${minutes}`;
    } catch (e) {
        console.error("Error formatting date:", e);
        return "";
    }
}

async function loadVenues() {
    try {
        const venues = await api("/venues/", "GET", null, token);
        if (venues && venues.length > 0) {
            venueSelect.innerHTML = '<option value="">-- Select a venue --</option>';
            venues.forEach(venue => {
                const option = document.createElement('option');
                option.value = venue.venue_id;
                option.textContent = `${venue.name} ${venue.building ? `(${venue.building}${venue.room_number ? `, ${venue.room_number}` : ''})` : ''}`;
                venueSelect.appendChild(option);
            });
        } else {
            venueSelect.innerHTML = '<option value="">No on-campus venues found</option>';
        }
    } catch (error) {
        console.error("Failed to load venues:", error);
    }
}

function handleLocationTypeChange() {
    const type = document.querySelector('input[name="location_type"]:checked').value;
    if (type === 'venue') {
        venueSelectContainer.style.display = 'block';
        customLocationContainer.style.display = 'none';
    } else {
        venueSelectContainer.style.display = 'none';
        customLocationContainer.style.display = 'block';
    }
    // --- Validation logic moved to submit handler ---
}

locationTypeRadios.forEach(radio => radio.addEventListener('change', handleLocationTypeChange));

function applyAIDraft() {
    const draftString = localStorage.getItem('aiEventDraft');
    if (!draftString) return;
    try {
        const draft = JSON.parse(draftString);
        if (draft.title) evTitle.value = draft.title;
        if (draft.description) evDescription.value = draft.description;
        if (draft.location) {
            evCustomLocation.value = draft.location;
            document.querySelector('input[name="location_type"][value="custom"]').checked = true;
            handleLocationTypeChange();
        }
        // Handle date/time fields
        if (draft.start_time) {
            // AI returns full ISO, format it for the input
            evStart.value = formatDateTimeForInput(draft.start_time);
        }
        if (draft.end_time) {
            // AI returns full ISO, format it for the input
            evEnd.value = formatDateTimeForInput(draft.end_time);
        }
        
        const aiDraftMessage = document.getElementById("aiDraftMessage");
        aiDraftMessage.innerHTML = `<div class="ai-draft-applied"><span>âœ¨ AI Draft applied! Review details and save.</span></div>`;
        aiDraftMessage.style.display = 'block';
    } catch (e) { console.error(e); }
    localStorage.removeItem('aiEventDraft');
}

// --- Submit Handler (Create & Update) ---

form.addEventListener("submit", async (e) => {
    e.preventDefault();
    messageDiv.style.display = "none";
    messageDiv.className = "";
    
    const title = evTitle.value;
    const startLocal = evStart.value; // "YYYY-MM-DDTHH:MM"
    const endLocal = evEnd.value;
    const location_type = document.querySelector('input[name="location_type"]:checked').value;
    
    // --- Validation ---
    if (!title || !startLocal || !endLocal) {
        showMessage("Title, Start Time, and End Time are required.", "error-message");
        return;
    }
    if (new Date(startLocal) >= new Date(endLocal)) {
        showMessage("End time must be after start time.", "error-message");
        return;
    }
    const venueId = (location_type === 'venue' && venueSelect.value) ? venueSelect.value : null;
    const customAddress = (location_type === 'custom' && evCustomLocation.value) ? evCustomLocation.value : null;

    if (location_type === 'venue' && !venueId) {
        showMessage("Please select an on-campus venue.", "error-message");
        return;
    }
    if (location_type === 'custom' && !customAddress) {
        showMessage("Please enter a custom address.", "error-message");
        return;
    }
    // --- End Validation ---

    const startISO = startLocal ? new Date(startLocal).toISOString() : null;
    const endISO = endLocal ? new Date(endLocal).toISOString() : null;

    const payload = {
        title,
        description: evDescription.value,
        start_time: startISO,
        end_time: endISO,
        location_type,
        google_maps_link: evMapsLink.value || null,
        visibility: (userRole === 'admin' || userRole === 'organizer') 
            ? document.querySelector('input[name="visibility"]:checked').value 
            : 'private',
        venue_id: venueId,
        custom_location_address: customAddress,
    };

    saveBtn.disabled = true;
    saveBtn.textContent = isEditMode ? "Updating..." : "Creating...";

    try {
        let res;
        if (isEditMode) {
            res = await api(`/events/${eventId}`, "PUT", payload, token);
        } else {
            res = await api("/events/", "POST", payload, token);
        }
        
        if (res.error) {
            throw new Error(res.error);
        } else {
            showMessage(isEditMode ? "Event updated! Redirecting..." : "Event created! Redirecting...", "success-message");
            setTimeout(() => { window.location.hash = "#/calendar"; }, 1500);
        }
    } catch (error) {
        console.error("Submit error:", error);
        showMessage(error.message || "A network error occurred.", "error-message");
        saveBtn.disabled = false;
        saveBtn.textContent = isEditMode ? "Update Event" : "Create Event";
    }
});

// Start
init();

</script>