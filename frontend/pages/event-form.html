<style>
    .form-section {
        margin-bottom: 1.5rem;
        padding-bottom: 1.5rem;
        border-bottom: 1px solid var(--border-color);
    }
    .form-section:last-child {
        border-bottom: none;
        margin-bottom: 0;
        padding-bottom: 0;
    }
    .form-section h3 {
        font-size: 1.125rem;
        color: var(--text-secondary);
        margin-bottom: 1rem;
    }
    .radio-group {
        display: flex;
        gap: 1rem;
        margin-bottom: 1rem;
    }
    .radio-label {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.75rem 1rem;
        border: 2px solid var(--border-color);
        border-radius: var(--radius-md);
        cursor: pointer;
        transition: var(--transition);
    }
    .radio-label input {
        width: auto;
        margin-bottom: 0;
    }
    .radio-label:has(input:checked) {
        background: var(--bg-tertiary);
        border-color: var(--primary-color);
    }
    #venueSelectContainer, #customLocationContainer {
        display: none; /* Hidden by default */
    }
    label {
        display: block; 
        margin-bottom: 0.5rem; 
        color: var(--text-secondary); 
        font-size: 0.875rem;
        font-weight: 500;
    }
    .form-section a {
        font-size: 0.875rem;
        color: var(--primary-color);
        text-decoration: none;
    }
    .form-section a:hover {
        text-decoration: underline;
    }
</style>

<div class="create-event-form page-transition-enter-active" style="max-width: 700px; margin: 0 auto;">
    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1.5rem;">
        <a href="#/create-event" style="color: var(--primary-color); text-decoration: none;">&larr; Back to options</a>
    </div>
    <h2>New Event Details</h2>
    
    <form id="createEventForm">
        
        <div class="form-section">
            <label for="evTitle">Event Title*</label>
            <input 
                id="evTitle" 
                type="text" 
                placeholder="e.g. Spring Hackathon" 
                required
            >
            
            <label for="evDescription">Description</label>
            <textarea 
                id="evDescription" 
                placeholder="Tell attendees about your event..."
            ></textarea>
        </div>

        <div class="form-section">
            <h3>Date & Time*</h3>
            <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                <div style="flex: 1; min-width: 200px;">
                    <label for="evStart">Start Time</label>
                    <input id="evStart" type="datetime-local" required>
                </div>
                <div style="flex: 1; min-width: 200px;">
                    <label for="evEnd">End Time</label>
                    <input id="evEnd" type="datetime-local" required>
                </div>
            </div>
        </div>

        <div class="form-section">
            <h3>Location*</h3>
            <div class="radio-group">
                <label class="radio-label">
                    <input type="radio" name="location_type" value="custom" checked>
                    Custom Address
                </label>
                <label class="radio-label">
                    <input type="radio" name="location_type" value="venue">
                    On-Campus Venue
                </label>
            </div>

            <div id="customLocationContainer">
                <label for="evCustomLocation">Custom Address</label>
                <input 
                    id="evCustomLocation" 
                    type="text" 
                    placeholder="e.g. 123 Main St, Marion, IN"
                >
            </div>

            <div id="venueSelectContainer">
                <label for="evVenue">Select a Venue</label>
                <select id="evVenue">
                    <option value="">Loading venues...</option>
                </select>
                <a href="#/dashboard" id="manageVenuesLink" style="display: none; margin-top: 0.5rem;">Manage Venues</a>
            </div>
            
            <label for="evMapsLink">Google Maps Link (Optional)</label>
            <input 
                id="evMapsLink" 
                type="url" 
                placeholder="https://maps.app.goo.gl/..."
            >
        </div>

        <div class="form-section" id="visibilityContainer" style="display: none;">
            <h3>Settings</h3>
            <label>Visibility*</label>
            <div class="radio-group">
                <label class="radio-label">
                    <input type="radio" name="visibility" value="public" checked>
                    Public (Visible to everyone)
                </label>
                <label class="radio-label">
                    <input type="radio" name="visibility" value="private">
                    Private (Only visible to you)
                </label>
            </div>
        </div>
        
        <button type="submit" id="createBtn">Create Event</button>
    </form>
    
    <div id="createMessage" style="display: none; margin-top: 1rem;"></div>
</div>

<script type="module">
import { api } from "../js/api.js";
import { getRoleFromToken } from "../js/app.js";

const form = document.getElementById("createEventForm");
const messageDiv = document.getElementById("createMessage");
const token = localStorage.getItem("token");
const userRole = getRoleFromToken();

// --- Form Elements ---
const venueSelectContainer = document.getElementById("venueSelectContainer");
const customLocationContainer = document.getElementById("customLocationContainer");
const venueSelect = document.getElementById("evVenue");
const customLocationInput = document.getElementById("evCustomLocation");
const locationTypeRadios = document.querySelectorAll('input[name="location_type"]');
const visibilityContainer = document.getElementById("visibilityContainer");
const manageVenuesLink = document.getElementById("manageVenuesLink");

// --- Role-Based UI ---
if (userRole === 'admin' || userRole === 'organizer') {
    visibilityContainer.style.display = 'block'; // Show visibility options
    manageVenuesLink.style.display = 'block'; // Show manage venues link
} else {
    visibilityContainer.style.display = 'none'; // Hide for attendees
    manageVenuesLink.style.display = 'none';
}

// --- Location Toggle Logic ---
function handleLocationTypeChange() {
    if (this.value === 'venue') {
        venueSelectContainer.style.display = 'block';
        customLocationContainer.style.display = 'none';
        venueSelect.required = true;
        customLocationInput.required = false;
    } else {
        venueSelectContainer.style.display = 'none';
        customLocationContainer.style.display = 'block';
        venueSelect.required = false;
        customLocationInput.required = true;
    }
}
locationTypeRadios.forEach(radio => radio.addEventListener('change', handleLocationTypeChange));

// --- Load Venues into Dropdown ---
async function loadVenues() {
    try {
        const venues = await api("/venues/", "GET", null, token);
        if (venues && venues.length > 0) {
            venueSelect.innerHTML = '<option value="">-- Select a venue --</option>';
            venues.forEach(venue => {
                const option = document.createElement('option');
                option.value = venue.venue_id;
                option.textContent = `${venue.name} ${venue.building ? `(${venue.building}${venue.room_number ? `, ${venue.room_number}` : ''})` : ''}`;
                venueSelect.appendChild(option);
            });
        } else {
            venueSelect.innerHTML = '<option value="">No on-campus venues found</option>';
        }
    } catch (error) {
        console.error("Failed to load venues:", error);
        venueSelect.innerHTML = '<option value="">Error loading venues</option>';
    }
}

// --- Initial Page Load ---
handleLocationTypeChange.call(document.querySelector('input[name="location_type"]:checked'));
loadVenues();

// --- Form Submission ---
form.addEventListener("submit", async (e) => {
    e.preventDefault();
    
    const createBtn = document.getElementById("createBtn");
    messageDiv.style.display = "none";
    
    // --- Get All Values ---
    const title = document.getElementById("evTitle").value;
    const description = document.getElementById("evDescription").value;
    const start = document.getElementById("evStart").value;
    const end = document.getElementById("evEnd").value;
    
    const location_type = document.querySelector('input[name="location_type"]:checked').value;
    const venue_id = venueSelect.value;
    const custom_location_address = customLocationInput.value;
    const google_maps_link = document.getElementById("evMapsLink").value;
    
    // Set visibility based on role
    let visibility = 'private'; // Default to private for attendees
    if (userRole === 'admin' || userRole === 'organizer') {
        visibility = document.querySelector('input[name="visibility"]:checked').value;
    }

    // --- Validation ---
    if (new Date(start) >= new Date(end)) {
        messageDiv.className = "error-message";
        messageDiv.textContent = "End time must be after start time";
        messageDiv.style.display = "block";
        return;
    }

    const mapRegex = /^(https?:\/\/)?(www\.)?(google\.com\/maps|maps\.app\.goo\.gl)/;
    if (google_maps_link && !mapRegex.test(google_maps_link)) {
        messageDiv.className = "error-message";
        messageDiv.textContent = "Please enter a valid Google Maps link (e.g., google.com/maps/...).";
        messageDiv.style.display = "block";
        return;
    }
    
    // Build payload
    const payload = {
        title,
        description,
        start_time: start, 
        end_time: end,     
        location_type,
        google_maps_link,
        visibility,
        venue_id: location_type === 'venue' ? venue_id : null,
        custom_location_address: location_type === 'custom' ? custom_location_address : null,
    };

    // Disable button
    createBtn.disabled = true;
    createBtn.textContent = "Creating...";
    
    try {
        const res = await api("/events/", "POST", payload, token);
        
        if (res.error) {
            messageDiv.className = "error-message";
            messageDiv.textContent = res.error || "Failed to create event";
            messageDiv.style.display = "block";
            
            createBtn.disabled = false;
            createBtn.textContent = "Create Event";
        } else {
            messageDiv.className = "success-message";
            messageDiv.textContent = "Event created successfully! Redirecting...";
            messageDiv.style.display = "block";
            
            setTimeout(() => {
                window.location.hash = "#/calendar"; // Redirect to calendar
            }, 1500);
        }
    } catch (error) {
        messageDiv.className = "error-message";
        messageDiv.textContent = "Network error. Please try again.";
        messageDiv.style.display = "block";
        
        createBtn.disabled = false;
        createBtn.textContent = "Create Event";
    }
});
</script>
