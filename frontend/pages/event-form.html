<link rel="stylesheet" href="css/main.css">
<style>
    /* --- Layout Wrapper (New) --- */
    .form-container-wrapper {
        display: flex;
        gap: 2rem;
        max-width: 1200px;
        margin: 0 auto;
        align-items: flex-start;
    }

    /* --- AI Sidebar Styles (Ported) --- */
    .wizard-sidebar {
        flex: 2;
        min-width: 300px;
        max-width: 380px;
        position: sticky;
        top: 2rem;
    }

    /* --- AI Helper Sidebar --- */
    .ai-helper-card {
        background: var(--bg-primary, #ffffff);
        border: 1px solid var(--border-color, #e0e0e0);
        box-shadow: var(--shadow-sm, 0 1px 2px rgba(0, 0, 0, 0.05));
        border-radius: var(--radius-lg, 12px);
        padding: 1.25rem;
        display: flex;
        flex-direction: column;
        position: sticky;
        top: 2rem;
        height: calc(100vh - 4rem);
        transition: all 0.3s ease;
    }

    .ai-helper-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid var(--border-color, #e0e0e0);
        flex-shrink: 0;
    }

    .ai-helper-header h3 {
        font-size: 1.25rem;
        margin: 0;
        background: var(--gradient-primary, linear-gradient(135deg, #007bff, #0056b3));
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
    }

    .ai-helper-messages {
        flex-grow: 1;
        overflow-y: auto;
        overflow-x: hidden;
        padding-right: 0.5rem;
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .ai-helper-msg {
        display: flex;
        align-items: flex-end;
        max-width: 100%;
    }

    .ai-helper-msg.user {
        flex-direction: row-reverse;
    }

    .ai-helper-avatar {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        font-size: 0.8rem;
    }

    .ai-helper-msg.ai .ai-helper-avatar,
    .ai-helper-msg.is-loading .ai-helper-avatar {
        background: var(--gradient-primary, linear-gradient(135deg, #007bff, #0056b3));
        color: white;
        margin-right: 0.5rem;
    }

    .ai-helper-msg.user .ai-helper-avatar {
        background: var(--bg-tertiary, #e5e7eb);
        color: var(--text-primary, #374151);
        margin-left: 0.5rem;
    }

    .ai-helper-bubble {
        padding: 0.75rem 1rem;
        border-radius: 12px;
        font-size: 0.9rem;
        line-height: 1.5;
        width: fit-content;
        max-width: 85%;
        word-break: break-word;
        overflow-wrap: anywhere;
    }

    .ai-helper-msg.ai .ai-helper-bubble,
    .ai-helper-msg.is-loading .ai-helper-bubble {
        background: var(--bg-tertiary, #f3f4f6);
        color: var(--text-primary, #1f2937);
        border-bottom-left-radius: 2px;
    }

    .ai-helper-msg.user .ai-helper-bubble {
        background: var(--gradient-primary, #007bff);
        color: white;
        border-bottom-right-radius: 2px;
    }

    .ai-helper-msg.is-loading .ai-helper-bubble {
        font-style: italic;
        color: var(--text-light, #6b7280);
    }

    .ai-suggestion-action {
        display: block;
        margin-top: 0.75rem;
        padding: 0.5rem 0.75rem;
        background: white;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        color: var(--primary-color, #007bff);
        font-size: 0.85rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        text-align: left;
        width: 100%;
    }

    .ai-suggestion-action:hover {
        background: #f9fafb;
        border-color: var(--primary-color, #007bff);
    }

    .ai-helper-form {
        flex-shrink: 0;
        margin-top: 1rem;
    }

/* --- Updated Copilot UI (Matches Wizard) --- */
.ai-helper-input-wrapper {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    background: var(--bg-tertiary, #f3f4f6);
    border: 1px solid var(--border-color, #e5e7eb);
    border-radius: 24px; /* Creates the pill shape */
    padding: 0.25rem 0.5rem 0.25rem 1rem;
    transition: border-color 0.2s;
}

.ai-helper-input-wrapper:focus-within {
    border-color: var(--primary-color, #007bff);
    background: white;
}

.ai-helper-input-wrapper input {
    flex-grow: 1;
    border: none !important; /* Removes default box border */
    background: transparent !important;
    font-size: 0.9rem;
    padding: 0.6rem 0;
    box-shadow: none !important;
}

.ai-helper-input-wrapper input:focus {
    outline: none;
}

.ai-helper-input-wrapper button {
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    width: 36px;
    height: 36px;
    background: var(--gradient-primary, #007bff);
    color: white;
    border: none;
    border-radius: 50%; /* Circular button */
    cursor: pointer;
    transition: transform 0.2s;
    padding: 0;
}

.ai-helper-input-wrapper button:hover {
    transform: scale(1.05);
}

    .ai-helper-input-wrapper button:disabled {
        background: var(--text-light, #ccc);
        transform: none;
    }

    /* --- Existing Form Styles --- */
    .form-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }

    .form-section {
        margin-bottom: 1.5rem;
        padding-bottom: 1.5rem;
        border-bottom: 1px solid var(--border-color, #e0e0e0);
    }

    .form-section:last-child {
        border-bottom: none;
        margin-bottom: 0;
        padding-bottom: 0;
    }

    .form-section h3 {
        font-size: 1.125rem; /* 18px */
        color: var(--text-secondary, #555);
        margin-bottom: 1rem;
    }

    .back-link {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 1.5rem;
        color: var(--primary-color, #007bff);
        text-decoration: none;
        font-weight: 500;
    }

    .back-link:hover {
        text-decoration: underline;
    }

    label {
        display: block;
        margin-bottom: 0.5rem;
        color: var(--text-secondary, #555);
        font-size: 0.875rem; /* 14px */
        font-weight: 500;
    }

    input[type="text"],
    input[type="url"],
    input[type="date"],
    textarea,
    select {
        width: 100%;
        padding-top: 0.75rem;
        padding-bottom: 0.75rem;
        padding-left: 0.75rem;
        padding-right: 0.75rem;
        box-sizing: border-box;
        border: 2px solid var(--border-color, #e0e0e0);
        border-radius: var(--radius-md, 8px);
        font-size: 1rem;
    }

    input:focus,
    textarea:focus,
    select:focus {
        outline: none;
        border-color: var(--primary-color, #007bff);
        background-color: var(--bg-primary, #fff);
    }

    textarea {
        resize: vertical;
    }

    /* --- NEW Date Time Styling --- */
    .date-time-group {
        display: flex;
        gap: 1.5rem;
        flex-wrap: wrap;
    }

    .dt-pair {
        flex: 1;
        min-width: 250px;
    }

    .dt-inputs {
        display: flex;
        gap: 0.5rem;
    }

    .date-input-wrapper {
        flex: 3;
    }

    /* Custom Time Picker Styles */
    .time-picker-wrapper {
        position: relative;
        flex: 2;
        min-width: 110px;
    }

    .time-picker-wrapper input {
        cursor: text;
    }

    .time-options-dropdown {
        position: absolute;
        top: calc(100% + 4px);
        left: 0;
        width: 100%;
        max-height: 250px;
        overflow-y: auto;
        background: white;
        border: 1px solid var(--border-color, #e0e0e0);
        border-radius: var(--radius-md, 8px);
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        z-index: 100;
        display: none;
        padding: 0;
        margin: 0;
        list-style: none;
    }

    .time-options-dropdown.show {
        display: block;
    }

    .time-options-dropdown li {
        padding: 0.75rem 1rem;
        cursor: pointer;
        font-size: 0.95rem;
        color: var(--text-primary, #333);
        border-bottom: 1px solid #f3f4f6;
    }

    .time-options-dropdown li:last-child {
        border-bottom: none;
    }

    .time-options-dropdown li:hover,
    .time-options-dropdown li.highlighted {
        background-color: var(--bg-tertiary, #f0f7ff);
        color: var(--primary-color, #007bff);
    }

    /* --- End Date Time Styling --- */

    .radio-group {
        display: flex;
        gap: 1rem;
        margin-bottom: 1rem;
    }

    .radio-label {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.75rem 1rem;
        border: 2px solid var(--border-color, #e0e0e0);
        border-radius: var(--radius-md, 8px);
        cursor: pointer;
        transition: all 0.2s ease-in-out;
        flex: 1;
    }

    .radio-label input[type="radio"] {
        display: none;
    }

    .radio-label:has(input:checked) {
        background: var(--bg-tertiary, #f0f7ff);
        border-color: var(--primary-color, #007bff);
    }

    #venueSelectContainer {
        display: none;
    }

    .form-section a {
        font-size: 0.875rem;
        color: var(--primary-color, #007bff);
        text-decoration: none;
        display: inline-block;
        margin-top: 0.5rem;
    }

    .form-section a:hover {
        text-decoration: underline;
    }

    .ai-draft-applied {
        padding: 1rem;
        background: #e6f3ff;
        border: 1px solid #b3d4ff;
        color: #00529B;
        border-radius: var(--radius-md, 8px);
        margin-bottom: 1.5rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .form-actions {
        display: flex;
        gap: 1rem;
        align-items: center;
        margin-top: 1.5rem;
    }

    .form-actions button {
        padding: 0.75rem 1.5rem;
        border-radius: var(--radius-md, 8px);
        font-weight: 600;
        cursor: pointer;
        border: none;
    }

    #saveBtn {
        background: var(--primary-color, #007bff);
        color: white;
        flex: 2;
    }

    /* Responsive Logic */
    @media (max-width: 900px) {
        .form-container-wrapper {
            flex-direction: column;
        }

        .wizard-sidebar {
            max-width: 100%;
            position: static;
            width: 100%;
        }

        .ai-helper-card {
            padding: 1rem;
            height: auto;
            max-height: 500px;
        }

        .ai-helper-header {
            cursor: pointer;
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }

        .ai-toggle-icon {
            display: block;
            transform: rotate(0deg);
            transition: transform 0.3s;
        }

        /* Mobile Toggle States */
        .ai-helper-card.collapsed .ai-helper-messages,
        .ai-helper-card.collapsed .ai-helper-form {
            display: none;
        }

        .ai-helper-card.expanded .ai-helper-header {
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .ai-helper-card.expanded .ai-toggle-icon {
            transform: rotate(180deg);
        }
    }
</style>

<div class="page-transition-enter-active">

    <!-- Wrapper for Sidebar Layout -->
    <div class="form-container-wrapper">

        <!-- MAIN FORM -->
        <div class="create-event-form">
            <!-- Back Navigation -->
            <a href="#/create-event" class="back-link" id="backLink">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"
                    stroke-linecap="round" stroke-linejoin="round">
                    <path d="M15 18l-6-6 6-6" />
                </svg>
                <span>Back to options</span>
            </a>

            <div class="form-header">
                <h2 id="pageTitle">New Event Details</h2>
            </div>

            <div id="aiDraftMessage" style="display: none;"></div>
            <div id="topErrorMessage" class="error-message" style="display: none; margin-bottom: 1rem;"></div>

            <form id="eventForm">

                <!-- Basic Info Section -->
                <div class="form-section">
                    <label for="evTitle">Event Title*</label>
                    <input id="evTitle" type="text" placeholder="e.g. Spring Hackathon" required>

                    <div style="margin-top: 1rem;">
                        <label for="evDescription">Description</label>
                    </div>
                    <textarea id="evDescription" placeholder="Tell attendees about your event..." rows="5"></textarea>
                </div>

                <!-- Date & Time Section (OVERHAULED) -->
                <div class="form-section">
                    <h3>Date & Time*</h3>
                    <div class="date-time-group">
                        
                        <!-- Start Pair -->
                        <div class="dt-pair">
                            <label>Start</label>
                            <div class="dt-inputs">
                                <div class="date-input-wrapper">
                                    <input id="evStartDate" type="date" required>
                                </div>
                                <div class="time-picker-wrapper">
                                    <input type="text" id="evStartTime" placeholder="Time" autocomplete="off" required>
                                    <ul class="time-options-dropdown" id="evStartTimeList"></ul>
                                </div>
                            </div>
                        </div>

                        <!-- End Pair -->
                        <div class="dt-pair">
                            <label>End</label>
                            <div class="dt-inputs">
                                <div class="date-input-wrapper">
                                    <input id="evEndDate" type="date" required>
                                </div>
                                <div class="time-picker-wrapper">
                                    <input type="text" id="evEndTime" placeholder="Time" autocomplete="off" required>
                                    <ul class="time-options-dropdown" id="evEndTimeList"></ul>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>

                <!-- Location Section -->
                <div class="form-section">
                    <h3>Location</h3>
                    <div class="radio-group">
                        <label class="radio-label">
                            <input type="radio" name="location_type" value="custom" checked>
                            Custom Address
                        </label>
                        <label class="radio-label">
                            <input type="radio" name="location_type" value="venue">
                            On-Campus Venue
                        </label>
                    </div>

                    <div id="customLocationContainer">
                        <label for="evCustomLocation">Custom Address</label>
                        <input id="evCustomLocation" type="text" placeholder="e.g. 123 Main St, Marion, IN">
                    </div>

                    <div id="venueSelectContainer">
                        <label for="evVenue">Select a Venue</label>
                        <select id="evVenue">
                            <option value="">Loading venues...</option>
                        </select>
                    </div>

                    <label for="evMapsLink">Google Maps Link (Optional)</label>
                    <input id="evMapsLink" type="url" placeholder="https://maps.app.goo.gl/...">
                </div>

                <!-- Settings Section -->
                <div class="form-section" id="visibilityContainer" style="display: none;">
                    <h3>Settings</h3>
                    <label>Visibility*</label>
                    <div class="radio-group">
                        <label class="radio-label">
                            <input type="radio" name="visibility" value="public" checked>
                            Public (Visible to everyone)
                        </label>
                        <label class="radio-label">
                            <input type="radio" name="visibility" value="private">
                            Private (Only visible to you)
                        </label>
                    </div>
                </div>

                <!-- Actions -->
                <div class="form-actions">
                    <button type="submit" id="saveBtn">Create Event</button>
                </div>
            </form>

            <div id="formMessage" style="display: none; margin-top: 1rem;"></div>
        </div>

        <!-- AI SIDEBAR -->
        <aside class="wizard-sidebar">
            <div class="ai-helper-card" id="aiHelperCard">
                <div class="ai-helper-header" onclick="toggleMobileAI()">
                    <h3>AI Co-Pilot</h3>
                    <div class="ai-toggle-icon">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="M6 9l6 6 6-6" />
                        </svg>
                    </div>
                </div>
                <div class="ai-helper-messages" id="ai-helper-messages">
                    <div class="ai-helper-msg ai">
                        <div class="ai-helper-avatar">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 2L10 9L3 11L10 13L12 20L14 13L21 11L14 9L12 2Z" />
                            </svg>
                        </div>
                        <div class="ai-helper-bubble">
                            <p>I'm here to help! Need a catchy title or help refining the description? Just ask.</p>
                        </div>
                    </div>
                </div>
                <form class="ai-helper-form" id="ai-helper-form">
                    <div class="ai-helper-input-wrapper">
                        <input type="text" id="ai-helper-input" placeholder="Ask for suggestions..."
                            aria-label="AI Assistant Input">
                        <button type="submit" id="ai-helper-send" aria-label="Send">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M2 3L22 12L2 21L5 13L15 12L5 11L2 3Z" />
                            </svg>
                        </button>
                    </div>
                </form>
            </div>
        </aside>
    </div>
</div>

<!-- Marked.js for Markdown Parsing -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<script type="module">
    import { api } from "../js/api.js";
    import { getRoleFromToken } from "../js/app.js";

    // --- State & elements ---
    const form = document.getElementById("eventForm");
    const messageDiv = document.getElementById("formMessage");
    const topErrorDiv = document.getElementById("topErrorMessage");
    const saveBtn = document.getElementById("saveBtn");
    const token = localStorage.getItem("token");
    const userRole = getRoleFromToken();

    // Fields
    const evTitle = document.getElementById("evTitle");
    const evDescription = document.getElementById("evDescription");
    
    // Date & Time Fields (Split)
    const evStartDate = document.getElementById("evStartDate");
    const evStartTime = document.getElementById("evStartTime");
    const evEndDate = document.getElementById("evEndDate");
    const evEndTime = document.getElementById("evEndTime");

    const evCustomLocation = document.getElementById("evCustomLocation");
    const evMapsLink = document.getElementById("evMapsLink");
    const venueSelect = document.getElementById("evVenue");
    const venueSelectContainer = document.getElementById("venueSelectContainer");
    const customLocationContainer = document.getElementById("customLocationContainer");
    const locationTypeRadios = document.querySelectorAll('input[name="location_type"]');
    const visibilityContainer = document.getElementById("visibilityContainer");

    // Detect Edit Mode
    const hashParts = window.location.hash.split('?');
    const params = new URLSearchParams(hashParts[1]);
    const eventId = params.get('id');
    const isEditMode = !!eventId;

    let allVenues = [];

    // --- Time Picker Logic ---

    // Generate time slots (15 min increments)
    function generateTimeSlots() {
        const slots = [];
        const periods = ['AM', 'PM'];
        for (let i = 0; i < 24 * 4; i++) { // 15 min chunks
            const totalMinutes = i * 15;
            const hours24 = Math.floor(totalMinutes / 60);
            const minutes = totalMinutes % 60;
            const period = hours24 >= 12 ? 'PM' : 'AM';
            let hours12 = hours24 % 12;
            if (hours12 === 0) hours12 = 12;
            
            const timeString = `${hours12}:${minutes.toString().padStart(2, '0')} ${period}`;
            slots.push({ display: timeString, value24: `${hours24.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}` });
        }
        return slots;
    }

    const timeSlots = generateTimeSlots();

    function setupTimePicker(inputId, listId) {
        const input = document.getElementById(inputId);
        const list = document.getElementById(listId);

        // Populate list
        function renderList(filter = '') {
            list.innerHTML = '';
            const normalizedFilter = filter.toLowerCase().replace(/\s/g, ''); // e.g. "500pm" -> "500pm"
            
            const filtered = timeSlots.filter(slot => {
                const searchStr = slot.display.toLowerCase().replace(/\s/g, '');
                return searchStr.startsWith(normalizedFilter) || slot.display.toLowerCase().includes(filter.toLowerCase());
            });

            if (filtered.length === 0) {
                 // Allow free typing, but maybe show "No standard time found" or just empty
                 return;
            }

            filtered.forEach(slot => {
                const li = document.createElement('li');
                li.textContent = slot.display;
                li.addEventListener('mousedown', (e) => {
                    e.preventDefault(); // Prevent blur
                    input.value = slot.display;
                    list.classList.remove('show');
                });
                list.appendChild(li);
            });
        }

        input.addEventListener('focus', () => {
            renderList();
            list.classList.add('show');
        });

        input.addEventListener('input', (e) => {
            renderList(e.target.value);
            list.classList.add('show');
        });

        // Blur: Try to parse loose input (e.g., "5" -> "5:00 PM", "13" -> "1:00 PM")
        input.addEventListener('blur', () => {
            setTimeout(() => list.classList.remove('show'), 150);
            
            let val = input.value.trim();
            if(!val) return;

            // Simple parser logic
            // 1. Check if it matches existing slot
            const exactMatch = timeSlots.find(s => s.display.toLowerCase() === val.toLowerCase());
            if (exactMatch) {
                input.value = exactMatch.display;
                return;
            }

            // 2. Try to parse logic like "5p", "17", "530"
            // Regex for 1-2 digits, optional minutes, optional am/pm
            const match = val.match(/^(\d{1,2})(?::?(\d{2}))?\s*([ap]m?)?$/i);
            if (match) {
                let h = parseInt(match[1]);
                let m = match[2] ? parseInt(match[2]) : 0;
                let mer = match[3] ? match[3].toLowerCase() : null;

                if (h > 24) return; // Invalid
                if (m > 59) return; // Invalid

                // Guess AM/PM if missing
                if (!mer) {
                    if (h === 12) mer = 'pm'; // 12 -> 12pm
                    else if (h < 7) mer = 'pm'; // 1-6 -> 1pm-6pm (heuristic)
                    else if (h >= 7 && h <= 11) mer = 'am'; // 7-11 -> 7am-11am
                    // 13+ is 24hr, no meridiem needed
                }

                if (mer && (mer.startsWith('p')) && h < 12) h += 12;
                if (mer && (mer.startsWith('a')) && h === 12) h = 0;

                // Format back to display
                const hours24 = h;
                const minutes = m;
                const period = hours24 >= 12 && hours24 < 24 ? 'PM' : 'AM'; // simplistic
                
                let hours12 = hours24 % 12;
                if (hours12 === 0) hours12 = 12;
                if (hours24 > 23) hours12 = 12; // Handle 24 edge case loosely

                input.value = `${hours12}:${minutes.toString().padStart(2, '0')} ${period}`;
            }
        });

        // Keyboard navigation
        input.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                const first = list.querySelector('li');
                if (first) {
                    // In a real app, we'd manage active index. For now, simple.
                    // input.value = first.textContent; 
                }
            }
        });
    }

    setupTimePicker('evStartTime', 'evStartTimeList');
    setupTimePicker('evEndTime', 'evEndTimeList');

    // Helper to get ISO string from Date + Time inputs
    function getISOFromInputs(dateInput, timeInput) {
        if (!dateInput.value || !timeInput.value) return null;
        
        // Parse time input value (Expected "hh:mm AM/PM") back to 24h
        const timeStr = timeInput.value;
        const match = timeStr.match(/(\d{1,2}):(\d{2})\s*(AM|PM)/i);
        
        let h = 0, m = 0;
        if (match) {
            h = parseInt(match[1]);
            m = parseInt(match[2]);
            const mer = match[3].toUpperCase();
            if (mer === 'PM' && h < 12) h += 12;
            if (mer === 'AM' && h === 12) h = 0;
        } else {
            // Fallback for direct 24h input if regex fails
             // (Though blur handler tries to force format)
             return new Date(`${dateInput.value}T00:00`).toISOString();
        }

        const d = new Date(`${dateInput.value}T${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:00`);
        return d.toISOString();
    }

    // Helper to set inputs from ISO string
    function setInputsFromISO(isoString, dateEl, timeEl) {
        if (!isoString) return;
        const d = new Date(isoString);
        
        // Date: YYYY-MM-DD
        const year = d.getFullYear();
        const month = String(d.getMonth() + 1).padStart(2, '0');
        const day = String(d.getDate()).padStart(2, '0');
        dateEl.value = `${year}-${month}-${day}`;

        // Time: hh:mm AM/PM
        let h = d.getHours();
        const m = d.getMinutes();
        const mer = h >= 12 ? 'PM' : 'AM';
        let h12 = h % 12;
        if (h12 === 0) h12 = 12;
        
        timeEl.value = `${h12}:${m.toString().padStart(2, '0')} ${mer}`;
    }


    // --- Initialization Logic ---

    async function init() {
        // Role UI setup
        if (userRole === 'admin' || userRole === 'organizer') {
            visibilityContainer.style.display = 'block';
        } else {
            visibilityContainer.style.display = 'none';
            // Force private for regular users
            const privateRadio = document.querySelector('input[name="visibility"][value="private"]');
            if (privateRadio) privateRadio.checked = true;
        }

        // Load venues first
        await loadVenues();

        // Setup Logic based on Mode
        if (isEditMode) {
            setupEditMode();
        } else {
            setupCreateMode(); // Also handles draft application
        }

        // Initialize Location Logic
        handleLocationTypeChange();

        // Initialize Mobile Logic (if on mobile)
        if (window.innerWidth <= 900) {
            document.getElementById('aiHelperCard').classList.add('collapsed');
        }
    }

    // --- Create vs Edit Setup ---

    // Create Mode Setup
    function setupCreateMode() {
        document.getElementById("pageTitle").textContent = "New Event Details";
        saveBtn.textContent = "Create Event";
        applyAIDraft(); // ONLY apply drafts in create mode
    }

    // Edit Mode Setup
    async function setupEditMode() {
        document.getElementById("pageTitle").textContent = "Edit Event";
        saveBtn.textContent = "Update Event";

        const backLink = document.getElementById("backLink");
        backLink.href = "#/calendar";
        backLink.querySelector("span").textContent = "Back to Calendar";

        // Load existing event details
        try {
            const event = await api(`/events/${eventId}`, "GET", null, token);
            if (event.error) {
                showTopError(event.error);
                return;
            }
            
            // Populate form fields
            evTitle.value = event.title || "";
            evDescription.value = event.description || "";
            evMapsLink.value = event.google_maps_link || "";

            // Set Split Date/Time
            setInputsFromISO(event.start_time, evStartDate, evStartTime);
            setInputsFromISO(event.end_time, evEndDate, evEndTime);

            // Location
            if (event.location_type === 'venue') {
                document.querySelector(`input[name="location_type"][value="venue"]`).checked = true;
                if (venueSelect.options.length > 1) {
                    venueSelect.value = event.venue_id;
                }
            } else {
                document.querySelector(`input[name="location_type"][value="custom"]`).checked = true;
                evCustomLocation.value = event.custom_location_address || "";
            }

            // Visibility
            if (event.visibility) {
                const visRadio = document.querySelector(`input[name="visibility"][value="${event.visibility}"]`);
                if (visRadio) visRadio.checked = true;
            }

            handleLocationTypeChange();

        } catch (err) {
            console.error(err);
            showTopError("Failed to load event details.");
        }
    }

    // --- Helper Functions ---

    // Show top error and disable form
    function showTopError(msg) {
        topErrorDiv.textContent = msg;
        topErrorDiv.style.display = 'block';
        form.style.opacity = '0.5';
        form.style.pointerEvents = 'none';
    }

    // Show form message
    function showMessage(msg, typeClass) {
        messageDiv.className = typeClass;
        messageDiv.textContent = msg;
        messageDiv.style.display = "block";
    }

    // Load venues into the select dropdown
    async function loadVenues() {
        try {
            const venues = await api("/venues/", "GET", null, token);
            allVenues = venues || []; // Store globally for map link lookup

            // Populate select
            if (venues && venues.length > 0) {
                venueSelect.innerHTML = '<option value="">-- Select a venue --</option>';
                venues.forEach(venue => {
                    const option = document.createElement('option');
                    option.value = venue.venue_id;
                    option.textContent = `${venue.name} ${venue.building ? `(${venue.building}${venue.room_number ? `, ${venue.room_number}` : ''})` : ''}`;
                    venueSelect.appendChild(option);
                });
            } else {
                venueSelect.innerHTML = '<option value="">No on-campus venues found</option>';
            }
        } catch (error) {
            console.error("Failed to load venues:", error);
        }
    }

    // Autofill maps link on venue select
    venueSelect.addEventListener('change', () => {
        const selectedId = venueSelect.value;
        if (selectedId && allVenues.length > 0) {
            const venue = allVenues.find(v => v.venue_id == selectedId);
            if (venue) {
                if (venue.google_maps_link) {
                    // Only autofill if the Maps input is empty
                    if (!evMapsLink.value) {
                        evMapsLink.value = venue.google_maps_link;
                        // Subtle visual cue (background color change)
                        evMapsLink.style.transition = "background-color 0.3s";
                        evMapsLink.style.backgroundColor = "#e6f3ff";
                        setTimeout(() => evMapsLink.style.backgroundColor = "", 1000);
                    }
                } else {
                    // If no Google Maps link is available, set it to an empty string
                    evMapsLink.value = "";
                }
            }
        }
    });

    // Clear autofilled maps link if user edits it
    evMapsLink.addEventListener('input', () => {
        if (!evMapsLink.value) {
            // If the Google Maps link input is empty, remove the autofilled link.
            evMapsLink.value = ""; // Make sure the value is cleared.
            venueSelect.value = ""; // Clear the venue selection (could remove).
        }
    });

    // Handle location type change
    function handleLocationTypeChange() {
        const type = document.querySelector('input[name="location_type"]:checked').value;
        if (type === 'venue') { // on-campus venue
            venueSelectContainer.style.display = 'block';
            customLocationContainer.style.display = 'none';
        } else { // custom
            venueSelectContainer.style.display = 'none';
            customLocationContainer.style.display = 'block';
        }
    }

    // Attach event listeners to location type radios
    locationTypeRadios.forEach(radio => radio.addEventListener('change', handleLocationTypeChange));

    // --- Main AI Draft Logic ---
    function applyAIDraft() {
        const draftString = localStorage.getItem('aiEventDraft');

        if (!draftString) return;
        try {
            const draft = JSON.parse(draftString);
            if (draft.title) evTitle.value = draft.title;
            if (draft.description) evDescription.value = draft.description;
            if (draft.location) {
                evCustomLocation.value = draft.location;
                document.querySelector('input[name="location_type"][value="custom"]').checked = true;
                handleLocationTypeChange();
            }
            // Draft usually has ISO strings, so use our helper
            if (draft.start_time) setInputsFromISO(draft.start_time, evStartDate, evStartTime);
            if (draft.end_time) setInputsFromISO(draft.end_time, evEndDate, evEndTime);

            const aiDraftMessage = document.getElementById("aiDraftMessage");
            aiDraftMessage.innerHTML = `<div class="ai-draft-applied"><span>âœ¨ AI Draft applied! Review details and save.</span></div>`;
            aiDraftMessage.style.display = 'block';
        } catch (e) { console.error(e); }
        localStorage.removeItem('aiEventDraft');
    }

    // --- Sidebar AI Co-Pilot Logic ---

    // Mobile Toggle
    window.toggleMobileAI = () => {
        const card = document.getElementById('aiHelperCard');
        if (card.classList.contains('expanded')) {
            card.classList.remove('expanded');
            card.classList.add('collapsed');
        } else {
            card.classList.remove('collapsed');
            card.classList.add('expanded');
        }
    };

    // AI Chat Logic
    const aiForm = document.getElementById('ai-helper-form');
    const aiInput = document.getElementById('ai-helper-input');
    const aiSendBtn = document.getElementById('ai-helper-send');
    const aiMessages = document.getElementById('ai-helper-messages');

    // --- History State ---
    const MAX_HISTORY = 10;
    let chatHistory = [];

    // Get current form values to send as context
    function getFormValuesForAI() {
        return {
            evTitle: evTitle.value,
            evDescription: evDescription.value,
            // Reconstruct pseudo-ISO for AI context
            evStart: getISOFromInputs(evStartDate, evStartTime) || "",
            evEnd: getISOFromInputs(evEndDate, evEndTime) || "",
            location_type: document.querySelector('input[name="location_type"]:checked')?.value,
            evVenue: venueSelect.value,
            evCustomLocation: evCustomLocation.value,
            visibility: document.querySelector('input[name="visibility"]:checked')?.value
        };
    }

    // Handle AI form submission
    aiForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const prompt = aiInput.value.trim();
        if (!prompt) return;

        aiInput.value = '';
        aiInput.disabled = true;
        aiSendBtn.disabled = true;

        chatHistory.push({ role: "user", content: prompt }); // Add user message to history

        addHelperMessage('user', prompt);
        const loadingMsg = addHelperMessage('is-loading', 'Thinking...');

        // Send to backend
        try {
            const payload = {
                prompt,
                context: "Standard Event Form - Editing Details", // Context for backend
                user_time: new Date().toISOString(),
                current_values: getFormValuesForAI(),
                history: chatHistory.slice(-MAX_HISTORY) // Send History
            };
            const result = await api('/ai/wizard-helper', 'POST', payload, token);
            loadingMsg.remove();

            if (result.response) {
                // Add response to history
                chatHistory.push({ role: "ai", content: result.response });
                addHelperMessage('ai', result.response, result.actions);
            } else {
                addHelperMessage('ai', `Error: ${result.error || 'No response'}`);
            }
        } catch (err) {
            loadingMsg.remove();
            addHelperMessage('ai', 'Error connecting to AI helper.');
        } finally {
            aiInput.disabled = false;
            aiSendBtn.disabled = false;
            aiInput.focus();
        }
    });

    // Add message to AI chat
    function addHelperMessage(sender, text, actions = null) {
        // Friendly labels for Standard Form IDs
        const FIELD_LABELS = {
            "evTitle": "Title",
            "evDescription": "Description",
            "evStart": "Start Time",
            "evEnd": "End Time",
            "location_type": "Location Type",
            "evVenue": "Venue",
            "evCustomLocation": "Custom Address",
            "visibility": "Visibility",
            "evMapsLink": "Maps Link"
        };

        const msg = document.createElement('div');
        msg.className = `ai-helper-msg ${sender === 'is-loading' ? 'ai is-loading' : sender}`;

        const avatar = document.createElement('div');
        avatar.className = 'ai-helper-avatar';

        // Avatar Logic
        if (sender === 'ai' || sender === 'is-loading') {
            avatar.innerHTML = `<svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2L10 9L3 11L10 13L12 20L14 13L21 11L14 9L12 2Z"/></svg>`;
        } else {
            avatar.innerHTML = `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>`;
        }

        const bubble = document.createElement('div');
        bubble.className = 'ai-helper-bubble';

        if (sender === 'is-loading') {
            bubble.innerHTML = `<span class="loading-dots">...</span>`;
        } else {
            bubble.innerHTML = window.marked ? window.marked.parse(text) : text;

            // Add Action Buttons
            if (actions && Array.isArray(actions) && actions.length > 0) {
                actions.forEach(action => {
                    const btn = document.createElement('button');
                    btn.className = 'ai-suggestion-action';

                    let friendlyLabel = FIELD_LABELS[action.field];
                    // Fallback for naming
                    if (!friendlyLabel) {
                        // Try to convert ID to Readable
                        friendlyLabel = action.field
                            .replace(/^ev/, "")
                            .replace(/([A-Z])/g, " $1")
                            .trim();
                    }

                    // Truncate long values for button text
                    const displayValue = (action.value && action.value.length > 40)
                        ? action.value.substring(0, 38) + "..."
                        : (action.value || "");

                    btn.innerHTML = `<strong>Update ${friendlyLabel}</strong> "${displayValue}"`;
                    btn.onclick = () => applyAIAction(action.field, action.value, btn);
                    bubble.appendChild(btn);
                });
            }
        }

        msg.appendChild(avatar);
        msg.appendChild(bubble);
        aiMessages.appendChild(msg);
        aiMessages.scrollTop = aiMessages.scrollHeight;

        return msg;
    }

    // Apply AI Suggested Action to Form
    function applyAIAction(fieldId, value, btnElement) {
        // Map wizard IDs (which the AI might suggest if confused) to Standard Form IDs
        const ID_MAP = {
            'w-title': 'evTitle',
            'w-description': 'evDescription',
            'w-start': 'evStart', // Map to composite start
            'w-end': 'evEnd',     // Map to composite end
            'w-location_type': 'location_type', // Radio name
            'w-venue': 'evVenue',
            'w-customLocation': 'evCustomLocation',
            'w-mapsLink': 'evMapsLink',
            'w-visibility': 'visibility' // Radio name
        };

        const targetId = ID_MAP[fieldId] || fieldId;
        let fieldChanged = false;

        // Special handling for Date/Time Split
        if (targetId === 'evStart') {
            setInputsFromISO(value, evStartDate, evStartTime);
            fieldChanged = true;
        }
        else if (targetId === 'evEnd') {
            setInputsFromISO(value, evEndDate, evEndTime);
            fieldChanged = true;
        }
        // Handle Radios (Name based)
        else if (targetId === 'location_type' || targetId === 'visibility') {
            const radio = document.querySelector(`input[name="${targetId}"][value="${value}"]`);
            if (radio) {
                radio.checked = true;
                fieldChanged = true;
                if (targetId === 'location_type') handleLocationTypeChange();
            }
        }
        // Handle Standard Inputs
        else {
            const field = document.getElementById(targetId);
            if (field) {
                field.value = value;
                field.style.transition = "background-color 0.3s";
                field.style.backgroundColor = "#e6f3ff";
                setTimeout(() => { field.style.backgroundColor = ""; }, 1000);
                fieldChanged = true;
            }
        }

        // Update button state
        if (fieldChanged) {
            btnElement.innerHTML = `<strong>Updated!</strong>`;
            btnElement.style.background = "#d4edda";
            btnElement.style.color = "#155724";
            btnElement.style.borderColor = "#c3e6cb";
            btnElement.disabled = true;
            btnElement.style.cursor = "default";
        }
    }

    // --- Submit Handler ---

    // Handle form submission
    form.addEventListener("submit", async (e) => {
        e.preventDefault();
        messageDiv.style.display = "none";
        messageDiv.className = "";

        const title = evTitle.value;
        const location_type = document.querySelector('input[name="location_type"]:checked').value;

        // Construct ISO strings
        const startISO = getISOFromInputs(evStartDate, evStartTime);
        const endISO = getISOFromInputs(evEndDate, evEndTime);

        // Validation
        if (!title || !startISO || !endISO) {
            showMessage("Title, Start Time, and End Time are required.", "error-message");
            return;
        }
        if (new Date(startISO) >= new Date(endISO)) {
            showMessage("End time must be after start time.", "error-message");
            return;
        }
        const venueId = (location_type === 'venue' && venueSelect.value) ? venueSelect.value : null;
        const customAddress = (location_type === 'custom' && evCustomLocation.value) ? evCustomLocation.value : null;

        if (location_type === 'venue' && !venueId) {
            showMessage("Please select an on-campus venue.", "error-message");
            return;
        }
        if (location_type === 'custom' && !customAddress) {
            showMessage("Please enter a custom address.", "error-message");
            return;
        }

        // Get Visibility
        let visibility = 'private';
        const visInput = document.querySelector('input[name="visibility"]:checked');
        if (visInput) visibility = visInput.value;

        const payload = {
            title,
            description: evDescription.value,
            start_time: startISO,
            end_time: endISO,
            location_type,
            google_maps_link: evMapsLink.value || null,
            visibility: visibility,
            venue_id: venueId,
            custom_location_address: customAddress,
        };

        saveBtn.disabled = true;
        saveBtn.textContent = isEditMode ? "Updating..." : "Creating...";

        // API Call
        try {
            let res;
            if (isEditMode) {
                res = await api(`/events/${eventId}`, "PUT", payload, token);
            } else {
                res = await api("/events/", "POST", payload, token);
            }

            if (res.error) {
                throw new Error(res.error);
            } else {
                showMessage(isEditMode ? "Event updated! Redirecting..." : "Event created! Redirecting...", "success-message");
                setTimeout(() => { window.location.hash = "#/calendar"; }, 1500);
            }
        } catch (error) {
            console.error("Submit error:", error);
            showMessage(error.message || "A network error occurred.", "error-message");
            saveBtn.disabled = false;
            saveBtn.textContent = isEditMode ? "Update Event" : "Create Event";
        }
    });

    // Start
    init();

</script>