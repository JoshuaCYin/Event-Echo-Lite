<!-- Landing Calendar Page -->
<link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/main.min.css' rel='stylesheet' />
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js'></script>

<style>
  .landing-calendar-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 90px 2rem 2rem 2rem;
  }

  .calendar-header {
    text-align: center;
    margin-bottom: 2rem;
  }

  .calendar-header h1 {
    font-size: 2.5rem;
    background: var(--gradient-primary);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin-bottom: 0.5rem;
  }

  .calendar-header p {
    color: var(--text-secondary);
    font-size: 1.125rem;
  }

  .calendar-wrapper {
    background: var(--bg-primary);
    border-radius: var(--radius-lg);
    padding: 2rem;
    box-shadow: var(--shadow-md);
  }

  /* Force calendar event text to be white */
  .fc-event-title, .fc-event-time,
  .fc-list-event-title, .fc-list-event-time {
    color: #ffffff !important;
  }

  @media (max-width: 768px) {
    .landing-calendar-container {
      padding: 80px 1rem 1rem 1rem;
    }

    .calendar-header h1 {
      font-size: 2rem;
    }

    .calendar-wrapper {
      padding: 1rem;
    }
  }
</style>

<div class="landing-calendar-container">
  <div class="calendar-header">
    <h1>Event Calendar</h1>
    <p>View all upcoming events at a glance</p>
  </div>

  <div class="calendar-wrapper">
    <div id="calendar"></div>
  </div>
</div>

<script type="module">
import { api } from "../js/api.js";

/**
 * Use a unique variable name to avoid conflicts with main app calendars.
 */
const calendarEl = document.getElementById("calendar");
let landingCalendar = null;

/**
 * Normalize any datetime string to ISO 8601.
 * Handles:
 * - "YYYY-MM-DD HH:MM:SS"
 * - ISO strings with or without 'Z'
 * - Date objects
 */
function normalizeDateTime(dt) {
  if (!dt) return null;
  const d = new Date(dt);
  return isNaN(d.getTime()) ? null : d.toISOString();
}

async function loadCalendarView() {
  try {
    // Public landing view does not require token
    const events = await api("/events/", "GET", null, null);

    if (!Array.isArray(events)) {
      console.error("API did not return an array:", events);
      calendarEl.innerHTML = '<div class="error-message">Failed to load calendar. Invalid data received.</div>';
      return;
    }

    // Prepare events for FullCalendar
    const fcEvents = events
      .map(e => ({
        title: e.title,
        start: normalizeDateTime(e.start_time),
        end: normalizeDateTime(e.end_time),
        extendedProps: {
          location: e.location_type === 'custom' ? e.custom_location_address : e.venue_name || '',
          description: e.description || ''
        }
      }))
      // Filter out events with invalid start times
      .filter(e => e.start !== null);

    // Initialize FullCalendar
    landingCalendar = new FullCalendar.Calendar(calendarEl, {
      initialView: "dayGridMonth",
      headerToolbar: {
        left: 'prev,next today',
        center: 'title',
        right: 'dayGridMonth,timeGridWeek,timeGridDay,listWeek'
      },
      buttonText: {
        today: 'Today', month: 'Month', week: 'Week', day: 'Day', list: 'List'
      },
      height: 'auto',
      aspectRatio: 1.8,
      events: fcEvents,
      eventClick: function(info) {
        info.jsEvent.preventDefault();
        alert(
          'Event: ' + info.event.title + '\n' +
          'Location: ' + (info.event.extendedProps.location || 'N/A') + '\n' +
          'Start: ' + info.event.start.toLocaleString()
        );
      },
      eventMouseEnter: function(info) {
        info.el.style.opacity = '0.8';
        info.el.style.cursor = 'pointer';
      },
      eventMouseLeave: function(info) {
        info.el.style.opacity = '1';
      }
    });

    // Render calendar
    landingCalendar.render();

  } catch (error) {
    console.error("Failed to load calendar:", error);
    calendarEl.innerHTML = '<div class="error-message">Failed to load calendar. Please try again.</div>';
  }
}

// Load calendar on page load
loadCalendarView();
</script>
